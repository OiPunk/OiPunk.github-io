<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="消息队列，中间件，ActiveMQ," />










<meta name="description" content="玩转ActiveMQ，看这一篇就够了！">
<meta property="og:type" content="article">
<meta property="og:title" content="ActiveMQ详解">
<meta property="og:url" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/index.html">
<meta property="og:site_name" content="For tomorrow!!!">
<meta property="og:description" content="玩转ActiveMQ，看这一篇就够了！">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200110192535698.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200110192613518.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/activemq_logo_white_vertical.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/copycode.gif">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200207162242385.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/Startup.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/MasterFailed.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212193653842.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212144259602.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/10190bfe-30d7-3021-8bbe-9d7882530083.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212165236443.png">
<meta property="og:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212165658958.png">
<meta property="article:published_time" content="2020-07-12T11:49:12.000Z">
<meta property="article:modified_time" content="2020-08-12T12:00:17.550Z">
<meta property="article:author" content="CodingPunk">
<meta property="article:tag" content="消息队列，中间件，ActiveMQ">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200110192535698.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '作者'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/07/12/ActiveMQ详解/"/>





  <title>ActiveMQ详解 | For tomorrow!!!</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    
    <a href="https://github.com/OiPunk" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>    
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">For tomorrow!!!</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Without an umbrella,                  I can only RUSH!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            日志
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="CodingPunk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/oi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="For tomorrow!!!">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">ActiveMQ详解</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-07-12T19:49:12+08:00">
                2020-07-12
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          
              <div class="post-description">
                  玩转ActiveMQ，看这一篇就够了！
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="1-详细介绍"><a href="#1-详细介绍" class="headerlink" title="1. 详细介绍"></a>1. 详细介绍</h1><h2 id="什么是JMS-MQ"><a href="#什么是JMS-MQ" class="headerlink" title="什么是JMS MQ"></a>什么是JMS MQ</h2><p>全称：Java MessageService 中文：Java 消息服务。 </p>
<p>JMS 是 Java 的一套 API 标准，最初的目的是为了使应用程序能够访问现有的 MOM 系 统（MOM 是 MessageOriented Middleware 的英文缩写，指的是利用高效可靠的消息传递机 制进行平台无关的数据交流，并基于数据通信来进行分布式系统的集成。） ；</p>
<p>后来被许多现有 的 MOM 供应商采用，并实现为 MOM 系统。【常见 MOM 系统包括 Apache 的 ActiveMQ、 阿里巴巴的 RocketMQ、IBM 的 MQSeries、Microsoft 的 MSMQ、BEA 的 RabbitMQ 等。 （并 非全部的 MOM 系统都遵循 JMS 规范）】 </p>
<p>基于 JMS 实现的 MOM，又被称为 JMSProvider。</p>
<p>“消息”是在两台计算机间传送的数据单位。消息可以非常简单，例如只包含文本字符串； 也可以更复杂，可能包含嵌入对象。 消息被发送到队列中。</p>
<p>“消息队列”是在消息的传输过程中保存消息的容器。消息队列管 理器在将消息从它的源中继到它的目标时充当中间人。</p>
<p>队列的主要目的是提供路由并保证消 息的传递；如果发送消息时接收者不可用，消息队列会保留消息，直到可以成功地传递它。</p>
<p>消息队列的主要特点是异步处理，主要目的是减少请求响应时间和解耦。所以主要的使 用场景就是将比较耗时而且不需要即时（同步）返回结果的操作作为消息放入消息队列。同 时由于使用了消息队列，只要保证消息格式不变，消息的发送方和接收方并不需要彼此联系， 也不需要受对方的影响，即解耦和。如: 跨系统的异步通信，所有需要异步交互的地方都可以使用消息队列。就像我们除了打电 话（同步）以外，还需要发短信，发电子邮件（异步）的通讯方式。 多个应用之间的耦合，由于消息是平台无关和语言无关的，而且语义上也不再是函数调 用，因此更适合作为多个应用之间的松耦合的接口。基于消息队列的耦合，不需要发送方和 接收方同时在线。 在企业应用集成（EAI）中，文件传输，共享数据库，消息队列，远程过程调用都可以 作为集成的方法。 应用内的同步变异步，比如订单处理，就可以由前端应用将订单信息放到队列，后端应 用从队列里依次获得消息处理，高峰时的大量订单可以积压在队列里慢慢处理掉。由于同步 通常意味着阻塞，而大量线程的阻塞会降低计算机的性能。 消息驱动的架构（EDA），系统分解为消息队列，和消息制造者和消息消费者，一个处 理流程可以根据需要拆成多个阶段（Stage） ，阶段之间用队列连接起来，前一个阶段处理的 结果放入队列，后一个阶段从队列中获取消息继续处理。 应用需要更灵活的耦合方式，如发布订阅，比如可以指定路由规则。 跨局域网，甚至跨城市的通讯，比如北京机房与广州机房的应用程序的通信。</p>
<h2 id="消息中间件应用场景"><a href="#消息中间件应用场景" class="headerlink" title="消息中间件应用场景"></a>消息中间件应用场景</h2><h3 id="异步通信"><a href="#异步通信" class="headerlink" title="异步通信"></a><strong>异步通信</strong></h3><p>有些业务不想也不需要立即处理消息。消息队列提供了异步处理机制，允许用户把一个消息放入队列，但并不立即处理它。想向队列中放入多少消息就放多少，然后在需要的时候再去处理它们。</p>
<h3 id="缓冲"><a href="#缓冲" class="headerlink" title="缓冲"></a><strong>缓冲</strong></h3><p>在任何重要的系统中，都会有需要不同的处理时间的元素。消息队列通过一个缓冲层来帮助任务最高效率的执行，该缓冲有助于控制和优化数据流经过系统的速度。以调节系统响应时间。</p>
<h3 id="解耦"><a href="#解耦" class="headerlink" title="解耦"></a><strong>解耦</strong></h3><p>降低工程间的强依赖程度，针对异构系统进行适配。在项目启动之初来预测将来项目会碰到什么需求，是极其困难的。通过消息系统在处理过程中间插入了一个隐含的、基于数据的接口层，两边的处理过程都要实现这一接口，当应用发生变化时，可以独立的扩展或修改两边的处理过程，只要确保它们遵守同样的接口约束。</p>
<h3 id="冗余"><a href="#冗余" class="headerlink" title="冗余"></a><strong>冗余</strong></h3><p>有些情况下，处理数据的过程会失败。除非数据被持久化，否则将造成丢失。消息队列把数据进行持久化直到它们已经被完全处理，通过这一方式规避了数据丢失风险。许多消息队列所采用的”插入-获取-删除”范式中，在把一个消息从队列中删除之前，需要你的处理系统明确的指出该消息已经被处理完毕，从而确保你的数据被安全的保存直到你使用完毕。</p>
<h3 id="扩展性"><a href="#扩展性" class="headerlink" title="扩展性"></a><strong>扩展性</strong></h3><p>因为消息队列解耦了你的处理过程，所以增大消息入队和处理的频率是很容易的，只要另外增加处理过程即可。不需要改变代码、不需要调节参数。便于分布式扩容。</p>
<h3 id="可恢复性"><a href="#可恢复性" class="headerlink" title="可恢复性"></a><strong>可恢复性</strong></h3><p>系统的一部分组件失效时，不会影响到整个系统。消息队列降低了进程间的耦合度，所以即使一个处理消息的进程挂掉，加入队列中的消息仍然可以在系统恢复后被处理。</p>
<h3 id="顺序保证"><a href="#顺序保证" class="headerlink" title="顺序保证"></a><strong>顺序保证</strong></h3><p>在大多使用场景下，数据处理的顺序都很重要。大部分消息队列本来就是排序的，并且能保证数据会按照特定的顺序来处理。</p>
<h3 id="过载保护"><a href="#过载保护" class="headerlink" title="过载保护"></a><strong>过载保护</strong></h3><p>在访问量剧增的情况下，应用仍然需要继续发挥作用，但是这样的突发流量无法提取预知；如果以为了能处理这类瞬间峰值访问为标准来投入资源随时待命无疑是巨大的浪费。使用消息队列能够使关键组件顶住突发的访问压力，而不会因为突发的超负荷的请求而完全崩溃。</p>
<h3 id="数据流处理"><a href="#数据流处理" class="headerlink" title="数据流处理"></a><strong>数据流处理</strong></h3><p>分布式系统产生的海量数据流，如：业务日志、监控数据、用户行为等，针对这些数据流进行实时或批量采集汇总，然后进行大数据分析是当前互联网的必备技术，通过消息队列完成此类数据收集是最好的选择。</p>
<h2 id="常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较"><a href="#常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较" class="headerlink" title="常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较"></a>常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较</h2><table>
<thead>
<tr>
<th>特性MQ</th>
<th>ActiveMQ</th>
<th>RabbitMQ</th>
<th>RocketMQ</th>
<th>Kafka</th>
</tr>
</thead>
<tbody><tr>
<td>生产者消费者模式</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>发布订阅模式</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
<td>支持</td>
</tr>
<tr>
<td>请求回应模式</td>
<td>支持</td>
<td>支持</td>
<td>不支持</td>
<td>不支持</td>
</tr>
<tr>
<td>Api完备性</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>多语言支持</td>
<td>支持</td>
<td>支持</td>
<td>java</td>
<td>支持</td>
</tr>
<tr>
<td>单机吞吐量</td>
<td>万级</td>
<td>万级</td>
<td>万级</td>
<td>十万级</td>
</tr>
<tr>
<td>消息延迟</td>
<td>无</td>
<td>微秒级</td>
<td>毫秒级</td>
<td>毫秒级</td>
</tr>
<tr>
<td>可用性</td>
<td>高（主从）</td>
<td>高（主从）</td>
<td>非常高（分布式）</td>
<td>非常高（分布式）</td>
</tr>
<tr>
<td>消息丢失</td>
<td>低</td>
<td>低</td>
<td>理论上不会丢失</td>
<td>理论上不会丢失</td>
</tr>
<tr>
<td>文档的完备性</td>
<td>高</td>
<td>高</td>
<td>高</td>
<td>高</td>
</tr>
<tr>
<td>提供快速入门</td>
<td>有</td>
<td>有</td>
<td>有</td>
<td>有</td>
</tr>
<tr>
<td>社区活跃度</td>
<td>高</td>
<td>高</td>
<td>有</td>
<td>高</td>
</tr>
<tr>
<td>商业支持</td>
<td>无</td>
<td>无</td>
<td>商业云</td>
<td>商业云</td>
</tr>
</tbody></table>
<h2 id="JMS中的一些角色"><a href="#JMS中的一些角色" class="headerlink" title="JMS中的一些角色"></a>JMS中的一些角色</h2><h3 id="Broker"><a href="#Broker" class="headerlink" title="Broker"></a><strong>Broker</strong></h3><p>消息服务器，作为server提供消息核心服务</p>
<h3 id="provider"><a href="#provider" class="headerlink" title="provider"></a>provider</h3><p>生产者</p>
<p>消息生产者是由会话创建的一个对象，用于把消息发送到一个目的地。</p>
<h3 id="Consumer"><a href="#Consumer" class="headerlink" title="Consumer"></a>Consumer</h3><p>消费者</p>
<p>消息消费者是由会话创建的一个对象，它用于接收发送到目的地的消息。消息的消费可以采用以下两种方法之一：</p>
<ul>
<li>同步消费。通过调用消费者的receive方法从目的地中显式提取消息。receive方法可以一直阻塞到消息到达。</li>
<li>异步消费。客户可以为消费者注册一个消息监听器，以定义在消息到达时所采取的动作。</li>
</ul>
<h3 id="p2p"><a href="#p2p" class="headerlink" title="p2p"></a>p2p</h3><p>基于点对点的消息模型</p>
<p>消息生产者生产消息发送到 queue 中，然后消息消费者从 queue 中取出并且消费消息。 消息被消费以后，queue 中不再有存储，所以消息消费者不可能消费到已经被消费的消<br>息。<br>Queue 支持存在多个消费者，但是对一个消息而言，只会有一个消费者可以消费、其它 的则不能消费此消息了。 当消费者不存在时，消息会一直保存，直到有消费消费</p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200110192535698.png" alt="image-20200110192535698"></p>
<h3 id="pub-sub"><a href="#pub-sub" class="headerlink" title="pub/sub"></a>pub/sub</h3><p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200110192613518.png" alt="image-20200110192613518"></p>
<p>基于订阅/发布的消息模型</p>
<p>消息生产者（发布）将消息发布到 topic 中，同时有多个消息消费者（订阅）消费该消<br>息。<br>和点对点方式不同，发布到 topic 的消息会被所有订阅者消费。 当生产者发布消息，不管是否有消费者。都不会保存消息 一定要先有消息的消费者，后有消息的生产者。</p>
<h3 id="PTP-和-PUB-SUB-简单对"><a href="#PTP-和-PUB-SUB-简单对" class="headerlink" title="PTP 和 PUB/SUB 简单对"></a>PTP 和 PUB/SUB 简单对</h3><table>
<thead>
<tr>
<th>1</th>
<th>Topic</th>
<th>Queue</th>
</tr>
</thead>
<tbody><tr>
<td></td>
<td>Publish Subscribe messaging 发布 订阅消息</td>
<td>Point-to-Point 点对点</td>
</tr>
<tr>
<td>有无状态</td>
<td>topic 数据默认不落地，是无状态的。</td>
<td>Queue 数据默认会在 mq 服 务器上以文件形式保存，比如 Active MQ 一 般 保 存 在 $AMQ_HOME\data\kahadb 下 面。也可以配置成 DB 存储。</td>
</tr>
<tr>
<td>完整性保障</td>
<td>并不保证 publisher 发布的每条数 据，Subscriber 都能接受到。</td>
<td>Queue 保证每条数据都能 被 receiver 接收。消息不超时。</td>
</tr>
<tr>
<td>消息是否会丢失</td>
<td>一般来说 publisher 发布消息到某 一个 topic 时，只有正在监听该 topic 地址的 sub 能够接收到消息；如果没 有 sub 在监听，该 topic 就丢失了。</td>
<td>Sender 发 送 消 息 到 目 标 Queue， receiver 可以异步接收这 个 Queue 上的消息。Queue 上的 消息如果暂时没有 receiver 来 取，也不会丢失。前提是消息不 超时。</td>
</tr>
<tr>
<td>消息发布接 收策略</td>
<td>一对多的消息发布接收策略，监 听同一个topic地址的多个sub都能收 到 publisher 发送的消息。Sub 接收完 通知 mq 服务器</td>
<td>一对一的消息发布接收策 略，一个 sender 发送的消息，只 能有一个 receiver 接收。 receiver 接收完后，通知 mq 服务器已接 收，mq 服务器对 queue 里的消 息采取删除或其他操作。</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<h3 id="Queue"><a href="#Queue" class="headerlink" title="Queue"></a>Queue</h3><p>队列存储，常用与点对点消息模型 </p>
<p>默认只能由唯一的一个消费者处理。一旦处理消息删除。 </p>
<h3 id="Topic"><a href="#Topic" class="headerlink" title="Topic"></a>Topic</h3><p>主题存储，用于订阅/发布消息模型</p>
<p>主题中的消息，会发送给所有的消费者同时处理。只有在消息可以重复处 理的业务场景中可使用。</p>
<p>Queue/Topic都是 Destination 的子接口</p>
<h3 id="ConnectionFactory"><a href="#ConnectionFactory" class="headerlink" title="ConnectionFactory"></a>ConnectionFactory</h3><p>连接工厂，jms中用它创建连接</p>
<p>连接工厂是客户用来创建连接的对象，例如ActiveMQ提供的ActiveMQConnectionFactory。</p>
<h3 id="Connection"><a href="#Connection" class="headerlink" title="Connection"></a>Connection</h3><p>JMS Connection封装了客户与JMS提供者之间的一个虚拟的连接。  </p>
<h3 id="Destination"><a href="#Destination" class="headerlink" title="Destination"></a>Destination</h3><p>消息的目的地</p>
<p>目的地是客户用来指定它生产的消息的目标和它消费的消息的来源的对象。JMS1.0.2规范中定义了两种消息传递域：点对点（PTP）消息传递域和发布/订阅消息传递域。 点对点消息传递域的特点如下：</p>
<ul>
<li>每个消息只能有一个消费者。</li>
<li>消息的生产者和消费者之间没有时间上的相关性。无论消费者在生产者发送消息的时候是否处于运行状态，它都可以提取消息。</li>
</ul>
<p>发布/订阅消息传递域的特点如下：</p>
<ul>
<li>每个消息可以有多个消费者。</li>
<li>生产者和消费者之间有时间上的相关性。</li>
<li>订阅一个主题的消费者只能消费自它订阅之后发布的消息。JMS规范允许客户创建持久订阅，这在一定程度上放松了时间上的相关性要求 。持久订阅允许消费者消费它在未处于激活状态时发送的消息。<br>在点对点消息传递域中，目的地被成为队列（queue）；在发布/订阅消息传递域中，目的地被成为主题（topic）。</li>
</ul>
<h3 id="Session"><a href="#Session" class="headerlink" title="Session"></a>Session</h3><p>JMS Session是生产和消费消息的一个单线程上下文。会话用于创建消息生产者（producer）、消息消费者（consumer）和消息（message）等。会话提供了一个事务性的上下文，在这个上下文中，一组发送和接收被组合到了一个原子操作中。</p>
<h2 id="JMS的消息格式"><a href="#JMS的消息格式" class="headerlink" title="JMS的消息格式"></a>JMS的消息格式</h2><h3 id="JMS消息由以下三部分组成的："><a href="#JMS消息由以下三部分组成的：" class="headerlink" title="JMS消息由以下三部分组成的："></a>JMS消息由以下三部分组成的：</h3><ul>
<li><p>消息头。</p>
<p>每个消息头字段都有相应的getter和setter方法。</p>
</li>
<li><p>消息属性。</p>
<p>如果需要除消息头字段以外的值，那么可以使用消息属性。</p>
</li>
<li><p>消息体。</p>
<p>JMS定义的消息类型有TextMessage、MapMessage、BytesMessage、StreamMessage和ObjectMessage。</p>
</li>
</ul>
<h3 id="TextMessage"><a href="#TextMessage" class="headerlink" title="TextMessage"></a>TextMessage</h3><p>文本消息</p>
<h3 id="MapMessage"><a href="#MapMessage" class="headerlink" title="MapMessage"></a>MapMessage</h3><p>k/v</p>
<h3 id="BytesMessage"><a href="#BytesMessage" class="headerlink" title="BytesMessage"></a>BytesMessage</h3><p>字节流</p>
<h3 id="StreamMessage"><a href="#StreamMessage" class="headerlink" title="StreamMessage"></a>StreamMessage</h3><p>java原始的数据流</p>
<h3 id="ObjectMessage"><a href="#ObjectMessage" class="headerlink" title="ObjectMessage"></a>ObjectMessage</h3><p>序列化的java对象</p>
<h2 id="消息可靠性机制"><a href="#消息可靠性机制" class="headerlink" title="消息可靠性机制"></a>消息可靠性机制</h2><h3 id="确认-JMS消息"><a href="#确认-JMS消息" class="headerlink" title="确认 JMS消息"></a>确认 JMS消息</h3><p>只有在被确认之后，才认为已经被成功地消费了。</p>
<p>消息的成功消费通常包含三个阶段：客户接收消息、客户处理消息和消息被确认。 </p>
<p>在事务性会话中，当一个事务被提交的时候，确认自动发生。</p>
<p>在非事务性会话中，消息何时被确认取决于创建会话时的应答模式（acknowledgement mode）。该参数有以下三个可选值：</p>
<ul>
<li>Session.AUTO_ACKNOWLEDGE。当客户成功的从receive方法返回的时候，或者从MessageListener.onMessage方法成功返回的时候，会话自动确认客户收到的消息。</li>
<li>Session.CLIENT_ACKNOWLEDGE。客户通过消息的acknowledge方法确认消息。需要注意的是，在这种模式中，确认是在会话层上进行：确认一个被消费的消息将自动确认所有已被会话消费的消息。例如，如果一个消息消费者消费了10个消息，然后确认第5个消息，那么所有10个消息都被确认。</li>
<li>Session.DUPS_ACKNOWLEDGE。该选择只是会话迟钝的确认消息的提交。如果JMS Provider失败，那么可能会导致一些重复的消息。如果是重复的消息，那么JMS Provider必须把消息头的JMSRedelivered字段设置为true。</li>
</ul>
<h3 id="持久性"><a href="#持久性" class="headerlink" title="持久性"></a>持久性</h3><p>JMS 支持以下两种消息提交模式：</p>
<ul>
<li>PERSISTENT。指示JMS Provider持久保存消息，以保证消息不会因为JMS Provider的失败而丢失。</li>
<li>NON_PERSISTENT。不要求JMS Provider持久保存消息。</li>
</ul>
<h3 id="优先级"><a href="#优先级" class="headerlink" title="优先级"></a>优先级</h3><p>可以使用消息优先级来指示JMS Provider首先提交紧急的消息。优先级分10个级别，从0（最低）到9（最高）。如果不指定优先级，默认级别是4。需要注意的是，JMS Provider并不一定保证按照优先级的顺序提交消息。</p>
<h3 id="消息过期"><a href="#消息过期" class="headerlink" title="消息过期"></a>消息过期</h3><p>可以设置消息在一定时间后过期，默认是永不过期。</p>
<h3 id="临时目的地"><a href="#临时目的地" class="headerlink" title="临时目的地"></a>临时目的地</h3><p>可以通过会话上的createTemporaryQueue方法和createTemporaryTopic方法来创建临时目的地。它们的存在时间只限于创建它们的连接所保持的时间。只有创建该临时目的地的连接上的消息消费者才能够从临时目的地中提取消息。</p>
<h3 id="持久订阅"><a href="#持久订阅" class="headerlink" title="持久订阅"></a>持久订阅</h3><p>首先消息生产者必须使用PERSISTENT提交消息。客户可以通过会话上的createDurableSubscriber方法来创建一个持久订阅，该方法的第一个参数必须是一个topic，第二个参数是订阅的名称。 JMS Provider会存储发布到持久订阅对应的topic上的消息。如果最初创建持久订阅的客户或者任何其它客户使用相同的连接工厂和连接的客户ID、相同的主题和相同的订阅名再次调用会话上的createDurableSubscriber方法，那么该持久订阅就会被激活。JMS Provider会象客户发送客户处于非激活状态时所发布的消息。 持久订阅在某个时刻只能有一个激活的订阅者。持久订阅在创建之后会一直保留，直到应用程序调用会话上的unsubscribe方法。</p>
<h3 id="本地事务"><a href="#本地事务" class="headerlink" title="本地事务"></a>本地事务</h3><p>在一个JMS客户端，可以使用本地事务来组合消息的发送和接收。JMS Session接口提供了commit和rollback方法。事务提交意味着生产的所有消息被发送，消费的所有消息被确认；事务回滚意味着生产的所有消息被销毁，消费的所有消息被恢复并重新提交，除非它们已经过期。 事务性的会话总是牵涉到事务处理中，commit或rollback方法一旦被调用，一个事务就结束了，而另一个事务被开始。关闭事务性会话将回滚其中的事务。 需要注意的是，如果使用请求/回复机制，即发送一个消息，同时希望在同一个事务中等待接收该消息的回复，那么程序将被挂起，因为知道事务提交，发送操作才会真正执行。 需要注意的还有一个，消息的生产和消费不能包含在同一个事务中。</p>
<h2 id="ActiveMQ"><a href="#ActiveMQ" class="headerlink" title="ActiveMQ"></a>ActiveMQ</h2><p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/activemq_logo_white_vertical.png" alt="img"></p>
<p>官方网站</p>
<p><a href="http://activemq.apache.org/" target="_blank" rel="noopener">http://activemq.apache.org/</a></p>
<h2 id="Broker-1"><a href="#Broker-1" class="headerlink" title="Broker"></a>Broker</h2><p>ActiveMQ 5.0 的二进制发布包中bin目录中包含一个名为activemq的脚本，直接运行这个脚本就可以启动一个broker。 此外也可以通过Broker Configuration URI或Broker XBean URI对broker进行配置，以下是一些命令行参数的例子：</p>
<table>
<thead>
<tr>
<th>Example</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>activemq</td>
<td>Runs a broker using the default  ‘xbean:activemq.xml’ as the broker configuration file.</td>
</tr>
<tr>
<td>activemq xbean:myconfig.xml</td>
<td>Runs a broker using the file myconfig.xml as the  broker configuration file that is located in the classpath.</td>
</tr>
<tr>
<td>activemq xbean:file:./conf/broker1.xml</td>
<td>Runs a broker using the file broker1.xml as the  broker configuration file that is located in the relative file path  ./conf/broker1.xml</td>
</tr>
<tr>
<td>activemq xbean:file:C:/ActiveMQ/conf/broker2.xml</td>
<td>Runs a broker using the file broker2.xml as the  broker configuration file that is located in the absolute file path  C:/ActiveMQ/conf/broker2.xml</td>
</tr>
<tr>
<td>activemq broker:(tcp://localhost:61616,  tcp://localhost:5000)?useJmx=true</td>
<td>Runs a broker with two transport connectors and  JMX enabled.</td>
</tr>
<tr>
<td>activemq broker:(tcp://localhost:61616,  network:tcp://localhost:5000)?persistent=false</td>
<td>Runs a broker with 1 transport connector and 1  network connector with persistence disabled.</td>
</tr>
</tbody></table>
<h2 id="存储"><a href="#存储" class="headerlink" title="存储"></a>存储</h2><h3 id="KahaDB存储"><a href="#KahaDB存储" class="headerlink" title="KahaDB存储"></a>KahaDB存储</h3><p>KahaDB是默认的持久化策略，所有消息顺序添加到一个日志文件中，同时另外有一个索引文件记录指向这些日志的存储地址，还有一个事务日志用于消息回复操作。是一个专门针对消息持久化的解决方案,它对典型的消息使用模式进行了优化。</p>
<p>在data/kahadb这个目录下，会生成四个文件，来完成消息持久化<br>1.db.data 它是消息的索引文件，本质上是B-Tree（B树），使用B-Tree作为索引指向db-*.log里面存储的消息<br>2.db.redo 用来进行消息恢复 *</p>
<p>3.db-.log 存储消息内容。新的数据以APPEND的方式追加到日志文件末尾。属于顺序写入，因此消息存储是比较 快的。默认是32M，达到阀值会自动递增<br>4.lock文件 锁，写入当前获得kahadb读写权限的broker ，用于在集群环境下的竞争处理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt; &lt;!--directory:保存数据的目录;journalMaxFileLength:保存消息的文件大小 --&gt; &lt;kahaDBdirectory&#x3D;&quot;$&#123;activemq.data&#125;&#x2F;kahadb&quot;journalMaxFileLength&#x3D;&quot;16mb&quot;&#x2F;&gt; &lt;&#x2F;persistenceAdapter&gt;</span><br></pre></td></tr></table></figure>

<p>特性：</p>
<p>1、日志形式存储消息；</p>
<p>2、消息索引以 B-Tree 结构存储，可以快速更新；</p>
<p>3、 完全支持 JMS 事务；</p>
<p>4、支持多种恢复机制kahadb 可以限制每个数据文件的大小。不代表总计数据容量。 </p>
<h3 id="AMQ-方式"><a href="#AMQ-方式" class="headerlink" title="AMQ 方式"></a>AMQ 方式</h3><p>只适用于 5.3 版本之前。 AMQ 也是一个文件型数据库，消息信息最终是存储在文件中。内存中也会有缓存数据。 </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;persistenceAdapter&gt; &lt;!--directory:保存数据的目录 ;maxFileLength:保存消息的文件大小 --&gt; &lt;amqPersistenceAdapterdirectory&#x3D;&quot;$&#123;activemq.data&#125;&#x2F;amq&quot;maxFileLength&#x3D;&quot;32mb&quot;&#x2F;&gt; &lt;&#x2F;persistenceAdapter&gt;</span><br></pre></td></tr></table></figure>







<p> 性能高于 JDBC，写入消息时，会将消息写入日志文件，由于是顺序追加写，性能很高。</p>
<p> 为了提升性能，创建消息主键索引，并且提供缓存机制，进一步提升性能。</p>
<p>每个日志文件的 大小都是有限制的（默认 32m，可自行配置） 。 </p>
<p>当超过这个大小，系统会重新建立一个文件。</p>
<p>当所有的消息都消费完成，系统会删除这 个文件或者归档。 </p>
<p>主要的缺点是 AMQ Message 会为每一个 Destination 创建一个索引，如果使用了大量的 Queue，索引文件的大小会占用很多磁盘空间。 </p>
<p>而且由于索引巨大，一旦 Broker（ActiveMQ 应用实例）崩溃，重建索引的速度会非常 慢。 </p>
<p>虽然 AMQ 性能略高于 Kaha DB 方式，但是由于其重建索引时间过长，而且索引文件 占用磁盘空间过大，所以已经不推荐使用。</p>
<h3 id="JDBC存储"><a href="#JDBC存储" class="headerlink" title="JDBC存储"></a>JDBC存储</h3><p>使用JDBC持久化方式，数据库默认会创建3个表，每个表的作用如下：<br>activemq_msgs：queue和topic的消息都存在这个表中<br>activemq_acks：存储持久订阅的信息和最后一个持久订阅接收的消息ID<br>activemq_lock：跟kahadb的lock文件类似，确保数据库在某一时刻只有一个broker在访问</p>
<p>ActiveMQ 将数据持久化到数据库中。 </p>
<p>不指定具体的数据库。 可以使用任意的数据库 中。 </p>
<p>本环节中使用 MySQL 数据库。 下述文件为 activemq.xml 配置文件部分内容。 </p>
<p> 首先定义一个 mysql-ds 的 MySQL 数据源，然后在 persistenceAdapter 节点中配置 jdbcPersistenceAdapter 并且引用刚才定义的数据源。</p>
<p>dataSource 指定持久化数据库的 bean，createTablesOnStartup 是否在启动的时候创建数 据表，默认值是 true，这样每次启动都会去创建数据表了，一般是第一次启动的时候设置为 true，之后改成 false。 </p>
<p><strong>Beans中添加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean id&#x3D;&quot;mysql-ds&quot; class&#x3D;&quot;org.apache.commons.dbcp.BasicDataSource&quot; destroy-method&#x3D;&quot;close&quot;&gt; </span><br><span class="line"></span><br><span class="line">&lt;property name&#x3D;&quot;driverClassName&quot; value&#x3D;&quot;com.mysql.jdbc.Driver&quot;&#x2F;&gt; </span><br><span class="line">&lt;property name&#x3D;&quot;url&quot; value&#x3D;&quot;jdbc:mysql:&#x2F;&#x2F;localhost&#x2F;activemq?relaxAutoCommit&#x3D;true&quot;&#x2F;&gt; </span><br><span class="line">&lt;property name&#x3D;&quot;username&quot; value&#x3D;&quot;activemq&quot;&#x2F;&gt;</span><br><span class="line">&lt;property name&#x3D;&quot;password&quot; value&#x3D;&quot;activemq&quot;&#x2F;&gt;</span><br><span class="line">&lt;property name&#x3D;&quot;maxActive&quot; value&#x3D;&quot;200&quot;&#x2F;&gt;</span><br><span class="line">&lt;property name&#x3D;&quot;poolPreparedStatements&quot; value&#x3D;&quot;true&quot;&#x2F;&gt; </span><br><span class="line"></span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>

<p><strong>修改persistenceAdapter</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">      &lt;persistenceAdapter&gt;</span><br><span class="line">         &lt;!-- &lt;kahaDB directory&#x3D;&quot;$&#123;activemq.data&#125;&#x2F;kahadb&quot;&#x2F;&gt; --&gt;</span><br><span class="line"></span><br><span class="line">&lt;jdbcPersistenceAdapter dataSource&#x3D;&quot;#mysql-ds&quot; createTablesOnStartup&#x3D;&quot;true&quot; &#x2F;&gt; </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">      &lt;&#x2F;persistenceAdapter&gt;</span><br></pre></td></tr></table></figure>

<p>依赖jar包</p>
<p>commons-dbcp commons-pool mysql-connector-java</p>
<h4 id="表字段解释"><a href="#表字段解释" class="headerlink" title="表字段解释"></a>表字段解释</h4><p><strong>activemq_acks</strong>：用于存储订阅关系。如果是持久化Topic，订阅者和服务器的订阅关系在这个表保存。<br>主要的数据库字段如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">container：消息的destination </span><br><span class="line">sub_dest：如果是使用static集群，这个字段会有集群其他系统的信息 </span><br><span class="line">client_id：每个订阅者都必须有一个唯一的客户端id用以区分 </span><br><span class="line">sub_name：订阅者名称 </span><br><span class="line">selector：选择器，可以选择只消费满足条件的消息。条件可以用自定义属性实现，可支持多属性and和or操作 </span><br><span class="line">last_acked_id：记录消费过的消息的id。</span><br></pre></td></tr></table></figure>

<p>2：<strong>activemq_lock</strong>：在集群环境中才有用，只有一个Broker可以获得消息，称为Master Broker，其他的只能作为备份等待Master Broker不可用，才可能成为下一个Master Broker。这个表用于记录哪个Broker是当前的Master Broker。</p>
<p>3：<strong>activemq_msgs</strong>：用于存储消息，Queue和Topic都存储在这个表中。<br>主要的数据库字段如下：</p>
<p><a href="javascript:void(0);"><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/copycode.gif" alt="复制代码"></a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">id：自增的数据库主键 </span><br><span class="line">container：消息的destination </span><br><span class="line">msgid_prod：消息发送者客户端的主键 </span><br><span class="line">msg_seq：是发送消息的顺序，msgid_prod+msg_seq可以组成jms的messageid </span><br><span class="line">expiration：消息的过期时间，存储的是从1970-01-01到现在的毫秒数 </span><br><span class="line">msg：消息本体的java序列化对象的二进制数据 </span><br><span class="line">priority：优先级，从0-9，数值越大优先级越高 </span><br><span class="line">xid:用于存储订阅关系。如果是持久化topic，订阅者和服务器的订阅关系在这个表保存。</span><br></pre></td></tr></table></figure>











<h3 id="LevelDB存储"><a href="#LevelDB存储" class="headerlink" title="LevelDB存储"></a>LevelDB存储</h3><p>LevelDB持久化性能高于KahaDB，虽然目前默认的持久化方式仍然是KahaDB。并且，在ActiveMQ 5.9版本提供 了基于LevelDB和Zookeeper的数据复制方式，用于Master-slave方式的首选数据复制方案。 但是在ActiveMQ官网对LevelDB的表述：LevelDB官方建议使用以及不再支持，推荐使用的是KahaDB </p>
<h3 id="Memory-消息存储"><a href="#Memory-消息存储" class="headerlink" title="Memory 消息存储"></a>Memory 消息存储</h3><p>顾名思义，基于内存的消息存储，就是消息存储在内存中。persistent=”false”,表示不设置持 久化存储，直接存储到内存中<br>在broker标签处设置。</p>
<h3 id="JDBC-Message-store-with-ActiveMQ-Journal"><a href="#JDBC-Message-store-with-ActiveMQ-Journal" class="headerlink" title="JDBC Message store with ActiveMQ Journal"></a>JDBC Message store with ActiveMQ Journal</h3><p>这种方式克服了JDBC Store的不足，JDBC存储每次消息过来，都需要去写库和读库。 ActiveMQ Journal，使用延迟存储数据到数据库，当消息来到时先缓存到文件中，延迟后才写到数据库中。</p>
<p>当消费者的消费速度能够及时跟上生产者消息的生产速度时，journal文件能够大大减少需要写入到DB中的消息。 举个例子，生产者生产了1000条消息，这1000条消息会保存到journal文件，如果消费者的消费速度很快的情况 下，在journal文件还没有同步到DB之前，消费者已经消费了90%的以上的消息，那么这个时候只需要同步剩余的 10%的消息到DB。 如果消费者的消费速度很慢，这个时候journal文件可以使消息以批量方式写到DB。 </p>
<h2 id="协议"><a href="#协议" class="headerlink" title="协议"></a>协议</h2><p>完整支持的协议</p>
<p><a href="http://activemq.apache.org/configuring-version-5-transports.html" target="_blank" rel="noopener">http://activemq.apache.org/configuring-version-5-transports.html</a></p>
<p>ActiveMQ支持的client-broker通讯协议有：TCP、NIO、UDP、SSL、Http(s)、VM。</p>
<h3 id="Transmission-Control-Protocol-TCP"><a href="#Transmission-Control-Protocol-TCP" class="headerlink" title="Transmission Control Protocol (TCP)"></a>Transmission Control Protocol (TCP)</h3><p>1：这是默认的Broker配置，TCP的Client监听端口是61616。<br>2：在网络传输数据前，必须要序列化数据，消息是通过一个叫wire protocol的来序列化成字节流。默认情况下，ActiveMQ把wire protocol叫做OpenWire，它的目的是促使网络上的效率和数据快速交互。<br>3：TCP连接的URI形式：tcp://hostname:port?key=value&amp;key=value，加粗部分是必须的<br>4：TCP传输的优点：<br>(1)TCP协议传输可靠性高，稳定性强<br>(2)高效性：字节流方式传递，效率很高<br>(3)有效性、可用性：应用广泛，支持任何平台</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnector name&#x3D;&quot;openwire&quot; uri&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:61616?maximumConnections&#x3D;1000&amp;wireFormat.maxFrameSize&#x3D;104857600&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="New-I-O-API-Protocol（NIO）"><a href="#New-I-O-API-Protocol（NIO）" class="headerlink" title="New I/O API Protocol（NIO）"></a>New I/O API Protocol（NIO）</h3><p>1：NIO协议和TCP协议类似，但NIO更侧重于底层的访问操作。它允许开发人员对同一资源可有更多的client调用和服务端有更多的负载。<br>2：适合使用NIO协议的场景：<br>(1)可能有大量的Client去链接到Broker上一般情况下，大量的Client去链接Broker是被操作系统的线程数所限制的。因此，NIO的实现比TCP需要更少的线程去运行，所以建议使用NIO协议<br>(2)可能对于Broker有一个很迟钝的网络传输NIO比TCP提供更好的性能<br>3：NIO连接的URI形式：nio://hostname:port?key=value<br>4：Transport Connector配置示例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnectors&gt;</span><br><span class="line">　　&lt;transportConnector</span><br><span class="line">　　　　name&#x3D;&quot;tcp&quot;</span><br><span class="line">　　　　uri&#x3D;&quot;tcp:&#x2F;&#x2F;localhost:61616?trace&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">　　&lt;transportConnector</span><br><span class="line">　　　　name&#x3D;&quot;nio&quot;</span><br><span class="line">　　　　uri&#x3D;&quot;nio:&#x2F;&#x2F;localhost:61618?trace&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;transportConnectors&gt;</span><br></pre></td></tr></table></figure>


<p>上面的配置，示范了一个TCP协议监听61616端口，一个NIO协议监听61618端口 </p>
<h3 id="User-Datagram-Protocol（UDP"><a href="#User-Datagram-Protocol（UDP" class="headerlink" title="User Datagram Protocol（UDP)"></a>User Datagram Protocol（UDP)</h3><p>1：UDP和TCP的区别<br>(1)TCP是一个原始流的传递协议，意味着数据包是有保证的，换句话说，数据包是不会被复制和丢失的。UDP，另一方面，它是不会保证数据包的传递的<br>(2)TCP也是一个稳定可靠的数据包传递协议，意味着数据在传递的过程中不会被丢失。这样确保了在发送和接收之间能够可靠的传递。相反，UDP仅仅是一个链接协议，所以它没有可靠性之说<br>2：从上面可以得出：TCP是被用在稳定可靠的场景中使用的；UDP通常用在快速数据传递和不怕数据丢失的场景中，还有ActiveMQ通过防火墙时，只能用UDP<br>3：UDP连接的URI形式：udp://hostname:port?key=value<br>4：Transport Connector配置示例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnectors&gt;</span><br><span class="line">    &lt;transportConnector</span><br><span class="line">        name&#x3D;&quot;udp&quot;</span><br><span class="line">        uri&#x3D;&quot;udp:&#x2F;&#x2F;localhost:61618?trace&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;transportConnectors&gt;</span><br></pre></td></tr></table></figure>



<h3 id="Secure-Sockets-Layer-Protocol-SSL"><a href="#Secure-Sockets-Layer-Protocol-SSL" class="headerlink" title="Secure Sockets Layer Protocol (SSL)"></a>Secure Sockets Layer Protocol (SSL)</h3><p>1：连接的URI形式：ssl://hostname:port?key=value<br>2：Transport Connector配置示例： </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnectors&gt;</span><br><span class="line">    &lt;transportConnector name&#x3D;&quot;ssl&quot; uri&#x3D;&quot;ssl:&#x2F;&#x2F;localhost:61617?trace&#x3D;true&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;transportConnectors&gt;</span><br></pre></td></tr></table></figure>





<h3 id="Hypertext-Transfer-Protocol-HTTP-HTTPS"><a href="#Hypertext-Transfer-Protocol-HTTP-HTTPS" class="headerlink" title="Hypertext Transfer Protocol (HTTP/HTTPS)"></a>Hypertext Transfer Protocol (HTTP/HTTPS)</h3><p>1：像web和email等服务需要通过防火墙来访问的，Http可以使用这种场合<br>2：连接的URI形式：<a href="http://hostname:port?key=value或者https://hostname:port?key=value">http://hostname:port?key=value或者https://hostname:port?key=value</a><br>3：Transport Connector配置示例：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnectors&gt;</span><br><span class="line">    &lt;transportConnector name&#x3D;&quot;http&quot; uri&#x3D;&quot;http:&#x2F;&#x2F;localhost:8080?trace&#x3D;true&quot; &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;transportConnectors&gt;</span><br></pre></td></tr></table></figure>





<h3 id="VM-Protocol（VM）"><a href="#VM-Protocol（VM）" class="headerlink" title="VM Protocol（VM）"></a>VM Protocol（VM）</h3><p>1、VM transport允许在VM内部通信，从而避免了网络传输的开销。这时候采用的连 接不是socket连接，而是直接的方法调用。 </p>
<p>2、第一个创建VM连接的客户会启动一个embed VM broker，接下来所有使用相同的 broker name的VM连接都会使用这个broker。当这个broker上所有的连接都关闭 的时候，这个broker也会自动关闭。 </p>
<p>3、连接的URI形式：vm://brokerName?key=value </p>
<p>4、Java中嵌入的方式： vm:broker:(tcp://localhost:6000)?brokerName=embeddedbroker&amp;persistent=fal se ， 定义了一个嵌入的broker名称为embededbroker以及配置了一个 tcptransprotconnector在监听端口6000上 </p>
<p>5、使用一个加载一个配置文件来启动broker vm://localhost?brokerConfig=xbean:activemq.xml</p>
<h2 id="HelloWorld"><a href="#HelloWorld" class="headerlink" title="HelloWorld"></a>HelloWorld</h2><h3 id="下载"><a href="#下载" class="headerlink" title="下载"></a>下载</h3><p><a href="http://activemq.apache.org/" target="_blank" rel="noopener">http://activemq.apache.org/</a></p>
<h3 id="安装启动"><a href="#安装启动" class="headerlink" title="安装启动"></a>安装启动</h3><p>解压后直接执行</p>
<p><code>bin/win64/activemq.bat</code></p>
<h3 id="web控制台"><a href="#web控制台" class="headerlink" title="web控制台"></a>web控制台</h3><p><a href="http://localhost:8161/" target="_blank" rel="noopener">http://localhost:8161/</a></p>
<p>通过8161端口访问</p>
<h3 id="修改访问端口"><a href="#修改访问端口" class="headerlink" title="修改访问端口"></a>修改访问端口</h3><p>修改 ActiveMQ 配置文件:/usr/local/activemq/conf/jetty.xml</p>
<p><strong>jettyport节点</strong></p>
<p>配置文件修改完毕，保存并重新启动 ActiveMQ 服务。</p>
<h3 id="开发"><a href="#开发" class="headerlink" title="开发"></a>开发</h3><p>maven坐标</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- https:&#x2F;&#x2F;mvnrepository.com&#x2F;artifact&#x2F;org.apache.activemq&#x2F;activemq-all --&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;org.apache.activemq&lt;&#x2F;groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;activemq-all&lt;&#x2F;artifactId&gt;</span><br><span class="line">    &lt;version&gt;5.15.11&lt;&#x2F;version&gt;</span><br><span class="line">&lt;&#x2F;dependency&gt;</span><br></pre></td></tr></table></figure>



<h4 id="Sender"><a href="#Sender" class="headerlink" title="Sender"></a>Sender</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.activemq01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Connection;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Destination;</span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.MessageProducer;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Queue;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Session;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1. 建立工厂对象，</span></span><br><span class="line">		ActiveMQConnectionFactory activeMQConnectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">				ActiveMQConnectionFactory.DEFAULT_USER,</span><br><span class="line">				ActiveMQConnectionFactory.DEFAULT_PASSWORD,</span><br><span class="line">				<span class="string">"tcp://localhost:61616"</span></span><br><span class="line">				);</span><br><span class="line">		<span class="comment">//2 从工厂里拿一个连接</span></span><br><span class="line">		Connection connection = activeMQConnectionFactory.createConnection();</span><br><span class="line">		connection.start();</span><br><span class="line">		<span class="comment">//3 从连接中获取Session(会话)</span></span><br><span class="line">		Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">		<span class="comment">// 从会话中获取目的地(Destination)消费者会从这个目的地取消息</span></span><br><span class="line">		Queue queue = session.createQueue(<span class="string">"f"</span>);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//从会话中创建消息提供者</span></span><br><span class="line">		</span><br><span class="line">		MessageProducer producer = session.createProducer(queue);</span><br><span class="line">		<span class="comment">//从会话中创建文本消息(也可以创建其它类型的消息体)</span></span><br><span class="line">		</span><br><span class="line">		<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">			TextMessage message = session.createTextMessage(<span class="string">"msg: "</span> + i);</span><br><span class="line">			<span class="comment">// 通过消息提供者发送消息到ActiveMQ</span></span><br><span class="line">			Thread.sleep(<span class="number">1000</span>);</span><br><span class="line">			producer.send(message);</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		<span class="comment">// 关闭连接</span></span><br><span class="line">		connection.close();</span><br><span class="line">		System.out.println(<span class="string">"exit"</span>);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="Receiver"><a href="#Receiver" class="headerlink" title="Receiver"></a>Receiver</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.activemq01;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.Connection;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Destination;</span><br><span class="line"><span class="keyword">import</span> javax.jms.JMSException;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Message;</span><br><span class="line"><span class="keyword">import</span> javax.jms.MessageConsumer;</span><br><span class="line"><span class="keyword">import</span> javax.jms.MessageProducer;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Queue;</span><br><span class="line"><span class="keyword">import</span> javax.jms.Session;</span><br><span class="line"><span class="keyword">import</span> javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.apache.activemq.ActiveMQConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Receiver</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">		<span class="comment">// 1. 建立工厂对象，</span></span><br><span class="line">		ActiveMQConnectionFactory activeMQConnectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">				ActiveMQConnectionFactory.DEFAULT_USER,</span><br><span class="line">				ActiveMQConnectionFactory.DEFAULT_PASSWORD,</span><br><span class="line">				<span class="string">"tcp://localhost:61616"</span></span><br><span class="line">				);</span><br><span class="line">		<span class="comment">//2 从工厂里拿一个连接</span></span><br><span class="line">		Connection connection = activeMQConnectionFactory.createConnection();</span><br><span class="line">		connection.start();</span><br><span class="line">		<span class="comment">//3 从连接中获取Session(会话)</span></span><br><span class="line">		Session session = connection.createSession(<span class="keyword">false</span>, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">		<span class="comment">// 从会话中获取目的地(Destination)消费者会从这个目的地取消息</span></span><br><span class="line">		Queue queue = session.createQueue(<span class="string">"f"</span>);</span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="comment">//从会话中创建消息提供者</span></span><br><span class="line">		</span><br><span class="line">		MessageConsumer consumer = session.createConsumer(queue);</span><br><span class="line">		<span class="comment">//从会话中创建文本消息(也可以创建其它类型的消息体)</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">		<span class="keyword">while</span> (<span class="keyword">true</span>) &#123;</span><br><span class="line">			TextMessage receive = (TextMessage)consumer.receive();</span><br><span class="line">			System.out.println(<span class="string">"TextMessage:"</span> + receive.getText());</span><br><span class="line">			</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Active-MQ的安全机制"><a href="#Active-MQ的安全机制" class="headerlink" title="Active MQ的安全机制"></a>Active MQ的安全机制</h2><h3 id="web控制台安全"><a href="#web控制台安全" class="headerlink" title="web控制台安全"></a>web控制台安全</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># username: password [,rolename ...]</span><br><span class="line">admin: admin, admin</span><br><span class="line">user: user, user</span><br><span class="line">yiming: 123, user</span><br></pre></td></tr></table></figure>

<p>用户名：密码，角色</p>
<p>注意: 配置需重启ActiveMQ才会生效。</p>
<h3 id="消息安全机制"><a href="#消息安全机制" class="headerlink" title="消息安全机制"></a>消息安全机制</h3><p>修改 activemq.xml</p>
<p>在123行      节点中添加</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line">         <span class="tag">&lt;<span class="name">users</span>&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"admin"</span> <span class="attr">password</span>=<span class="string">"admin"</span> <span class="attr">groups</span>=<span class="string">"admins,publishers,consumers"</span>/&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"publisher"</span> <span class="attr">password</span>=<span class="string">"publisher"</span>  <span class="attr">groups</span>=<span class="string">"publishers,consumers"</span>/&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"consumer"</span> <span class="attr">password</span>=<span class="string">"consumer"</span> <span class="attr">groups</span>=<span class="string">"consumers"</span>/&gt;</span></span><br><span class="line">             <span class="tag">&lt;<span class="name">authenticationUser</span> <span class="attr">username</span>=<span class="string">"guest"</span> <span class="attr">password</span>=<span class="string">"guest"</span>  <span class="attr">groups</span>=<span class="string">"guests"</span>/&gt;</span></span><br><span class="line">         <span class="tag">&lt;/<span class="name">users</span>&gt;</span></span><br><span class="line">     <span class="tag">&lt;/<span class="name">simpleAuthenticationPlugin</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h1 id="2-基本使用"><a href="#2-基本使用" class="headerlink" title="2. 基本使用"></a>2. 基本使用</h1><h2 id="常用API"><a href="#常用API" class="headerlink" title="常用API"></a>常用API</h2><h3 id="事务"><a href="#事务" class="headerlink" title="事务"></a>事务</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">session.commit();</span><br><span class="line">session.rollback();</span><br></pre></td></tr></table></figure>

<p>用来提交/回滚事务</p>
<h3 id="Purge"><a href="#Purge" class="headerlink" title="Purge"></a>Purge</h3><p>清理消息</p>
<h3 id="签收模式"><a href="#签收模式" class="headerlink" title="签收模式"></a>签收模式</h3><p>签收代表接收端的session已收到消息的一次确认，反馈给broker</p>
<p>ActiveMQ支持自动签收与手动签收</p>
<h4 id="Session-AUTO-ACKNOWLEDGE"><a href="#Session-AUTO-ACKNOWLEDGE" class="headerlink" title="Session.AUTO_ACKNOWLEDGE"></a>Session.AUTO_ACKNOWLEDGE</h4><p>当客户端从receiver或onMessage成功返回时，Session自动签收客户端的这条消息的收条。</p>
<h4 id="Session-CLIENT-ACKNOWLEDGE"><a href="#Session-CLIENT-ACKNOWLEDGE" class="headerlink" title="Session.CLIENT_ACKNOWLEDGE"></a>Session.CLIENT_ACKNOWLEDGE</h4><p>客户端通过调用消息(Message)的acknowledge方法签收消息。在这种情况下，签收发生在Session层面：签收一个已经消费的消息会自动地签收这个Session所有已消费的收条。</p>
<h4 id="Session-DUPS-OK-ACKNOWLEDGE"><a href="#Session-DUPS-OK-ACKNOWLEDGE" class="headerlink" title="Session.DUPS_OK_ACKNOWLEDGE"></a>Session.DUPS_OK_ACKNOWLEDGE</h4><p>Session不必确保对传送消息的签收，这个模式可能会引起消息的重复，但是降低了Session的开销，所以只有客户端能容忍重复的消息，才可使用。</p>
<h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><p>默认持久化是开启的</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT)</span><br></pre></td></tr></table></figure>

<h3 id="优先级-1"><a href="#优先级-1" class="headerlink" title="优先级"></a>优先级</h3><p>可以打乱消费顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">producer.setPriority</span><br></pre></td></tr></table></figure>

<p>配置文件需要指定使用优先级的目的地</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;policyEntry queue&#x3D;&quot;queue1&quot; prioritizedMessages&#x3D;&quot;true&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="消息超时-过期"><a href="#消息超时-过期" class="headerlink" title="消息超时/过期"></a>消息超时/过期</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">producer.setTimeToLive</span><br></pre></td></tr></table></figure>

<p>设置了消息超时的消息，消费端在超时后无法在消费到此消息。</p>
<p>给消息设置一个超时时间 -&gt; 死信队列 -&gt; 拿出来 -&gt; 重发</p>
<h4 id="死信"><a href="#死信" class="headerlink" title="死信"></a>死信</h4><p>此类消息会进入到<code>ActiveMQ.DLQ</code>队列且不会自动清除，称为死信</p>
<p>此处有消息堆积的风险</p>
<h4 id="修改死信队列名称"><a href="#修改死信队列名称" class="headerlink" title="修改死信队列名称"></a>修改死信队列名称</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">queue</span>=<span class="string">"f"</span> <span class="attr">prioritizedMessages</span>=<span class="string">"true"</span> &gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">deadLetterStrategy</span>&gt;</span> </span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">individualDeadLetterStrategy</span>   <span class="attr">queuePrefix</span>=<span class="string">"DLxxQ."</span> <span class="attr">useQueueForQueueMessages</span>=<span class="string">"true"</span> /&gt;</span> </span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">deadLetterStrategy</span>&gt;</span> </span><br><span class="line"> <span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>useQueueForQueueMessages: 设置使用队列保存死信，还可以设置useQueueForTopicMessages，使用Topic来保存死信 </p>
<h4 id="让非持久化的消息也进入死信队列"><a href="#让非持久化的消息也进入死信队列" class="headerlink" title="让非持久化的消息也进入死信队列"></a>让非持久化的消息也进入死信队列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;individualDeadLetterStrategy   queuePrefix&#x3D;&quot;DLxxQ.&quot; useQueueForQueueMessages&#x3D;&quot;true&quot;  processNonPersistent&#x3D;&quot;true&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>processNonPersistent=”true”</p>
<h4 id="过期消息不进死信队列"><a href="#过期消息不进死信队列" class="headerlink" title="过期消息不进死信队列"></a>过期消息不进死信队列</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;individualDeadLetterStrategy   processExpired&#x3D;&quot;false&quot;  &#x2F;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="独占消费者"><a href="#独占消费者" class="headerlink" title="独占消费者"></a>独占消费者</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue queue &#x3D; session.createQueue(&quot;xxoo?consumer.exclusive&#x3D;true&quot;);</span><br></pre></td></tr></table></figure>

<p>还可以设置优先级</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Queue queue &#x3D; session.createQueue(&quot;xxoo?consumer.exclusive&#x3D;true&amp;consumer.priority&#x3D;10&quot;);</span><br></pre></td></tr></table></figure>



<h2 id="消息类型"><a href="#消息类型" class="headerlink" title="消息类型"></a>消息类型</h2><h3 id="object"><a href="#object" class="headerlink" title="object"></a>object</h3><h4 id="发送端"><a href="#发送端" class="headerlink" title="发送端"></a>发送端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Girl girl = <span class="keyword">new</span> Girl(<span class="string">"qiqi"</span>,<span class="number">25</span>,<span class="number">398.0</span>);</span><br><span class="line"></span><br><span class="line">Message message = session.createObjectMessage(girl);</span><br></pre></td></tr></table></figure>



<h4 id="接受端"><a href="#接受端" class="headerlink" title="接受端"></a>接受端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(message <span class="keyword">instanceof</span> ActiveMQObjectMessage) &#123;</span><br><span class="line">	</span><br><span class="line">	Girl girl = (Girl)((ActiveMQObjectMessage)message).getObject();</span><br><span class="line">	</span><br><span class="line">	System.out.println(girl);</span><br><span class="line">	System.out.println(girl.getName());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>如果遇到此类报错</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Exception in thread &quot;main&quot; javax.jms.JMSException: Failed to build body from content. Serializable class not available to broker. Reason: java.lang.ClassNotFoundException: Forbidden class com.mashibing.mq.Girl! This class is not trusted to be serialized as ObjectMessage payload. Please take a look at http:&#x2F;&#x2F;activemq.apache.org&#x2F;objectmessage.html for more information on how to configure trusted classes.</span><br><span class="line">	at org.apache.activemq.util.JMSExceptionSupport.create(JMSExceptionSupport.java:36)</span><br><span class="line">	at org.apache.activemq.command.ActiveMQObjectMessage.getObject(ActiveMQObjectMessage.java:213)</span><br><span class="line">	at com.mashibing.mq.Receiver.main(Receiver.java:65)</span><br><span class="line">Caused by: java.lang.ClassNotFoundException: Forbidden class com.mashibing.mq.Girl! This class is not trusted to be serialized as ObjectMessage payload. Please take a look at http:&#x2F;&#x2F;activemq.apache.org&#x2F;objectmessage.html for more information on how to configure trusted classes.</span><br><span class="line">	at org.apache.activemq.util.ClassLoadingAwareObjectInputStream.checkSecurity(ClassLoadingAwareObjectInputStream.java:112)</span><br><span class="line">	at org.apache.activemq.util.ClassLoadingAwareObjectInputStream.resolveClass(ClassLoadingAwareObjectInputStream.java:57)</span><br><span class="line">	at java.io.ObjectInputStream.readNonProxyDesc(ObjectInputStream.java:1868)</span><br><span class="line">	at java.io.ObjectInputStream.readClassDesc(ObjectInputStream.java:1751)</span><br><span class="line">	at java.io.ObjectInputStream.readOrdinaryObject(ObjectInputStream.java:2042)</span><br><span class="line">	at java.io.ObjectInputStream.readObject0(ObjectInputStream.java:1573)</span><br><span class="line">	at java.io.ObjectInputStream.readObject(ObjectInputStream.java:431)</span><br><span class="line">	at org.apache.activemq.command.ActiveMQObjectMessage.getObject(ActiveMQObjectMessage.java:211)</span><br><span class="line">	... 1 more</span><br></pre></td></tr></table></figure>

<p><strong>需要添加信任</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">connectionFactory.setTrustedPackages(</span><br><span class="line">		new ArrayList&lt;String&gt;(</span><br><span class="line">				Arrays.asList(</span><br><span class="line">						new String[]&#123;</span><br><span class="line">								Girl.class.getPackage().getName()</span><br><span class="line">								&#125;</span><br><span class="line">						</span><br><span class="line">						)</span><br><span class="line">				)</span><br><span class="line">		</span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<h3 id="bytesMessage"><a href="#bytesMessage" class="headerlink" title="bytesMessage"></a>bytesMessage</h3><h4 id="发送端-1"><a href="#发送端-1" class="headerlink" title="发送端"></a>发送端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BytesMessage bytesMessage &#x3D; session.createBytesMessage();</span><br><span class="line">      bytesMessage.writeBytes(&quot;str&quot;.getBytes());</span><br><span class="line">      bytesMessage.writeUTF(&quot;哈哈&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="接受端-1"><a href="#接受端-1" class="headerlink" title="接受端"></a>接受端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span>(message <span class="keyword">instanceof</span> BytesMessage) &#123;</span><br><span class="line">	BytesMessage bm = (BytesMessage)message;</span><br><span class="line">	</span><br><span class="line">	 <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>];</span><br><span class="line">           <span class="keyword">int</span> len = -<span class="number">1</span>;</span><br><span class="line">           <span class="keyword">while</span> ((len = bm.readBytes(b)) != -<span class="number">1</span>) &#123;</span><br><span class="line">               System.out.println(<span class="keyword">new</span> String(b, <span class="number">0</span>, len));</span><br><span class="line">           &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>还可以使用ActiveMQ给提供的便捷方法,但要注意读取和写入的顺序</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">bm.readBoolean()</span><br><span class="line">bm.readUTF()</span><br></pre></td></tr></table></figure>



<h4 id="写入文件"><a href="#写入文件" class="headerlink" title="写入文件"></a>写入文件</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">FileOutputStream out &#x3D; null;</span><br><span class="line">try &#123;</span><br><span class="line">    out &#x3D; new FileOutputStream(&quot;d:&#x2F;aa.txt&quot;);</span><br><span class="line">&#125; catch (FileNotFoundException e2) &#123;</span><br><span class="line">    e2.printStackTrace();</span><br><span class="line">&#125;</span><br><span class="line">byte[] by &#x3D; new byte[1024];</span><br><span class="line">int len &#x3D; 0 ;</span><br><span class="line">try &#123;</span><br><span class="line">    while((len &#x3D; bm.readBytes(by))!&#x3D; -1)&#123;</span><br><span class="line">        out.write(by,0,len);</span><br><span class="line">    &#125;</span><br><span class="line">&#125; catch (Exception e1) &#123;</span><br><span class="line">    e1.printStackTrace();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="MapMessage-1"><a href="#MapMessage-1" class="headerlink" title="MapMessage"></a>MapMessage</h3><h4 id="发送端-2"><a href="#发送端-2" class="headerlink" title="发送端"></a>发送端</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">MapMessage mapMessage = session.createMapMessage();</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line">mapMessage.setString(<span class="string">"name"</span>,<span class="string">"lucy"</span>);</span><br><span class="line">      mapMessage.setBoolean(<span class="string">"yihun"</span>,<span class="keyword">false</span>);</span><br><span class="line">mapMessage.setInt(<span class="string">"age"</span>, <span class="number">17</span>);</span><br><span class="line"></span><br><span class="line">producer.send(mapMessage);</span><br></pre></td></tr></table></figure>

<h4 id="接收端"><a href="#接收端" class="headerlink" title="接收端"></a>接收端</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Message message &#x3D; consumer.receive();</span><br><span class="line">MapMessage mes &#x3D; (MapMessage) message;</span><br><span class="line"></span><br><span class="line">System.out.println(mes);</span><br><span class="line"></span><br><span class="line">System.out.println(mes.getString(&quot;name&quot;));</span><br></pre></td></tr></table></figure>

<h2 id="消息发送原理"><a href="#消息发送原理" class="headerlink" title="消息发送原理"></a>消息发送原理</h2><h3 id="同步与异步"><a href="#同步与异步" class="headerlink" title="同步与异步"></a>同步与异步</h3><table>
<thead>
<tr>
<th></th>
<th>开启事务</th>
<th>关闭事务</th>
</tr>
</thead>
<tbody><tr>
<td>持久化</td>
<td>异步</td>
<td>同步</td>
</tr>
<tr>
<td>非持久化</td>
<td>异步</td>
<td>异步</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
</tbody></table>
<p>我们可以通过以下几种方式来设置异步发送：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">		<span class="string">"admin"</span>,</span><br><span class="line">		<span class="string">"admin"</span>,</span><br><span class="line">		<span class="string">"tcp://localhost:61616"</span></span><br><span class="line">		);</span><br><span class="line"><span class="comment">// 2.获取一个向ActiveMQ的连接</span></span><br><span class="line">connectionFactory.setUseAsyncSend(<span class="keyword">true</span>);</span><br><span class="line">ActiveMQConnection connection = (ActiveMQConnection)connectionFactory.createConnection();</span><br><span class="line">connection.setUseAsyncSend(<span class="keyword">true</span>);</span><br></pre></td></tr></table></figure>

<h3 id="消息堆积"><a href="#消息堆积" class="headerlink" title="消息堆积"></a>消息堆积</h3><p>producer每发送一个消息，统计一下发送的字节数，当字节数达到ProducerWindowSize值时，需要等待broker的确认，才能继续发送。</p>
<p>brokerUrl中设置: <code>tcp://localhost:61616?jms.producerWindowSize=1048576</code></p>
<p>destinationUri中设置: <code>myQueue?producer.windowSize=1048576</code></p>
<h3 id="延迟消息投递"><a href="#延迟消息投递" class="headerlink" title="延迟消息投递"></a>延迟消息投递</h3><p>首先在配置文件中开启延迟和调度</p>
<p><strong>schedulerSupport=”true”</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;broker xmlns&#x3D;&quot;http:&#x2F;&#x2F;activemq.apache.org&#x2F;schema&#x2F;core&quot; brokerName&#x3D;&quot;localhost&quot; dataDirectory&#x3D;&quot;$&#123;activemq.data&#125;&quot; schedulerSupport&#x3D;&quot;true&quot;&gt;</span><br></pre></td></tr></table></figure>

<h3 id="延迟发送"><a href="#延迟发送" class="headerlink" title="延迟发送"></a>延迟发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, 10*1000);</span><br></pre></td></tr></table></figure>

<h3 id="带间隔的重复发送"><a href="#带间隔的重复发送" class="headerlink" title="带间隔的重复发送"></a>带间隔的重复发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">long delay &#x3D; 10 * 1000;</span><br><span class="line">long period &#x3D; 2 * 1000;</span><br><span class="line">int repeat &#x3D; 9;</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, delay);</span><br><span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD, period);</span><br><span class="line">message.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT, repeat);</span><br><span class="line">createProducer.send(message);</span><br></pre></td></tr></table></figure>

<h3 id="Cron表达式定时发送"><a href="#Cron表达式定时发送" class="headerlink" title="Cron表达式定时发送"></a>Cron表达式定时发送</h3><p>Cron表达式是一个字符串，字符串以5或6个空格隔开，分为6或7个域，每一个域代表一个含义，Cron有如下两种语法格式： </p>
<p><em>Seconds Minutes Hours DayofMonth Month DayofWeek Year或</em> </p>
<p>Seconds Minutes Hours DayofMonth Month DayofWeek</p>
<p>每一个域可出现的字符如下： </p>
<p>Seconds:可出现”, - * /“四个字符，有效范围为0-59的整数 </p>
<p>Minutes:可出现”, - * /“四个字符，有效范围为0-59的整数 </p>
<p>Hours:可出现”, - * /“四个字符，有效范围为0-23的整数 </p>
<p>DayofMonth:可出现”, - * / ? L W C”八个字符，有效范围为0-31的整数 </p>
<p>Month:可出现”, - * /“四个字符，有效范围为1-12的整数或JAN-DEc </p>
<p>DayofWeek:可出现”, - * / ? L C #”四个字符，有效范围为1-7的整数或SUN-SAT两个范围。1表示星期天，2表示星期一， 依次类推 </p>
<p>Year:可出现”, - * /“四个字符，有效范围为1970-2099年</p>
<p>每一个域都使用数字，但还可以出现如下特殊字符，它们的含义是： </p>
<p>(1)<em>：表示匹配该域的任意值，假如在Minutes域使用</em>, 即表示每分钟都会触发事件。</p>
<p>(2)?:只能用在DayofMonth和DayofWeek两个域。它也匹配域的任意值，但实际不会。因为DayofMonth和 DayofWeek会相互影响。例如想在每月的20日触发调度，不管20日到底是星期几，则只能使用如下写法： 13 13 15 20 * ?, 其中最后一位只能用？，而不能使用<em>，如果使用</em>表示不管星期几都会触发，实际上并不是这样。 </p>
<p>(3)-:表示范围，例如在Minutes域使用5-20，表示从5分到20分钟每分钟触发一次 </p>
<p>(4)/：表示起始时间开始触发，然后每隔固定时间触发一次，例如在Minutes域使用5/20,则意味着5分钟触发一次，而25，45等分别触发一次. </p>
<p>(5),:表示列出枚举值值。例如：在Minutes域使用5,20，则意味着在5和20分每分钟触发一次。 </p>
<p>(6)L:表示最后，只能出现在DayofWeek和DayofMonth域，如果在DayofWeek域使用5L,意味着在最后的一个星期四触发。 </p>
<p>(7)W: 表示有效工作日(周一到周五),只能出现在DayofMonth域，系统将在离指定日期的最近的有效工作日触发事件。例如：在 DayofMonth使用5W，如果5日是星期六，则将在最近的工作日：星期五，即4日触发。如果5日是星期天，则在6日(周一)触发；如果5日在星期一 到星期五中的一天，则就在5日触发。另外一点，W的最近寻找不会跨过月份 </p>
<p>(8)LW:这两个字符可以连用，表示在某个月最后一个工作日，即最后一个星期五。 </p>
<p>(9)#:用于确定每个月第几个星期几，只能出现在DayofMonth域。例如在4#2，表示某月的第二个星期三。</p>
<p>举几个例子: </p>
<p>0 0 2 1 * ? * 表示在每月的1日的凌晨2点调度任务 </p>
<p>0 15 10 ? * MON-FRI 表示周一到周五每天上午10：15执行作业 </p>
<p>0 15 10 ? 6L 2002-2006 表示2002-2006年的每个月的最后一个星期五上午10:15执行作</p>
<p>一个cron表达式有至少6个（也可能7个）有空格分隔的时间元素。 </p>
<p>按顺序依次为 </p>
<p>秒（0~59） </p>
<p>分钟（0~59） </p>
<p>小时（0~23） </p>
<p>天（月）（0~31，但是你需要考虑你月的天数） </p>
<p>月（0~11） </p>
<p>天（星期）（1~7 1=SUN 或 SUN，MON，TUE，WED，THU，FRI，SAT） </p>
<p>年份（1970－2099）</p>
<p>其中每个元素可以是一个值(如6),一个连续区间(9-12),一个间隔时间(8-18/4)(/表示每隔4小时),一个列表(1,3,5),通配符。由于”月份中的日期”和”星期中的日期”这两个元素互斥的,必须要对其中一个设置?</p>
<p>0 0 10,14,16 * * ? 每天上午10点，下午2点，4点 </p>
<p>0 0/30 9-17 * * ? 朝九晚五工作时间内每半小时 </p>
<p>0 0 12 ? * WED 表示每个星期三中午12点 </p>
<p>“0 0 12 * * ?” 每天中午12点触发 </p>
<p>“0 15 10 ? * *” 每天上午10:15触发 </p>
<p>“0 15 10 * * ?” 每天上午10:15触发 </p>
<p>“0 15 10 * * ? *” 每天上午10:15触发 </p>
<p>“0 15 10 * * ? 2005” 2005年的每天上午10:15触发 </p>
<p>“0 * 14 * * ?” 在每天下午2点到下午2:59期间的每1分钟触发 </p>
<p>“0 0/5 14 * * ?” 在每天下午2点到下午2:55期间的每5分钟触发 </p>
<p>“0 0/5 14,18 * * ?” 在每天下午2点到2:55期间和下午6点到6:55期间的每5分钟触发 </p>
<p>“0 0-5 14 * * ?” 在每天下午2点到下午2:05期间的每1分钟触发 </p>
<p>“0 10,44 14 ? 3 WED” 每年三月的星期三的下午2:10和2:44触发 </p>
<p>“0 15 10 ? * MON-FRI” 周一至周五的上午10:15触发 </p>
<p>“0 15 10 15 * ?” 每月15日上午10:15触发 </p>
<p>“0 15 10 L * ?” 每月最后一日的上午10:15触发 </p>
<p>“0 15 10 ? * 6L” 每月的最后一个星期五上午10:15触发 </p>
<p>“0 15 10 ? * 6L 2002-2005” 2002年至2005年的每月的最后一个星期五上午10:15触发 </p>
<p>“0 15 10 ? * 6#3” 每月的第三个星期五上午10:15触发</p>
<h2 id="监听器"><a href="#监听器" class="headerlink" title="监听器"></a>监听器</h2><p>可以使用监听器来处理消息接收</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">consumer.setMessageListener(new MyListener());</span><br></pre></td></tr></table></figure>

<p>需要实现接口MessageListener</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public class MyListener implements MessageListener &#123;</span><br><span class="line"></span><br><span class="line">	public void onMessage(Message message) &#123;</span><br><span class="line">		&#x2F;&#x2F; TODO Auto-generated method stub</span><br><span class="line">		TextMessage textMessage &#x3D; (TextMessage)message;</span><br><span class="line">		try &#123;</span><br><span class="line">			System.out.println(&quot;xxoo&quot; + textMessage.getText());</span><br><span class="line">		&#125; catch (JMSException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>当收到消息后会调起onMessage方法</p>
<h2 id="消息过滤"><a href="#消息过滤" class="headerlink" title="消息过滤"></a>消息过滤</h2><h3 id="消息发送"><a href="#消息发送" class="headerlink" title="消息发送"></a>消息发送</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">MapMessage msg1 &#x3D; session.createMapMessage();</span><br><span class="line">msg1.setString(&quot;name&quot;, &quot;qiqi&quot;);</span><br><span class="line">msg1.setString(&quot;age&quot;, &quot;18&quot;);</span><br><span class="line"></span><br><span class="line">msg1.setStringProperty(&quot;name&quot;, &quot;qiqi&quot;);</span><br><span class="line">msg1.setIntProperty(&quot;age&quot;, 18);</span><br><span class="line">MapMessage msg2 &#x3D; session.createMapMessage();</span><br><span class="line">msg2.setString(&quot;name&quot;, &quot;lucy&quot;);</span><br><span class="line">msg2.setString(&quot;age&quot;, &quot;18&quot;);</span><br><span class="line">msg2.setStringProperty(&quot;name&quot;, &quot;lucy&quot;);</span><br><span class="line">msg2.setIntProperty(&quot;age&quot;, 18);</span><br><span class="line">MapMessage msg3 &#x3D; session.createMapMessage();</span><br><span class="line">msg3.setString(&quot;name&quot;, &quot;qianqian&quot;);</span><br><span class="line">msg3.setString(&quot;age&quot;, &quot;17&quot;);</span><br><span class="line">msg3.setStringProperty(&quot;name&quot;, &quot;qianqian&quot;);</span><br><span class="line">msg3.setIntProperty(&quot;age&quot;, 17);</span><br></pre></td></tr></table></figure>

<h3 id="消息接收"><a href="#消息接收" class="headerlink" title="消息接收"></a>消息接收</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">	</span><br><span class="line">String selector1 &#x3D; &quot;age &gt; 17&quot;;</span><br><span class="line">String selector2 &#x3D; &quot;name &#x3D; &#39;lucy&#39;&quot;;</span><br><span class="line">MessageConsumer consumer &#x3D; session.createConsumer(queue,selector2);</span><br></pre></td></tr></table></figure>





<h2 id="整合SpringBoot"><a href="#整合SpringBoot" class="headerlink" title="整合SpringBoot"></a>整合SpringBoot</h2><h3 id="配置文件"><a href="#配置文件" class="headerlink" title="配置文件"></a>配置文件</h3><h4 id="POM"><a href="#POM" class="headerlink" title="POM"></a>POM</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span></span><br><span class="line"><span class="tag">	<span class="attr">xsi:schemaLocation</span>=<span class="string">"http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd"</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">parent</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">version</span>&gt;</span>2.2.3.BUILD-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">relativePath</span>/&gt;</span> <span class="comment">&lt;!-- lookup parent from repository --&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.mashibing.arika<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>mq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">version</span>&gt;</span>0.0.1-SNAPSHOT<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">name</span>&gt;</span>mq<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">description</span>&gt;</span>Demo project for Spring Boot<span class="tag">&lt;/<span class="name">description</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">properties</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span><br><span class="line">		</span><br><span class="line"></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-test<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">scope</span>&gt;</span>test<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">exclusions</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">exclusion</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.junit.vintage<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">					<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>junit-vintage-engine<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;/<span class="name">exclusion</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">exclusions</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-activemq<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		</span><br><span class="line">		</span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.messaginghub<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">		    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>pooled-jms<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">				</span><br><span class="line">		<span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.apache.commons<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">	            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>commons-pool2<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">	        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">build</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">build</span>&gt;</span></span><br><span class="line"></span><br><span class="line">	<span class="tag">&lt;<span class="name">repositories</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">repository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">repository</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">repositories</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-milestones<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Milestones<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/milestone<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">id</span>&gt;</span>spring-snapshots<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">name</span>&gt;</span>Spring Snapshots<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">url</span>&gt;</span>https://repo.spring.io/snapshot<span class="tag">&lt;/<span class="name">url</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;<span class="name">snapshots</span>&gt;</span></span><br><span class="line">				<span class="tag">&lt;<span class="name">enabled</span>&gt;</span>true<span class="tag">&lt;/<span class="name">enabled</span>&gt;</span></span><br><span class="line">			<span class="tag">&lt;/<span class="name">snapshots</span>&gt;</span></span><br><span class="line">		<span class="tag">&lt;/<span class="name">pluginRepository</span>&gt;</span></span><br><span class="line">	<span class="tag">&lt;/<span class="name">pluginRepositories</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="yml"><a href="#yml" class="headerlink" title="yml"></a>yml</h4><figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">server:</span></span><br><span class="line">  <span class="attr">port:</span> <span class="number">80</span></span><br><span class="line">  </span><br><span class="line"><span class="attr">spring:</span></span><br><span class="line">  <span class="attr">activemq:</span></span><br><span class="line">    <span class="attr">broker-url:</span> <span class="string">tcp://localhost:61616</span></span><br><span class="line">    <span class="attr">user:</span> <span class="string">admin</span></span><br><span class="line">    <span class="attr">password:</span> <span class="string">admin</span></span><br><span class="line">    </span><br><span class="line">    <span class="attr">pool:</span></span><br><span class="line">      <span class="attr">enabled:</span> <span class="literal">true</span></span><br><span class="line">      <span class="comment">#连接池最大连接数</span></span><br><span class="line">      <span class="attr">max-connections:</span> <span class="number">5</span></span><br><span class="line">      <span class="comment">#空闲的连接过期时间，默认为30秒</span></span><br><span class="line">      <span class="attr">idle-timeout:</span> <span class="number">0</span></span><br><span class="line">    <span class="attr">packages:</span></span><br><span class="line">      <span class="attr">trust-all:</span> <span class="literal">true</span></span><br><span class="line">  <span class="attr">jms:</span></span><br><span class="line">    <span class="attr">pub-sub-domain:</span> <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<h4 id="Config类"><a href="#Config类" class="headerlink" title="Config类"></a>Config类</h4><p>用于生产ConnectionFactory</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.arika;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.jms.ConnectionFactory;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Bean;</span><br><span class="line"><span class="keyword">import</span> org.springframework.context.annotation.Configuration;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.annotation.EnableJms;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.config.DefaultJmsListenerContainerFactory;</span><br><span class="line"><span class="keyword">import</span> org.springframework.jms.config.JmsListenerContainerFactory;</span><br><span class="line"></span><br><span class="line"><span class="meta">@Configuration</span></span><br><span class="line"><span class="meta">@EnableJms</span></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ActiveMqConfig</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">	 <span class="meta">@Bean</span></span><br><span class="line">	    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerTopic(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">	        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">	        bean.setPubSubDomain(<span class="keyword">true</span>);</span><br><span class="line">	        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">	        <span class="keyword">return</span> bean;</span><br><span class="line">	    &#125;</span><br><span class="line">	    <span class="comment">// queue模式的ListenerContainer</span></span><br><span class="line">	    <span class="meta">@Bean</span></span><br><span class="line">	    <span class="keyword">public</span> JmsListenerContainerFactory&lt;?&gt; jmsListenerContainerQueue(ConnectionFactory activeMQConnectionFactory) &#123;</span><br><span class="line">	        DefaultJmsListenerContainerFactory bean = <span class="keyword">new</span> DefaultJmsListenerContainerFactory();</span><br><span class="line">	        bean.setConnectionFactory(activeMQConnectionFactory);</span><br><span class="line">	        <span class="keyword">return</span> bean;</span><br><span class="line">	    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h4 id="收"><a href="#收" class="headerlink" title="收"></a>收</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@JmsListener(destination &#x3D; &quot;user&quot;,containerFactory &#x3D; &quot;jmsListenerContainerQueue&quot;)</span><br><span class="line">   public void receiveStringQueue(String msg) &#123;</span><br><span class="line">       System.out.println(&quot;接收到消息....&quot; + msg);</span><br><span class="line">   &#125;</span><br><span class="line"></span><br><span class="line">@JmsListener(destination &#x3D; &quot;ooo&quot;,containerFactory &#x3D; &quot;jmsListenerContainerTopic&quot;)</span><br><span class="line">   public void receiveStringTopic(String msg) &#123;</span><br><span class="line">    System.out.println(&quot;接收到消息....&quot; + msg);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="发"><a href="#发" class="headerlink" title="发"></a>发</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line">package com.mashibing.arika;</span><br><span class="line"></span><br><span class="line">import java.util.ArrayList;</span><br><span class="line"></span><br><span class="line">import javax.jms.Connection;</span><br><span class="line">import javax.jms.ConnectionFactory;</span><br><span class="line">import javax.jms.JMSException;</span><br><span class="line">import javax.jms.Message;</span><br><span class="line">import javax.jms.MessageProducer;</span><br><span class="line">import javax.jms.Queue;</span><br><span class="line">import javax.jms.Session;</span><br><span class="line">import javax.jms.TextMessage;</span><br><span class="line"></span><br><span class="line">import org.apache.activemq.command.ActiveMQQueue;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.jms.core.JmsMessagingTemplate;</span><br><span class="line">import org.springframework.jms.core.JmsTemplate;</span><br><span class="line">import org.springframework.jms.core.MessageCreator;</span><br><span class="line">import org.springframework.scheduling.annotation.Scheduled;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MqProducerService &#123;</span><br><span class="line"></span><br><span class="line">	@Autowired</span><br><span class="line">	private JmsMessagingTemplate jmsMessagingTemplate;</span><br><span class="line">	</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">	public void sendStringQueue(String destination, String msg) &#123;</span><br><span class="line">		System.out.println(&quot;send...&quot;);</span><br><span class="line">		ActiveMQQueue queue &#x3D; new ActiveMQQueue(destination);</span><br><span class="line">		jmsMessagingTemplate.afterPropertiesSet();</span><br><span class="line">		</span><br><span class="line">		ConnectionFactory factory &#x3D; jmsMessagingTemplate.getConnectionFactory();</span><br><span class="line">		</span><br><span class="line">		try &#123;</span><br><span class="line">			Connection connection &#x3D; factory.createConnection();</span><br><span class="line">			connection.start();</span><br><span class="line">			</span><br><span class="line">			Session session &#x3D; connection.createSession(true, Session.AUTO_ACKNOWLEDGE);</span><br><span class="line">			Queue queue2 &#x3D; session.createQueue(destination);</span><br><span class="line">			</span><br><span class="line">			MessageProducer producer &#x3D; session.createProducer(queue2);</span><br><span class="line">			</span><br><span class="line">			TextMessage message &#x3D; session.createTextMessage(&quot;hahaha&quot;);</span><br><span class="line">			</span><br><span class="line">			</span><br><span class="line">			producer.send(message);</span><br><span class="line">		&#125; catch (JMSException e) &#123;</span><br><span class="line">			&#x2F;&#x2F; TODO Auto-generated catch block</span><br><span class="line">			e.printStackTrace();</span><br><span class="line">		&#125;</span><br><span class="line">		</span><br><span class="line">		jmsMessagingTemplate.convertAndSend(queue, msg);</span><br><span class="line">	&#125;</span><br><span class="line">	public void sendStringQueueList(String destination, String msg) &#123;</span><br><span class="line">		System.out.println(&quot;xxooq&quot;);</span><br><span class="line">		ArrayList&lt;String&gt; list &#x3D; new ArrayList&lt;&gt;();</span><br><span class="line">		list.add(&quot;1&quot;);</span><br><span class="line">		list.add(&quot;2&quot;);</span><br><span class="line">		jmsMessagingTemplate.convertAndSend(new ActiveMQQueue(destination), list);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="Linux下安装"><a href="#Linux下安装" class="headerlink" title="Linux下安装"></a>Linux下安装</h2><p><strong>下载</strong></p>
<p><strong>解压</strong></p>
<p>在<code>init.d</code>下建立软连接</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ln -s &#x2F;usr&#x2F;local&#x2F;activemq&#x2F;bin&#x2F;activemq .&#x2F;</span><br></pre></td></tr></table></figure>

<p><strong>设置开启启动</strong></p>
<p><code>chkconfig activemq on</code></p>
<p>服务管理</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">service activemq start</span><br><span class="line">service activemq status</span><br><span class="line">service activemq stop</span><br></pre></td></tr></table></figure>

<h3 id="NIO配置"><a href="#NIO配置" class="headerlink" title="NIO配置"></a>NIO配置</h3><p>默认配置为tcp，使用的是bio</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnector name&#x3D;&quot;openwire&quot; uri&#x3D;&quot;tcp:&#x2F;&#x2F;0.0.0.0:61616?maximumConnections&#x3D;1000&amp;wireFormat.maxFrameSize&#x3D;104857600&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p><a href="http://activemq.apache.org/configuring-version-5-transports" target="_blank" rel="noopener">http://activemq.apache.org/configuring-version-5-transports</a></p>
<p>Nio是基于TCP的</p>
<p>客户端使用连接时也应使用nio</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory connectionFactory &#x3D; new ActiveMQConnectionFactory(</span><br><span class="line">		&quot;admin&quot;,</span><br><span class="line">		&quot;admin&quot;,</span><br><span class="line">		&quot;nio:&#x2F;&#x2F;localhost:61617&quot;</span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<p>Auto + Nio</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnector name&#x3D;&quot;auto+nio&quot; uri&#x3D;&quot;auto+nio:&#x2F;&#x2F;localhost:5671&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>

<p>自动适配协议</p>
<h3 id="OpenWire-可用配置选项"><a href="#OpenWire-可用配置选项" class="headerlink" title="OpenWire 可用配置选项"></a>OpenWire 可用配置选项</h3><table>
<thead>
<tr>
<th>Option</th>
<th>Default</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>cacheEnabled</code></td>
<td><code>true</code></td>
<td>Should commonly repeated values be cached so that less marshaling occurs?</td>
</tr>
<tr>
<td><code>cacheSize</code></td>
<td><code>1024</code></td>
<td>When <code>cacheEnabled=true</code> then this parameter is used to specify the number of values to be cached.</td>
</tr>
<tr>
<td><code>maxInactivityDuration</code></td>
<td><code>30000</code></td>
<td>The maximum <a href="http://activemq.apache.org/activemq-inactivitymonitor" target="_blank" rel="noopener">inactivity</a> duration (before which the socket is considered dead) in milliseconds. On some platforms it can take a long time for a socket to die. Therefore allow the broker to kill connections when they have been inactive for the configured period of time. Used by some transports to enable a keep alive heart beat feature. Inactivity monitoring is disabled when set to a value <code>&lt;= 0</code>.</td>
</tr>
<tr>
<td><code>maxInactivityDurationInitalDelay</code></td>
<td><code>10000</code></td>
<td>The initial delay before starting <a href="http://activemq.apache.org/activemq-inactivitymonitor" target="_blank" rel="noopener">inactivity</a> checks. Yes, the word <code>&#39;Inital&#39;</code> is supposed to be misspelled like that.</td>
</tr>
<tr>
<td><code>maxFrameSize</code></td>
<td><code>MAX_LONG</code></td>
<td>Maximum allowed frame size. Can help help prevent OOM DOS attacks.</td>
</tr>
<tr>
<td><code>sizePrefixDisabled</code></td>
<td><code>false</code></td>
<td>Should the size of the packet be prefixed before each packet is marshaled?</td>
</tr>
<tr>
<td><code>stackTraceEnabled</code></td>
<td><code>true</code></td>
<td>Should the stack trace of exception that occur on the broker be sent to the client?</td>
</tr>
<tr>
<td><code>tcpNoDelayEnabled</code></td>
<td><code>true</code></td>
<td>Does not affect the wire format, but provides a hint to the peer that <code>TCP_NODELAY</code> should be enabled on the communications Socket.</td>
</tr>
<tr>
<td><code>tightEncodingEnabled</code></td>
<td><code>true</code></td>
<td>Should wire size be optimized over CPU usage?</td>
</tr>
</tbody></table>
<h3 id="Transport-可用配置选项"><a href="#Transport-可用配置选项" class="headerlink" title="Transport 可用配置选项"></a>Transport 可用配置选项</h3><table>
<thead>
<tr>
<th>Option Name</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>backlog</td>
<td>5000</td>
<td>Specifies the maximum number of connections waiting to be accepted by the transport server socket.</td>
</tr>
<tr>
<td>closeAsync</td>
<td>true</td>
<td>If <strong><code>true</code></strong> the socket close call happens asynchronously. This parameter should be set to <strong><code>false</code></strong> for protocols like STOMP, that are commonly used in situations where a new connection is created for each read or write. Doing so ensures the socket close call happens synchronously. A synchronous close prevents the broker from running out of available sockets owing to the rapid cycling of connections.</td>
</tr>
<tr>
<td>connectionTimeout</td>
<td>30000</td>
<td>If <strong><code>&gt;=1</code></strong> the value sets the connection timeout in milliseconds. A value of <strong><code>0</code></strong> denotes no timeout. Negative values are ignored.</td>
</tr>
<tr>
<td>daemon</td>
<td>false</td>
<td>If <strong><code>true</code></strong> the transport thread will run in daemon mode. Set this parameter to <strong><code>true</code></strong> when embedding the broker in a Spring container or a web container to allow the container to shut down correctly.</td>
</tr>
<tr>
<td>dynamicManagement</td>
<td>false</td>
<td>If <strong><code>true</code></strong> the <strong><code>TransportLogger</code></strong> can be managed by JMX.</td>
</tr>
<tr>
<td>ioBufferSize</td>
<td>8 * 1024</td>
<td>Specifies the size of the buffer to be used between the TCP layer and the OpenWire layer where <strong><code>wireFormat</code></strong> based marshaling occurs.</td>
</tr>
<tr>
<td>jmxPort</td>
<td>1099</td>
<td>(Client Only) Specifies the port that will be used by the JMX server to manage the <strong><code>TransportLoggers</code></strong>. This should only be set, via URI, by either a client producer or consumer as the broker creates its own JMX server. Specifying an alternate JMX port is useful for developers that test a broker and client on the same machine and need to control both via JMX.</td>
</tr>
<tr>
<td>keepAlive</td>
<td>false</td>
<td>If <strong><code>true</code>,</strong> enables <a href="http://tldp.org/HOWTO/TCP-Keepalive-HOWTOoverview" target="_blank" rel="noopener">TCP KeepAlive</a> on the broker connection to prevent connections from timing out at the TCP level. This should <em>not</em> be confused with <strong><code>KeepAliveInfo</code></strong> messages as used by the <strong><code>InactivityMonitor</code>.</strong></td>
</tr>
<tr>
<td>logWriterName</td>
<td>default</td>
<td>Sets the name of the <strong><code>org.apache.activemq.transport.LogWriter</code></strong> implementation to use. Names are mapped to classes in the <strong><code>resources/META-INF/services/org/apache/activemq/transport/logwriters</code></strong> directory.</td>
</tr>
<tr>
<td>maximumConnections</td>
<td>Integer.MAX_VALUE</td>
<td>The maximum number of sockets allowed for this broker.</td>
</tr>
<tr>
<td>minmumWireFormatVersion</td>
<td>0</td>
<td>The minimum remote <strong><code>wireFormat</code></strong> version that will be accepted (note the misspelling). Note: when the remote <strong><code>wireFormat</code></strong> version is lower than the configured minimum acceptable version an exception will be thrown and the connection attempt will be refused. A value of <strong><code>0</code></strong> denotes no checking of the remote <strong><code>wireFormat</code></strong> version.</td>
</tr>
<tr>
<td>socketBufferSize</td>
<td>64 * 1024</td>
<td>Sets the size, in bytes, for the accepted socket’s read and write buffers.</td>
</tr>
<tr>
<td>soLinger</td>
<td>Integer.MIN_VALUE</td>
<td>Sets the socket’s option <strong><code>soLinger</code></strong> when the value is <strong><code>&gt; -1</code></strong>. When set to <strong><code>-1</code></strong> the <strong><code>soLinger</code></strong> socket option is disabled.</td>
</tr>
<tr>
<td>soTimeout</td>
<td>0</td>
<td>Sets the socket’s read timeout in milliseconds. A value of <strong><code>0</code></strong> denotes no timeout.</td>
</tr>
<tr>
<td>soWriteTimeout</td>
<td>0</td>
<td>Sets the socket’s write timeout in milliseconds. If the socket write operation does not complete before the specified timeout, the socket will be closed. A value of <strong>0</strong> denotes no timeout.</td>
</tr>
<tr>
<td>stackSize</td>
<td>0</td>
<td>Set the stack size of the transport’s background reading thread. Must be specified in multiples of <strong><code>128K</code></strong>. A value of <strong><code>0</code></strong> indicates that this parameter is ignored.</td>
</tr>
<tr>
<td>startLogging</td>
<td>true</td>
<td>If <strong><code>true</code></strong> the <strong><code>TransportLogger</code></strong> object of the Transport stack will initially write messages to the log. This parameter is ignored unless <strong><code>trace=true</code></strong>.</td>
</tr>
<tr>
<td>tcpNoDelay</td>
<td>false</td>
<td>If <strong><code>true</code></strong> the socket’s option <strong><code>TCP_NODELAY</code></strong> is set. This disables Nagle’s algorithm for small packet transmission.</td>
</tr>
<tr>
<td>threadName</td>
<td>N/A</td>
<td>When this parameter is specified the name of the thread is modified during the invocation of a transport. The remote address is appended so that a call stuck in a transport method will have the destination information in the thread name. This is extremely useful when using thread dumps for degugging.</td>
</tr>
<tr>
<td>trace</td>
<td>false</td>
<td>Causes all commands that are sent over the transport to be logged. To view the logged output define the <strong><code>Log4j</code></strong> logger: <strong><code>log4j.logger.org.apache.activemq.transport.TransportLogger=DEBUG</code></strong>.</td>
</tr>
<tr>
<td>trafficClass</td>
<td>0</td>
<td>The Traffic Class to be set on the socket.</td>
</tr>
<tr>
<td>diffServ</td>
<td>0</td>
<td>(Client only) The preferred Differentiated Services traffic class to be set on outgoing packets, as described in RFC 2475. Valid integer values: <strong><code>[0,64]</code></strong>. Valid string values: <strong><code>EF</code>, <code>AF[1-3][1-4]</code></strong> or <strong><code>CS[0-7]</code></strong>. With JDK 6, only works when the JVM uses the IPv4 stack. To use the IPv4 stack set the system property <strong><code>java.net.preferIPv4Stack=true</code></strong>. Note: it’s invalid to specify both ‘<strong>diffServ</strong> and <strong>typeOfService</strong>’ at the same time as they share the same position in the TCP/IP packet headers</td>
</tr>
<tr>
<td>typeOfService</td>
<td>0</td>
<td>(Client only) The preferred Type of Service value to be set on outgoing packets. Valid integer values: <strong><code>[0,256]</code></strong>. With JDK 6, only works when the JVM is configured to use the IPv4 stack. To use the IPv4 stack set the system property <strong><code>java.net.preferIPv4Stack=true</code></strong>. Note: it’s invalid to specify both ‘<strong>diffServ</strong> and <strong>typeOfService</strong>’ at the same time as they share the same position in the TCP/IP packet headers.</td>
</tr>
<tr>
<td>useInactivityMonitor</td>
<td>true</td>
<td>When <strong><code>false</code></strong> the <strong><code>InactivityMonitor</code></strong> is disabled and connections will never time out.</td>
</tr>
<tr>
<td>useKeepAlive</td>
<td>true</td>
<td>When <strong><code>true</code> <code>KeepAliveInfo</code></strong> messages are sent on an idle connection to prevent it from timing out. If this parameter is <strong><code>false</code></strong> connections will still timeout if no data was received on the connection for the specified amount of time.</td>
</tr>
<tr>
<td>useLocalHost</td>
<td>false</td>
<td>When <strong><code>true</code></strong> local connections will be made using the value <strong><code>localhost</code></strong> instead of the actual local host name. On some operating systems, such as <strong><code>OS X</code></strong>, it’s not possible to connect as the local host name so <strong><code>localhost</code></strong> is better.</td>
</tr>
<tr>
<td>useQueueForAccept</td>
<td>true</td>
<td>When <strong><code>true</code></strong> accepted sockets are placed onto a queue for asynchronous processing using a separate thread.</td>
</tr>
<tr>
<td>wireFormat</td>
<td>default</td>
<td>The name of the <strong><code>wireFormat</code></strong> factory to use.</td>
</tr>
<tr>
<td>wireFormat.*</td>
<td>N/A</td>
<td>Properties with this prefix are used to configure the <strong><code>wireFormat</code></strong>.</td>
</tr>
</tbody></table>
<h2 id="ActiveMQ服务监控-Hawtio"><a href="#ActiveMQ服务监控-Hawtio" class="headerlink" title="ActiveMQ服务监控 Hawtio"></a>ActiveMQ服务监控 Hawtio</h2><h3 id="官方网站"><a href="#官方网站" class="headerlink" title="官方网站"></a>官方网站</h3><p><a href="https://hawt.io/" target="_blank" rel="noopener">https://hawt.io/</a></p>
<h3 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h3><h4 id="独立jar包的形式运行"><a href="#独立jar包的形式运行" class="headerlink" title="独立jar包的形式运行"></a>独立jar包的形式运行</h4><p>java -jar</p>
<p>hawtio单程序运行，可以对多个远程ActiveMQ服务器进行监控</p>
<h4 id="嵌入ActiveMQ"><a href="#嵌入ActiveMQ" class="headerlink" title="嵌入ActiveMQ"></a>嵌入ActiveMQ</h4><ul>
<li>下载war包</li>
<li>复制到webapps下</li>
</ul>
<p><strong>jetty.xml bean标签下添加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;bean class&#x3D;&quot;org.eclipse.jetty.webapp.WebAppContext&quot;&gt;        </span><br><span class="line">	&lt;property name&#x3D;&quot;contextPath&quot; value&#x3D;&quot;&#x2F;hawtio&quot; &#x2F;&gt;        </span><br><span class="line">	&lt;property name&#x3D;&quot;war&quot; value&#x3D;&quot;$&#123;activemq.home&#125;&#x2F;webapps&#x2F;hawtio.war&quot; &#x2F;&gt;        </span><br><span class="line">	&lt;property name&#x3D;&quot;logUrlOnStart&quot; value&#x3D;&quot;true&quot; &#x2F;&gt;  </span><br><span class="line">&lt;&#x2F;bean&gt;</span><br></pre></td></tr></table></figure>



<p><strong>ActiveMQ.bat下添加</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">if &quot;%ACTIVEMQ_OPTS%&quot; &#x3D;&#x3D; &quot;&quot; set ACTIVEMQ_OPTS&#x3D;-Xms1G -Xmx1G -Dhawtio.realm&#x3D;activemq -Dhawtio.role&#x3D;admins -Dhawtio.rolePrincipalClasses&#x3D;org.apache.activemq.jaas.GroupPrincipal -Djava.util.logging.config.file&#x3D;logging.properties -Djava.security.auth.login.config&#x3D;&quot;%ACTIVEMQ_CONF%\login.config&quot;</span><br></pre></td></tr></table></figure>



<h2 id="JMS消息结构（Message）"><a href="#JMS消息结构（Message）" class="headerlink" title="JMS消息结构（Message）"></a>JMS消息结构（Message）</h2><p>Message主要由三部分组成，分别是Header，Properties，Body， 详细如下：</p>
<table>
<thead>
<tr>
<th>Header</th>
<th>消息头，所有类型的这部分格式都是一样的</th>
</tr>
</thead>
<tbody><tr>
<td>Properties</td>
<td>属性，按类型可以分为应用设置的属性，标准属性和消息中间件定义的属性</td>
</tr>
<tr>
<td>Body</td>
<td>消息正文，指我们具体需要消息传输的内容。</td>
</tr>
</tbody></table>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>JMS消息头使用的所有方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">Message</span> </span>&#123;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">getJMSDestination</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSDestination</span><span class="params">(Destination destination)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getJMSDeliveryMode</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSDeliveryMode</span><span class="params">(<span class="keyword">int</span> deliveryMode)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJMSMessageID</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSMessageID</span><span class="params">(String id)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJMSTimestamp</span><span class="params">()</span> <span class="keyword">throws</span> JMSException'</span></span><br><span class="line"><span class="function">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSTimestamp</span><span class="params">(<span class="keyword">long</span> timestamp)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getJMSExpiration</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSExpiration</span><span class="params">(<span class="keyword">long</span> expiration)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">boolean</span> <span class="title">getJMSRedelivered</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSRedelivered</span><span class="params">(<span class="keyword">boolean</span> redelivered)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">int</span> <span class="title">getJMSPriority</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSPriority</span><span class="params">(<span class="keyword">int</span> priority)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> Destination <span class="title">getJMSReplyTo</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSReplyTo</span><span class="params">(Destination replyTo)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJMScorrelationID</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSCorrelationID</span><span class="params">(String correlationID)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">byte</span>[] getJMSCorrelationIDAsBytes() <span class="keyword">throws</span> JMSException;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSCorrelationIDAsBytes</span><span class="params">(<span class="keyword">byte</span>[] correlationID)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getJMSType</span><span class="params">()</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setJMSType</span><span class="params">(String type)</span> <span class="keyword">throws</span> JMSException</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p><strong>消息头分为自动设置和手动设置的内容</strong></p>
<h4 id="自动头信息"><a href="#自动头信息" class="headerlink" title="自动头信息"></a>自动头信息</h4><p>有一部分可以在创建Session和MessageProducer时设置</p>
<table>
<thead>
<tr>
<th>属性名称</th>
<th>说明</th>
<th>设置者</th>
</tr>
</thead>
<tbody><tr>
<td>JMSDeliveryMode</td>
<td>消息的发送模式，分为<strong>NON_PERSISTENT</strong>和<strong>PERSISTENT</strong>，即非持久性模式的和持久性模式。默认设置为<strong>PERSISTENT（持久性）。</strong>一条<strong>持久性消息</strong>应该被传送一次（就一次），这就意味着如果JMS提供者出现故障，该消息并不会丢失； 它会在服务器恢复正常之后再次传送。一条<strong>非持久性消息</strong>最多只会传送一次，这意味着如果JMS提供者出现故障，该消息可能会永久丢失。在持久性和非持久性这两种传送模式中，消息服务器都不会将一条消息向同一消息者发送一次以上（成功算一次）。</td>
<td>send</td>
</tr>
<tr>
<td>JMSMessageID</td>
<td>消息ID，需要以ID:开头，用于唯一地标识了一条消息</td>
<td>send</td>
</tr>
<tr>
<td>JMSTimestamp</td>
<td>消息发送时的时间。这条消息头用于确定发送消息和它被消费者实际接收的时间间隔。时间戳是一个以毫秒来计算的Long类型时间值（自1970年1月1日算起）。</td>
<td>send</td>
</tr>
<tr>
<td>JMSExpiration</td>
<td>消息的过期时间，以毫秒为单位，用来防止把过期的消息传送给消费者。任何直接通过编程方式来调用setJMSExpiration()方法都会被忽略。</td>
<td>send</td>
</tr>
<tr>
<td>JMSRedelivered</td>
<td>消息是否重复发送过，如果该消息之前发送过，那么这个属性的值需要被设置为true, 客户端可以根据这个属性的值来确认这个消息是否重复发送过，以避免重复处理。</td>
<td>Provider</td>
</tr>
<tr>
<td>JMSPriority</td>
<td>消息的优先级,0-4为普通的优化级，而5-9为高优先级，通常情况下，高优化级的消息需要优先发送。任何直接通过编程方式调用setJMSPriority()方法都将被忽略。</td>
<td>send</td>
</tr>
<tr>
<td>JMSDestination</td>
<td>消息发送的目的地，是一个Topic或Queue</td>
<td>send</td>
</tr>
</tbody></table>
<p><strong>JMSDeliveryMode</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(topic);</span><br><span class="line">producer.setDeliveryMode(DeliveryMode.NON_PERSISTENT);</span><br></pre></td></tr></table></figure>

<p><strong>JMSExpiration</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//将过期时间设置为1小时（1000毫秒 ＊60 ＊60）</span></span><br><span class="line">producer.setTimeToLive(<span class="number">1000</span> * <span class="number">60</span> * <span class="number">60</span>);</span><br></pre></td></tr></table></figure>

<p><strong>JMSPriority</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">producer.setPriority(9);</span><br></pre></td></tr></table></figure>



<h4 id="手动头信息"><a href="#手动头信息" class="headerlink" title="手动头信息"></a>手动头信息</h4><table>
<thead>
<tr>
<th>属性名称</th>
<th>说明</th>
<th>设置者</th>
</tr>
</thead>
<tbody><tr>
<td>JMSCorrelationID</td>
<td>关联的消息ID，这个通常用在需要回传消息的时候</td>
<td>client</td>
</tr>
<tr>
<td>JMSReplyTo</td>
<td>消息回复的目的地，其值为一个Topic或Queue, 这个由发送者设置，但是接收者可以决定是否响应</td>
<td>client</td>
</tr>
<tr>
<td>JMSType</td>
<td>由消息发送者设置的消息类型，代表消息的结构，有的消息中间件可能会用到这个，但这个并不是是批消息的种类，比如TextMessage之类的</td>
<td>client</td>
</tr>
</tbody></table>
<p>从上表中我们可以看到，系统提供的标准头信息一共有10个属性，其中有6个是由send方法在调用时设置的，有三个是由客户端（client）设置的，还有一个是由消息中间件（Provider）设置的。</p>
<p>需要注意的是，这里</p>
<h2 id="下一代-ActiveMQ-6？Artemis"><a href="#下一代-ActiveMQ-6？Artemis" class="headerlink" title="下一代 ActiveMQ 6？Artemis"></a>下一代 ActiveMQ 6？Artemis</h2><p>为下一代事件驱动的消息传递应用程序提供高性能、无阻塞的体系结构。</p>
<ul>
<li>包含JNDI，具有完整的JMS 1.1 &amp; 2.0客户端实现</li>
<li>高可用性共享存储、网络复制能力</li>
<li>简单而强大的寻址模型协议</li>
<li>灵活的负载均衡分配能力</li>
<li>针对低延迟持久性和JDBC的高级日志实现</li>
<li>与ActiveMQ 5的高功能奇偶校验，以简化迁移</li>
</ul>
<p>官方文档：<a href="http://activemq.apache.org/components/artemis/migration" target="_blank" rel="noopener">http://activemq.apache.org/components/artemis/migration</a></p>
<ul>
<li>netty</li>
<li>自己的存储</li>
<li>优化传输流程</li>
<li>更高的性能</li>
<li>不再把所有的协议转换成openwire</li>
</ul>
<h2 id="高级使用"><a href="#高级使用" class="headerlink" title="高级使用"></a>高级使用</h2><h3 id="JMSCorrelationID"><a href="#JMSCorrelationID" class="headerlink" title="JMSCorrelationID"></a>JMSCorrelationID</h3><p>用于消息之间的关联，给人一种会话的感觉</p>
<hr>
<h3 id="JMSReplyTo"><a href="#JMSReplyTo" class="headerlink" title="JMSReplyTo"></a><strong>JMSReplyTo</strong></h3><p>发送方可以接受到消息消费确认的地址</p>
<p>ActiveMQ5.10.x 以上版本必须使用 JDK1.8 才能正常使用。 </p>
<p>ActiveMQ5.9.x 及以下版本使用 JDK1.7 即可正常使用。</p>
<h2 id="面试题"><a href="#面试题" class="headerlink" title="面试题"></a>面试题</h2><h3 id="ActiveMQ如何防止消息丢失？会不会丢消息？"><a href="#ActiveMQ如何防止消息丢失？会不会丢消息？" class="headerlink" title="ActiveMQ如何防止消息丢失？会不会丢消息？"></a>ActiveMQ如何防止消息丢失？会不会丢消息？</h3><p>做高可用</p>
<p>死信队列</p>
<p>持久化</p>
<p>ack</p>
<p>消息重投</p>
<p>记录日志</p>
<p>接收（消费）确认</p>
<p>broker负载/限流</p>
<h3 id="如何防止重复消费？"><a href="#如何防止重复消费？" class="headerlink" title="如何防止重复消费？"></a>如何防止重复消费？</h3><p>消息幂等处理</p>
<p>map <em>ConcurrentHashMap</em> -&gt; putIfAbsent   guava cache</p>
<h3 id="如何保证消费顺序？"><a href="#如何保证消费顺序？" class="headerlink" title="如何保证消费顺序？"></a>如何保证消费顺序？</h3><p>queue 优先级别设置</p>
<p>多消费端 -&gt; </p>
<h1 id="3-高级使用"><a href="#3-高级使用" class="headerlink" title="3. 高级使用"></a>3. 高级使用</h1><h3 id="queue-browser"><a href="#queue-browser" class="headerlink" title="queue browser"></a>queue browser</h3><p>可以查看队列中的消息而不消费，没有订阅的功能</p>
<h3 id="JMSCorrelationID-1"><a href="#JMSCorrelationID-1" class="headerlink" title="JMSCorrelationID"></a>JMSCorrelationID</h3><p>用于消息之间的关联，给人一种会话的感觉</p>
<p><a href="http://activemq.apache.org/how-should-i-implement-request-response-with-jms.html" target="_blank" rel="noopener">http://activemq.apache.org/how-should-i-implement-request-response-with-jms.html</a></p>
<hr>
<h3 id="JMSReplyTo-1"><a href="#JMSReplyTo-1" class="headerlink" title="JMSReplyTo"></a><strong>JMSReplyTo</strong></h3><p>发送方可以接受到消息消费确认的地址</p>
<h3 id="QueueRequestor同步消息"><a href="#QueueRequestor同步消息" class="headerlink" title="QueueRequestor同步消息"></a>QueueRequestor同步消息</h3><p>可以发送同步消息</p>
<p>本质违背了mq的异步通讯原则</p>
<p>但是mq还是能够提供应用解耦、异构系统的特性</p>
<p>因为使用QueueRequestor发送消息后，会等待接收端的回复，如果收不到回复就会造成死等现象!而且该方法没有设置超时等待的功能 </p>
<h3 id="生产环境中影响性能的几个因素"><a href="#生产环境中影响性能的几个因素" class="headerlink" title="生产环境中影响性能的几个因素"></a>生产环境中影响性能的几个因素</h3><h4 id="Out-of-memory"><a href="#Out-of-memory" class="headerlink" title="Out of memory"></a>Out of memory</h4><p>activemq启动脚本中配置内存</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">%ACTIVEMQ_OPTS%&quot; &#x3D;&#x3D; &quot;&quot; set ACTIVEMQ_OPTS&#x3D;-Xms1G -Xmx1G</span><br></pre></td></tr></table></figure>



<p>以及配置文件中的百分比</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;memoryUsage percentOfJvmHeap&#x3D;&quot;70&quot; &#x2F;&gt;</span><br></pre></td></tr></table></figure>



<p>SystemUsage配置设置了一些系统内存和硬盘容量，当系统消耗超过这些容量设置时，amq会“slow down producer”，还是很重要的。</p>
<h4 id="持久化和非持久化"><a href="#持久化和非持久化" class="headerlink" title="持久化和非持久化"></a>持久化和非持久化</h4><h4 id="消息异步发送"><a href="#消息异步发送" class="headerlink" title="消息异步发送"></a>消息异步发送</h4><p>建议使用默认，强制开启有可能丢失消息</p>
<p>异步发送丢失消息的场景是：生产者设置UseAsyncSend=true，使用producer.send(msg)持续发送消息。由于消息不阻塞，生产者会认为所有send的消息均被成功发送至MQ。如果服务端突然宕机，此时生产者端内存中尚未被发送至MQ的消息都会丢失。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new ActiveMQConnectionFactory(&quot;tcp:&#x2F;&#x2F;locahost:61616?jms.useAsyncSend&#x3D;true&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnectionFactory)connectionFactory).setUseAsyncSend(true);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnection)connection).setUseAsyncSend(true)</span><br></pre></td></tr></table></figure>



<h4 id="批量确认"><a href="#批量确认" class="headerlink" title="批量确认"></a>批量确认</h4><p>ActiveMQ缺省支持批量确认消息，批量确认可以提高系统性能</p>
<p><strong>关闭方法</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">new ActiveMQConnectionFactory(&quot;tcp:&#x2F;&#x2F;locahost:61616?jms.optimizeAcknowledge&#x3D;false&quot;);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnectionFactory)connectionFactory).setOptimizeAcknowledge(fase);</span><br></pre></td></tr></table></figure>

<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">((ActiveMQConnection)connection).setOptimizeAcknowledge(true);</span><br></pre></td></tr></table></figure>



<h3 id="消费缓冲与消息积压prefetchSize"><a href="#消费缓冲与消息积压prefetchSize" class="headerlink" title="消费缓冲与消息积压prefetchSize"></a>消费缓冲与消息积压prefetchSize</h3><p>消费者端，一般来说消费的越快越好，broker的积压越小越好。</p>
<p>但是考虑到事务性和客户端确认的情况，如果一个消费者一次获取到了很多消息却都不确认，这会造成事务上下文变大，broker端这种“半消费状态”的数据变多，所以ActiveMQ有一个prefetchSize参数来控制未确认情况下，最多可以预获取多少条记录。</p>
<p><strong>Pre-fetch默认值</strong></p>
<table>
<thead>
<tr>
<th>consumer type</th>
<th>default value</th>
</tr>
</thead>
<tbody><tr>
<td>queue</td>
<td>1000</td>
</tr>
<tr>
<td>queue browser</td>
<td>500</td>
</tr>
<tr>
<td>topic</td>
<td>32766</td>
</tr>
<tr>
<td>durable topic</td>
<td>1000</td>
</tr>
</tbody></table>
<h4 id="可以通过3中方式设置prefetchSize"><a href="#可以通过3中方式设置prefetchSize" class="headerlink" title="可以通过3中方式设置prefetchSize"></a>可以通过3中方式设置prefetchSize</h4><p><strong>创建连接时整体设置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory connectio nFactory &#x3D; new ActiveMQConnectionFactory(</span><br><span class="line">			&quot;admin&quot;,</span><br><span class="line">			&quot;admin&quot;,</span><br><span class="line">			&quot;tcp:&#x2F;&#x2F;localhost:5671?jms.prefetchPolicy.all&#x3D;50&quot;</span><br><span class="line">			);</span><br></pre></td></tr></table></figure>

<p><strong>创建连接时对topic和queue单独设置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory connectionFactory &#x3D; new ActiveMQConnectionFactory(</span><br><span class="line">		&quot;admin&quot;,</span><br><span class="line">		&quot;admin&quot;,</span><br><span class="line">		&quot;tcp:&#x2F;&#x2F;localhost:5671?jms.prefetchPolicy.queuePrefetch&#x3D;1&amp;jms.prefetchPolicy.topicPrefetch&#x3D;1&quot;</span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<p><strong>针对destination单独设置</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Destination topic &#x3D; session.createTopic(&quot;user?consumer.prefetchSize&#x3D;10&quot;);</span><br></pre></td></tr></table></figure>



<p>注意：对destination设置prefetchsize后会覆盖连接时的设置值</p>
<h3 id="消息到底是推还是拉"><a href="#消息到底是推还是拉" class="headerlink" title="消息到底是推还是拉?"></a>消息到底是推还是拉?</h3><p>发送消息时是推向broker</p>
<p>获取消息时：</p>
<ul>
<li>默认是一条一条的推</li>
<li>当customer的prefetchSize满的时候停止推消息</li>
<li>当customer的prefetchSize ==0时 拉取消息</li>
</ul>
<h3 id="EIP-Enterprise-Integration-Patterns"><a href="#EIP-Enterprise-Integration-Patterns" class="headerlink" title="EIP Enterprise Integration Patterns."></a>EIP Enterprise Integration Patterns.</h3><p>EIP系统是以数据为基础，应用为核心，以实现业务及业务流程的自动化为目的多功能企业信息平台。为企业的信息化建设提供一种循序渐进，逐步优化的路径</p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200207162242385.png" alt="image-20200207162242385"></p>
<p>一个围绕消息集成的企业应用集成场景基本在上面的图中描述的比较清楚的，简单说明如下</p>
<p>1)消息发送方和接收方：可以是异构的业务系统，但是都需要提供Endpoint实现集成。<br>2)消息本身：两个应用系统通过channel连接，实现了消息本身的发送和接收操作<br>3)消息Channel：即消息传输的通道，消息本身必须要通过channel来实现传输，从源到达目标。<br>4)消息路由：当有多个目标接收方的时候，如果根据消息的特征来确定究竟发送到哪个接收方？<br>5)消息转换：消息在传输过程中是否需要进行转换和数据映射，包括报文格式转换和内容转换映射。<br>6)Pipe and Filter：在执行复杂的消息流处理时，如何维护消息本身的独立性和灵活性。</p>
<p>常用实现Camel</p>
<p>支持ActiveMQ、RabbitMQ、kafka、WebService</p>
<p><strong>camel实现了客户端与服务端的解耦， 生产者和消费者的解耦。</strong></p>
<h2 id="Request-Response模型实现"><a href="#Request-Response模型实现" class="headerlink" title="Request/Response模型实现"></a>Request/Response模型实现</h2><h3 id="QueueRequestor"><a href="#QueueRequestor" class="headerlink" title="QueueRequestor"></a>QueueRequestor</h3><p>同步阻塞</p>
<h3 id="TemporaryQueue"><a href="#TemporaryQueue" class="headerlink" title="TemporaryQueue"></a>TemporaryQueue</h3><p>异步监听，当消息过多时会创建响应的临时queue</p>
<h3 id="JMSCorrelationID-消息属性"><a href="#JMSCorrelationID-消息属性" class="headerlink" title="JMSCorrelationID 消息属性"></a>JMSCorrelationID 消息属性</h3><p>异步监听，公用queue</p>
<h2 id="调优总结"><a href="#调优总结" class="headerlink" title="调优总结"></a>调优总结</h2><h3 id="Topic加强-可追溯消息"><a href="#Topic加强-可追溯消息" class="headerlink" title="Topic加强 可追溯消息"></a>Topic加强 可追溯消息</h3><p><a href="http://activemq.apache.org/retroactive-consumer.html" target="_blank" rel="noopener">http://activemq.apache.org/retroactive-consumer.html</a></p>
<p>避免topic下错过消息</p>
<h4 id="消费者设置"><a href="#消费者设置" class="headerlink" title="消费者设置"></a>消费者设置</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Destination topic &#x3D; session.createTopic(&quot;tpk?consumer.retroactive&#x3D;true&quot;);</span><br></pre></td></tr></table></figure>

<h3 id="Summary-of-Available-Recovery-Policies"><a href="#Summary-of-Available-Recovery-Policies" class="headerlink" title="Summary of Available Recovery Policies"></a>Summary of Available Recovery Policies</h3><table>
<thead>
<tr>
<th>Policy Name</th>
<th>Sample Configuration</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td>FixedSizedSubscriptionRecoveryPolicy</td>
<td><fixedSizedSubscriptionRecoveryPolicy maximumsize="1024"></fixedSizedSubscriptionRecoveryPolicy></td>
<td>Keep a fixed amount of memory in RAM for message history which is evicted in time order.</td>
</tr>
<tr>
<td>FixedCountSubscriptionRecoveryPolicy</td>
<td><fixedCountSubscriptionRecoveryPolicy maximumsize="100"></fixedCountSubscriptionRecoveryPolicy></td>
<td>Keep a fixed count of last messages.</td>
</tr>
<tr>
<td>LastImageSubscriptionRecoveryPolicy</td>
<td><lastImageSubscriptionRecoveryPolicy></lastImageSubscriptionRecoveryPolicy></td>
<td>Keep only the last message.</td>
</tr>
<tr>
<td>NoSubscriptionRecoveryPolicy</td>
<td><noSubscriptionRecoveryPolicy></noSubscriptionRecoveryPolicy></td>
<td>Disables message recovery.</td>
</tr>
<tr>
<td>QueryBasedSubscriptionRecoveryPolicy</td>
<td><queryBasedSubscriptionRecoveryPolicy query="JMSType = 'car' AND color = 'blue'"></queryBasedSubscriptionRecoveryPolicy></td>
<td>Perform a user specific query mechanism to load any message they may have missed. Details on message selectors are available <a href="http://java.sun.com/j2ee/1.4/docs/api/javax/jms/Message.html" target="_blank" rel="noopener">here</a></td>
</tr>
<tr>
<td>TimedSubscriptionRecoveryPolicy</td>
<td><timedSubscriptionRecoveryPolicy recoverduration="60000"></timedSubscriptionRecoveryPolicy></td>
<td>Keep a timed buffer of messages around in memory and use that to recover new subscriptions. Recovery time is in milliseconds.</td>
</tr>
<tr>
<td>RetainedMessageSubscriptionRecoveryPolicy</td>
<td><retainedMessageSubscriptionRecoveryPolicy></retainedMessageSubscriptionRecoveryPolicy></td>
<td>Keep the last message with ActiveMQ.Retain property set to true</td>
</tr>
</tbody></table>
<h4 id="保留固定字节的消息"><a href="#保留固定字节的消息" class="headerlink" title="保留固定字节的消息"></a>保留固定字节的消息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;policyEntry topic&#x3D;&quot;&gt;&quot;&gt;</span><br><span class="line">	&lt;subscriptionRecoveryPolicy&gt;</span><br><span class="line">		&lt;fixedSizedSubscriptionRecoveryPolicy maximumSize&#x3D;&quot;1024&quot;&#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;subscriptionRecoveryPolicy&gt;</span><br><span class="line">&lt;&#x2F;policyEntry&gt;</span><br></pre></td></tr></table></figure>

<h4 id="保留固定数量的消息"><a href="#保留固定数量的消息" class="headerlink" title="保留固定数量的消息"></a>保留固定数量的消息</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;policyEntry topic&#x3D;&quot;&gt;&quot;&gt;</span><br><span class="line">	&lt;subscriptionRecoveryPolicy&gt;</span><br><span class="line">		&lt;fixedCountSubscriptionRecoveryPolicy maximumSize&#x3D;&quot;100&quot;&#x2F;&gt;</span><br><span class="line">	&lt;&#x2F;subscriptionRecoveryPolicy&gt;</span><br><span class="line">&lt;&#x2F;policyEntry&gt;</span><br></pre></td></tr></table></figure>

<h4 id="保留时间"><a href="#保留时间" class="headerlink" title="保留时间"></a>保留时间</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;subscriptionRecoveryPolicy&gt;</span><br><span class="line">	&lt;timedSubscriptionRecoveryPolicy recoverDuration&#x3D;&quot;60000&quot; &#x2F;&gt; </span><br><span class="line">	&lt;&#x2F;subscriptionRecoveryPolicy&gt;</span><br></pre></td></tr></table></figure>



<h4 id="保留最后一条"><a href="#保留最后一条" class="headerlink" title="保留最后一条"></a>保留最后一条</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;subscriptionRecoveryPolicy&gt;</span><br><span class="line">&lt;lastImageSubscriptionRecoveryPolicy&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;subscriptionRecoveryPolicy&gt;</span><br></pre></td></tr></table></figure>

<h3 id="慢速消费"><a href="#慢速消费" class="headerlink" title="慢速消费"></a>慢速消费</h3><h4 id="SlowConsumerStrategy"><a href="#SlowConsumerStrategy" class="headerlink" title="SlowConsumerStrategy"></a>SlowConsumerStrategy</h4><p>对于慢消费者，broker会启动一个后台线程用来检测所有的慢速消费者，并定期的关闭慢消费者。<br> <strong>AbortSlowConsumerStrategy abortConnection</strong>：中断慢速消费者，慢速消费将会被关闭。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slowConsumerStrategy</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">abortSlowConsumerStrategy</span> <span class="attr">abortConnection</span>=<span class="string">"false"</span>/&gt;</span><span class="comment">&lt;!-- 不关闭底层链接 --&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">slowConsumerStrategy</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> <strong>AbortSlowConsumerStrategy maxTimeSinceLastAck</strong>：如果慢速消费者最后一个ACK距离现在的时间间隔超过阀值，则中断慢速消费者。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">slowConsumerStrategy</span>&gt;</span>    </span><br><span class="line">    <span class="tag">&lt;<span class="name">abortSlowConsumerStrategy</span>  <span class="attr">maxTimeSinceLastAck</span>=<span class="string">"30000"</span>/&gt;</span><span class="comment">&lt;!-- 30秒滞后 --&gt;</span>    </span><br><span class="line"><span class="tag">&lt;/<span class="name">slowConsumerStrategy</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="PendingMessageLimitStrategy：消息限制策略（面向慢消费者）"><a href="#PendingMessageLimitStrategy：消息限制策略（面向慢消费者）" class="headerlink" title="PendingMessageLimitStrategy：消息限制策略（面向慢消费者）"></a>PendingMessageLimitStrategy：消息限制策略（面向慢消费者）</h4><p><a href="http://activemq.apache.org/slow-consumer-handling" target="_blank" rel="noopener">http://activemq.apache.org/slow-consumer-handling</a></p>
<p>  此策略只对Topic有效，只对未持久化订阅者有效，当通道中有大量的消息积压时，broker可以保留的消息量。为了防止Topic中有慢速消费者，导致整个通道消息积压。<br><strong>ConstantPendingMessageLimitStrategy</strong>：保留固定条数的消息，如果消息量超过limit，将使用<strong>消息剔除策略</strong>移除消息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">policyEntry</span> <span class="attr">topic</span>=<span class="string">"ORDERS.&gt;"</span>&gt;</span>  </span><br><span class="line">    <span class="comment">&lt;!-- lets force old messages to be discarded for slow consumers --&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;<span class="name">pendingMessageLimitStrategy</span>&gt;</span>  </span><br><span class="line">        <span class="tag">&lt;<span class="name">constantPendingMessageLimitStrategy</span> <span class="attr">limit</span>=<span class="string">"50"</span>/&gt;</span>  </span><br><span class="line">    <span class="tag">&lt;/<span class="name">pendingMessageLimitStrategy</span>&gt;</span>  </span><br><span class="line"><span class="tag">&lt;/<span class="name">policyEntry</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p> <strong>PrefetchRatePendingMessageLimitStrategy</strong>：保留prefetchSize倍数条消息。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">&lt;!-- 若prefetchSize为100，则保留2.5 * 100条消息 --&gt;</span>  </span><br><span class="line"><span class="tag">&lt;<span class="name">prefetchRatePendingMessageLimitStrategy</span> <span class="attr">multiplier</span>=<span class="string">"2.5"</span>/&gt;</span></span><br></pre></td></tr></table></figure>







<h3 id="消息堆积内存上涨"><a href="#消息堆积内存上涨" class="headerlink" title="消息堆积内存上涨"></a>消息堆积内存上涨</h3><ul>
<li>检查消息是否持久化</li>
<li>检查消息 消费速度与生产速度</li>
<li>调整xms xmx参数</li>
</ul>
<h3 id="磁盘满"><a href="#磁盘满" class="headerlink" title="磁盘满"></a>磁盘满</h3><p>当非持久化消息堆积到一定程度，ActiveMQ会将非持久化消息写入临时文件，但是在重启的时候不会恢复</p>
<p>当存储持久化数据的磁盘满了的时候</p>
<p><strong>持久化消息</strong></p>
<p>生产者阻塞，消费正常，当消费一部分消息后，腾出空间，生产者继续</p>
<p><strong>非持久化消息</strong></p>
<p>由于临时文件造成磁盘满了，生产者阻塞，消费异常，无法提供服务</p>
<h3 id="开启事务"><a href="#开启事务" class="headerlink" title="开启事务"></a>开启事务</h3><p>在发送非持久化消息的时候，可以有效防止消息丢失</p>
<h3 id="prefetchSize影响消费倾斜"><a href="#prefetchSize影响消费倾斜" class="headerlink" title="prefetchSize影响消费倾斜"></a>prefetchSize影响消费倾斜</h3><p>慢速消费的时候可以将prefetchSize设为1，每次取一条</p>
<h3 id="prefetchSize造成消费者内存溢出"><a href="#prefetchSize造成消费者内存溢出" class="headerlink" title="prefetchSize造成消费者内存溢出"></a>prefetchSize造成消费者内存溢出</h3><h3 id="AUTO-ACKNOWLEDGE造成消息丢失-乱序"><a href="#AUTO-ACKNOWLEDGE造成消息丢失-乱序" class="headerlink" title="AUTO_ACKNOWLEDGE造成消息丢失/乱序"></a>AUTO_ACKNOWLEDGE造成消息丢失/乱序</h3><p>消息消费失败后，无法复原消息，可以手动ack 避免broker把消息自动确认删除</p>
<p>receive()方法接受到消息后立即确认</p>
<p>listener 的onmessage方法执行完毕才会确认</p>
<p>手动ack的时候要等connection断开 才会重新推送给其他的consumer，所以有可能会导致消费顺序错乱</p>
<h3 id="exclusive-和selector有可能造成消息堆积"><a href="#exclusive-和selector有可能造成消息堆积" class="headerlink" title="exclusive 和selector有可能造成消息堆积"></a>exclusive 和selector有可能造成消息堆积</h3><h2 id="集群配置"><a href="#集群配置" class="headerlink" title="集群配置"></a>集群配置</h2><p><strong>官方文档</strong></p>
<p><a href="http://activemq.apache.org/clustering" target="_blank" rel="noopener">http://activemq.apache.org/clustering</a></p>
<h3 id="主备集群"><a href="#主备集群" class="headerlink" title="主备集群"></a>主备集群</h3><p><a href="http://activemq.apache.org/masterslave.html" target="_blank" rel="noopener">http://activemq.apache.org/masterslave.html</a></p>
<table>
<thead>
<tr>
<th>Master Slave Type</th>
<th>Requirements</th>
<th>Pros</th>
<th>Cons</th>
</tr>
</thead>
<tbody><tr>
<td><a href="http://activemq.apache.org/shared-file-system-master-slave" target="_blank" rel="noopener">Shared File System Master Slave</a></td>
<td>A shared file system such as a SAN</td>
<td>Run as many slaves as required. Automatic recovery of old masters</td>
<td>Requires shared file system</td>
</tr>
<tr>
<td><a href="http://activemq.apache.org/jdbc-master-slave" target="_blank" rel="noopener">JDBC Master Slave</a></td>
<td>A Shared database</td>
<td>Run as many slaves as required. Automatic recovery of old masters</td>
<td>Requires a shared database. Also relatively slow as it cannot use the high performance journal</td>
</tr>
<tr>
<td><a href="http://activemq.apache.org/replicated-Features/PersistenceFeatures/Persistence/Features/Persistence/leveldb-store" target="_blank" rel="noopener">Replicated LevelDB Store</a></td>
<td>ZooKeeper Server</td>
<td>Run as many slaves as required. Automatic recovery of old masters. Very fast.</td>
<td>Requires a ZooKeeper server.</td>
</tr>
</tbody></table>
<h4 id="Shared-File-System-Master-Slave"><a href="#Shared-File-System-Master-Slave" class="headerlink" title="Shared File System Master Slave"></a>Shared File System Master Slave</h4><p>基于共享存储的Master-Slave；多个broker共用同一数据源，谁拿到锁谁就是master,其他处于待启动状态，如果master挂掉了，某个抢到文件锁的slave变成master</p>
<p><strong>启动后</strong></p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/Startup.png" alt="img"></p>
<p><strong>Master宕机</strong></p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/MasterFailed.png" alt="img"></p>
<p><strong>Master重启</strong></p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212193653842.png" alt="image-20200212193653842"></p>
<p><strong>JDBC Master Slave</strong></p>
<p>基于JDBC的Master-Slave:使用同一个数据库，拿到LOCK表的写锁的broker成为master.</p>
<p>性能较低，不能使用高性能日志</p>
<p><strong>Replicated LeveDB Store</strong></p>
<p>基于zookeeper复制LeveDB存储的Master-Slave机制</p>
<p><strong>配置步骤</strong></p>
<ol>
<li>修改broker名称</li>
<li>修改数据源<ol>
<li>如果使用kahadb，配置相同路径</li>
<li>如果使用mysql 使用同一数据源（同一数据库和表）</li>
</ol>
</li>
</ol>
<p><strong>尝试</strong></p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212144259602.png" alt="image-20200212144259602"></p>
<p><a href="http://activemq.apache.org/failover-transport-reference.html" target="_blank" rel="noopener">http://activemq.apache.org/failover-transport-reference.html</a></p>
<h4 id="failover-故障转移协议"><a href="#failover-故障转移协议" class="headerlink" title="failover 故障转移协议"></a>failover 故障转移协议</h4><p>断线重连机制是ActiveMQ的高可用性具体体现之一。ActiveMQ提供failover机制去实现断线重连的高可用性，可以使得连接断开之后，不断的重试连接到一个或多个brokerURL。</p>
<p>默认情况下，如果client与broker直接的connection断开，则client会新起一个线程，不断的从url参数中获取一个url来重试连接。</p>
<p>配置语法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ActiveMQConnectionFactory connectionFactory = <span class="keyword">new</span> ActiveMQConnectionFactory(</span><br><span class="line">		<span class="string">"admin"</span>,</span><br><span class="line">		<span class="string">"admin"</span>,</span><br><span class="line">		<span class="string">"failover:(nio://localhost:5671,nio://localhost:5672)"</span></span><br><span class="line">		);</span><br></pre></td></tr></table></figure>

<p><strong>可配置选项</strong></p>
<h4 id="Transport-Options"><a href="#Transport-Options" class="headerlink" title="Transport Options"></a>Transport Options</h4><table>
<thead>
<tr>
<th>Option Name</th>
<th>Default Value</th>
<th>Description</th>
</tr>
</thead>
<tbody><tr>
<td><code>backup</code></td>
<td><code>false</code></td>
<td>Initialize and hold a second transport connection - to enable fast failover.</td>
</tr>
<tr>
<td><code>initialReconnectDelay</code></td>
<td><code>10</code></td>
<td>The delay (in ms) before the <em>first</em> reconnect attempt.</td>
</tr>
<tr>
<td><code>maxCacheSize</code></td>
<td><code>131072</code></td>
<td>Size in bytes for the cache of tracked messages. Applicable only if <code>trackMessages</code> is <code>true</code>.</td>
</tr>
<tr>
<td><code>maxReconnectAttempts</code></td>
<td>`-1</td>
<td>0`</td>
</tr>
<tr>
<td><code>maxReconnectDelay</code></td>
<td><code>30000</code></td>
<td>The maximum delay (in ms) between the <em>second and subsequent</em> reconnect attempts.</td>
</tr>
<tr>
<td><code>nested.*</code></td>
<td><code>null</code></td>
<td><strong>From ActiveMQ 5.9:</strong> common URI options that will be applied to each URI in the list<strong>.</strong></td>
</tr>
<tr>
<td><code>randomize</code></td>
<td><code>true</code></td>
<td>If <code>true</code>, choose a URI at random from the list to use for reconnect.</td>
</tr>
<tr>
<td><code>reconnectDelayExponent</code></td>
<td><code>2.0</code></td>
<td>The exponent used during exponential back-off attempts.</td>
</tr>
<tr>
<td><code>reconnectSupported</code></td>
<td><code>true</code></td>
<td>Determines whether the client should respond to broker <code>ConnectionControl</code> events with a reconnect (see: <code>rebalanceClusterClients</code>).</td>
</tr>
<tr>
<td><code>startupMaxReconnectAttempts</code></td>
<td><code>-1</code></td>
<td>A value of <code>-1</code> denotes that the number of connection attempts at startup should be unlimited. A value of <code>&gt;=0</code> denotes the number of reconnect attempts at startup that will be made after which an error is sent back to the client when the client makes a subsequent reconnect attempt. <strong>Note</strong>: once successfully connected the <code>maxReconnectAttempts</code> option prevails.</td>
</tr>
<tr>
<td><code>timeout</code></td>
<td><code>-1</code></td>
<td><strong>From ActiveMQ 5.3</strong>: set the timeout on send operations (in ms) without interruption of re-connection process.</td>
</tr>
<tr>
<td><code>trackMessages</code></td>
<td><code>false</code></td>
<td>Keep a cache of in-flight messages that will flushed to a broker on reconnect.</td>
</tr>
<tr>
<td><code>updateURIsSupported</code></td>
<td><code>true</code></td>
<td><strong>From</strong> <strong>ActiveMQ 5.4:</strong> determines whether the client should accept updates from the broker to its list of known URIs.</td>
</tr>
<tr>
<td><code>updateURIsURL</code></td>
<td><code>null</code></td>
<td><strong>From ActiveMQ 5.4:</strong> a URL (or path to a local file) to a text file containing a comma separated list of URIs to use for reconnect in the case of failure.</td>
</tr>
<tr>
<td><code>useExponentialBackOff</code></td>
<td><code>true</code></td>
<td>If <code>true</code> an exponential back-off is used between reconnect attempts.</td>
</tr>
<tr>
<td><code>warnAfterReconnectAttempts</code></td>
<td><code>10</code></td>
<td><strong>From ActiveMQ 5.10:</strong> a value <code>&gt;0</code> specifies the number of reconnect attempts before a warning is logged. A logged warning indicates that there is no current connection but re-connection is being attempted. A value of <code>&lt;=0</code> disables the logging of warnings about reconnect attempts.</td>
</tr>
</tbody></table>
<p><strong>backup</strong></p>
<p>初始化的时候创建第二个连接，快速故障转移</p>
<p><strong>initialReconnectDelay</strong></p>
<p>第一次重试延迟</p>
<p><strong>trackMessages</strong></p>
<p>设置是否缓存（故障发生时）尚未传送完成的消息，当broker一旦重新连接成功，便将这些缓存中的消息刷新到新连接的代理中，使得消息可以在broker切换前后顺利传送。默认false</p>
<p><strong>maxCacheSize</strong></p>
<p>当trackMessage启动时，缓存的最大子字节数</p>
<p><strong>maxReconnectAttempts</strong></p>
<p>默认1|0，自5.6版本开始，-1为默认值，代表不限重试次数，0标识从不重试（只尝试连接一次，并不重连），5.6以前的版本，0为默认值，代表不重试，如果设置大于0的数，则代表最大重试次数。</p>
<p><strong>maxReconnectDelay</strong></p>
<p>最长重试间隔</p>
<p><strong>randomize</strong></p>
<p>使用随机连接，以达到负载均衡的目的，默认true</p>
<p>只配主备的情况下最好关闭</p>
<p><strong>startupMaxReconnectAttempts</strong></p>
<p>初始化时的最大重试次</p>
<p>“-1”表示在启动时连接尝试的次数是无限的。</p>
<p>‘ &gt;=0 ‘的值表示在启动时重新连接尝试的次数</p>
<p>一旦成功连接后续将使用“maxReconnectAttempts”选项</p>
<p><strong>timeout</strong></p>
<p>连接超时</p>
<p><strong>updateURIsSupported</strong></p>
<p>是否可以动态修改broker uri</p>
<p><strong>updateURIsURL</strong></p>
<p>指定动态修改地址的路径</p>
<p><strong>useExponentialBackOff</strong></p>
<p>重连时间间隔是否以指数形式增长</p>
<p><strong>reconnectDelayExponent</strong></p>
<p>指数增长时的指数</p>
<p><strong>warnAfterReconnectAttempts</strong></p>
<p>重连日志记录</p>
<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3><p><strong>官方文档</strong></p>
<p><a href="http://activemq.apache.org/networks-of-brokers.html" target="_blank" rel="noopener">http://activemq.apache.org/networks-of-brokers.html</a></p>
<h4 id="静态网络配置"><a href="#静态网络配置" class="headerlink" title="静态网络配置"></a>静态网络配置</h4><p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/10190bfe-30d7-3021-8bbe-9d7882530083.png" alt="img"></p>
<p>在broker节点下配置networkConnectors</p>
<ul>
<li>networkConnectors（网络连接器）主要用来配置ActiveMQ服务端与服务端之间的通信</li>
<li>TransportConnector（传输连接器）主要用于配置ActiveMQ服务端和客户端之间的通信方式</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;networkConnectors&gt;</span><br><span class="line">  &lt;networkConnector duplex&#x3D;&quot;true&quot; name&#x3D;&quot;amq-cluster&quot; uri&#x3D;&quot;static:failover:&#x2F;&#x2F;(nio:&#x2F;&#x2F;localhost:5671,nio:&#x2F;&#x2F;localhost:5672)&quot;  &#x2F;&gt;</span><br><span class="line">&lt;&#x2F;networkConnectors&gt;</span><br></pre></td></tr></table></figure>

<p>参与的节点都需要修改</p>
<p>注意如果单机启动多个节点，记得修改端口避免冲突</p>
<p>启动成功后<code>Connections</code>中会有其他节点</p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212165236443.png" alt="image-20200212165236443"></p>
<p><code>Network</code>中也会显示桥接连接</p>
<p><img src="/2020/07/12/ActiveMQ%E8%AF%A6%E8%A7%A3/image-20200212165658958.png" alt="image-20200212165658958"></p>
<p>负载均衡的环境下，broker上的消息优先给在本地连接的consumer</p>
<p>当networkerConnector与remote Broker建立链接之后，那么remote Broker将会向local Broker交付订阅信息，包括remote broker持有的destinations、Consumers、持久订阅者列表等；那么此后local Broker将把remote Broker做一个消息“订阅者”</p>
<p><strong>Advisory</strong></p>
<p>ActiveMQ提供了“Advisory”机制，通常ActiveMQ内部将某些事件作为“advisory”在全局广播，比如destination的创建、consumer的加入、DLQ的产生等，这将额外的消耗极小的性能；我们可以在ActiveMQ的监控页面上看到影响的消息，开发者也可以View这些消息(通道名称以“ActiveMQ.Advisory.”开头)。对于分布式网络中的broker，将严重依赖“Advisory”，特别是“dynamic network”，默认已开启</p>
<p>在一个broker上发生事件，都会以“通知”的方式发送给配置文件中指定的所有networkConnector</p>
<p><strong>Dynamic networks</strong></p>
<p>“动态网络”表明当remote Broker持有通道的消费者时，local Broker才会转发相应的消息；此时我们需要开启advisorySupport。当remote broker上有Consumer创建时，Advisory中将会广播消息，消息为ConsumerInfo类型，它将包括consumer所在的broker path，如果local broker与此path建立了networkConnector，那么此后local Broker将会启动响应的消息转发。</p>
<p><strong>Static networks</strong></p>
<p>  相对于“动态网络”而言，“静态网络”将不依赖Advisory，在任何时候，即使remote Broker中没有相应的consumer，消息也将转发给remote Broker</p>
<p>将brokers作为简单代理并转发消息到远端而不管是否有消费者</p>
<h4 id="可配置属性"><a href="#可配置属性" class="headerlink" title="可配置属性"></a>可配置属性</h4><h5 id="URI的几个属性"><a href="#URI的几个属性" class="headerlink" title="URI的几个属性"></a>URI的几个属性</h5><table>
<thead>
<tr>
<th>property</th>
<th>default</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>initialReconnectDelay</td>
<td>1000</td>
<td>time(ms) to wait before attempting a reconnect (if useExponentialBackOff is false)</td>
</tr>
<tr>
<td>maxReconnectDelay</td>
<td>30000</td>
<td>time(ms) to wait before attempting to re-connect</td>
</tr>
<tr>
<td>useExponentialBackOff</td>
<td>true</td>
<td>increases time between reconnect for every failure in a reconnect sequence</td>
</tr>
<tr>
<td>backOffMultiplier</td>
<td>2</td>
<td>multipler used to increase the wait time if using exponential back off</td>
</tr>
</tbody></table>
<h5 id="NetworkConnector-Properties"><a href="#NetworkConnector-Properties" class="headerlink" title="NetworkConnector Properties"></a>NetworkConnector Properties</h5><table>
<thead>
<tr>
<th>property</th>
<th>default</th>
<th>description</th>
</tr>
</thead>
<tbody><tr>
<td>name</td>
<td>bridge</td>
<td>name of the network - for more than one network connector between the same two brokers - use different names</td>
</tr>
<tr>
<td>dynamicOnly</td>
<td>false</td>
<td>if true, only activate a networked durable subscription when a corresponding durable subscription reactivates, by default they are activated on startup.</td>
</tr>
<tr>
<td>decreaseNetworkConsumerPriority</td>
<td>false</td>
<td>if true, starting at priority -5, decrease the priority for dispatching to a network Queue consumer the further away it is (in network hops) from the producer. When false all network consumers use same default priority(0) as local consumers</td>
</tr>
<tr>
<td>networkTTL</td>
<td>1</td>
<td>the number of brokers in the network that messages and subscriptions can pass through (sets both message&amp;consumer -TTL)</td>
</tr>
<tr>
<td>messageTTL</td>
<td>1</td>
<td>(version 5.9) the number of brokers in the network that messages can pass through</td>
</tr>
<tr>
<td>consumerTTL</td>
<td>1</td>
<td>(version 5.9) the number of brokers in the network that subscriptions can pass through (keep to 1 in a mesh)</td>
</tr>
<tr>
<td>conduitSubscriptions</td>
<td>true</td>
<td>multiple consumers subscribing to the same destination are treated as one consumer by the network</td>
</tr>
<tr>
<td>excludedDestinations</td>
<td>empty</td>
<td>destinations matching this list won’t be forwarded across the network (this only applies to dynamicallyIncludedDestinations)</td>
</tr>
<tr>
<td>dynamicallyIncludedDestinations</td>
<td>empty</td>
<td>destinations that match this list <strong>will</strong> be forwarded across the network <strong>n.b.</strong> an empty list means all destinations not in the exluded list will be forwarded</td>
</tr>
<tr>
<td>useVirtualDestSubs</td>
<td>false</td>
<td>if true, the network connection will listen to advisory messages for virtual destination consumers</td>
</tr>
<tr>
<td>staticallyIncludedDestinations</td>
<td>empty</td>
<td>destinations that match will always be passed across the network - even if no consumers have ever registered an interest</td>
</tr>
<tr>
<td>duplex</td>
<td>false</td>
<td>if true, a network connection will be used to both produce <strong><em>AND\</em></strong> Consume messages. This is useful for hub and spoke scenarios when the hub is behind a firewall etc.</td>
</tr>
<tr>
<td>prefetchSize</td>
<td>1000</td>
<td>Sets the <a href="http://activemq.apache.org/what-is-the-prefetch-limit-for" target="_blank" rel="noopener">prefetch size</a> on the network connector’s consumer. It must be &gt; 0 because network consumers do not poll for messages</td>
</tr>
<tr>
<td>suppressDuplicateQueueSubscriptions</td>
<td>false</td>
<td>(from 5.3) if true, duplicate subscriptions in the network that arise from network intermediaries will be suppressed. For example, given brokers A,B and C, networked via multicast discovery. A consumer on A will give rise to a networked consumer on B and C. In addition, C will network to B (based on the network consumer from A) and B will network to C. When true, the network bridges between C and B (being duplicates of their existing network subscriptions to A) will be suppressed. Reducing the routing choices in this way provides determinism when producers or consumers migrate across the network as the potential for dead routes (stuck messages) are eliminated. networkTTL needs to match or exceed the broker count to require this intervention.</td>
</tr>
<tr>
<td>bridgeTempDestinations</td>
<td>true</td>
<td>Whether to broadcast advisory messages for created temp destinations in the network of brokers or not. Temp destinations are typically created for request-reply messages. Broadcasting the information about temp destinations is turned on by default so that consumers of a request-reply message can be connected to another broker in the network and still send back the reply on the temporary destination specified in the JMSReplyTo header. In an application scenario where most/all messages use request-reply pattern, this will generate additional traffic on the broker network as every message typically sets a unique JMSReplyTo address (which causes a new temp destination to be created and broadcasted via an advisory message in the network of brokers). When disabling this feature such network traffic can be reduced but then producer and consumers of a request-reply message need to be connected to the same broker. Remote consumers (i.e. connected via another broker in your network) won’t be able to send the reply message but instead raise a “temp destination does not exist” exception.</td>
</tr>
<tr>
<td>alwaysSyncSend</td>
<td>false</td>
<td>(version 5.6) When true, non persistent messages are sent to the remote broker using request/reply in place of a oneway. This setting treats both persistent and non-persistent messages the same.</td>
</tr>
<tr>
<td>staticBridge</td>
<td>false</td>
<td>(version 5.6) If set to true, broker will not dynamically respond to new consumers. It will only use <code>staticallyIncludedDestinations</code> to create demand subscriptions</td>
</tr>
<tr>
<td>userName</td>
<td>null</td>
<td>The username to authenticate against the remote broker</td>
</tr>
<tr>
<td>password</td>
<td>null</td>
<td>The password for the username to authenticate against the remote broker</td>
</tr>
</tbody></table>
<p><strong>name</strong></p>
<p>相同的名称会被添加到同一集群中</p>
<p><strong>dynamicOnly</strong></p>
<p>是否直接转发，设置成true的话 broker会在没有消费者的时候不去转发消息</p>
<p><strong>decreaseNetworkConsumerPriority</strong></p>
<p>如果为true，网络的消费者优先级降低为-5。如果为false，则默认跟本地消费者一样为0.</p>
<p><strong>networkTTL</strong> <strong>messageTTL</strong> <strong>consumerTTL</strong></p>
<p>消息和订阅在网络中被broker转发（穿过）的最大次数，消息在网络中每转发一次，都会将TTL-1</p>
<p><strong>conduitSubscriptions</strong></p>
<p>多个消费者消费消息被当作一个消费者</p>
<p><strong>excludedDestinations</strong></p>
<p>在这个名单中的Destination不会在网络中被转发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;excludedDestinaitons&gt;</span><br><span class="line">        &lt;queue physicalName&#x3D;&quot;include.test.foo&quot;&#x2F;&gt;</span><br><span class="line">        &lt;topic physicalName&#x3D;&quot;include.test.bar&quot;&#x2F;&gt;</span><br><span class="line">　&lt;&#x2F;excludedDestinaitons&gt;</span><br></pre></td></tr></table></figure>



<p><strong>dynamicallyIncludedDestinations</strong></p>
<p>通过网络转发的destinations，注意空列表代表所有的都转发。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">　&lt;dynamicallyIncludeDestinaitons&gt;</span><br><span class="line">&lt;queue physicalName&#x3D;&quot;include.test.foo&quot;&#x2F;&gt;</span><br><span class="line">&lt;topic physicalName&#x3D;&quot;include.test.bar&quot;&#x2F;&gt;</span><br><span class="line">　&lt;&#x2F;dynamicallyIncludeDestinaitons&gt;</span><br></pre></td></tr></table></figure>



<p><strong>useVirtualDestSubs</strong></p>
<p>开启此选项会在转发消息时</p>
<p><strong>staticallyIncludedDestinations</strong></p>
<p>匹配的目的地将始终通过网络传递——即使没有消费者对此感兴趣 对应静态networks</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;staticallyIncludeDestinaitons&gt;</span><br><span class="line">       &lt;queue physicalName&#x3D;&quot;aways.include.queue&quot;&#x2F;&gt;</span><br><span class="line">　&lt;&#x2F;staticallyIncludeDestinaitons&gt;</span><br></pre></td></tr></table></figure>



<p><strong>duplex</strong></p>
<p>是否允许双向连接<strong>如果该属性为true，当这个节点使用Network Bridge连接到其它目标节点后，将强制目标也建立Network Bridge进行反向连接</strong></p>
<p><strong>prefetchSize</strong></p>
<p>缓冲消息大小，必须大于0，不会主动拉取消息</p>
<p><strong>suppressDuplicateQueueSubscriptions</strong></p>
<p>如果为true, 重复的订阅关系一产生即被阻止。</p>
<p><strong>bridgeTempDestinations</strong></p>
<p>是否转发临时destination，禁用后再使用request/reply模型的时候客户端需要连接到同一broker，不然会找不到destination</p>
<p><strong>alwaysSyncSend</strong></p>
<p>开启后转发非持久化消息会使用request/reply模型</p>
<p><strong>staticBridge</strong></p>
<p>如果设置为true，则代理将不会动态响应新的consumer，只能使用staticallyIncludedDestinations中的destination</p>
<p><strong>userName</strong> <strong>password</strong></p>
<p>连接broker时的用户名和密码</p>
<h4 id="动态网络配置"><a href="#动态网络配置" class="headerlink" title="动态网络配置"></a>动态网络配置</h4><p><strong>官方文档</strong></p>
<p><a href="http://activemq.apache.org/multicast-transport-reference" target="_blank" rel="noopener">http://activemq.apache.org/multicast-transport-reference</a></p>
<p>使用multicast协议，可以指定组播地址或使用<code>multicast://default</code>（239.255.2.3）</p>
<p>配置<code>networkConnectors</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;networkConnectors&gt;</span><br><span class="line"> &lt;networkConnector uri&#x3D;&quot;multicast:&#x2F;&#x2F;239.0.0.5&quot; duplex&#x3D;&quot;false&quot;&#x2F;&gt;</span><br><span class="line">&lt;&#x2F;networkConnectors&gt;</span><br></pre></td></tr></table></figure>

<p>broker启动后会使用udp协议向组播地址发送数据报文以便让其他在这个组播地址的节点感知到自己的存在</p>
<p>每个UDP数据报中，包含的主要信息包括本节点ActiveMQ的版本信息，以及连接到自己所需要使用的host名字、协议名和端口信息。</p>
<p>配置<code>transportConnector</code>指明将哪一个连接通过UDP数据报向其他ActiveMQ节点进行公布，就需要在transportConnector标签上使用discoveryUri属性进行标识</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;transportConnector name&#x3D;&quot;auto+nio&quot; uri&#x3D;&quot;auto+nio:&#x2F;&#x2F;localhost:5672&quot; discoveryUri&#x3D;&quot;multicast:&#x2F;&#x2F;239.0.0.5&quot;&#x2F;&gt;</span><br></pre></td></tr></table></figure>



<h3 id="消息回流"><a href="#消息回流" class="headerlink" title="消息回流"></a>消息回流</h3><p>在消息转发的时候，remote broker转发Local broker的消息会消费掉LocalBroker的消息</p>
<p>那么在转发的过程中，消息在被拉取后和发送给consumer的过程中重启的话会造成消息丢失</p>
<p><code>replayWhenNoConsumers</code> 选项可以使remote broke上有需要转发的消息但是没有被消费时，把消息回流到它原始的broker.同时把enableAudit设置为false,为了防止消息回流后被当作重复消息而不被分发</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">　　　　 &lt;destinationPolicy&gt;</span><br><span class="line">    &lt;policyMap&gt;</span><br><span class="line">      &lt;policyEntries&gt;</span><br><span class="line">        &lt;policyEntry queue&#x3D;&quot;&gt;&quot; enableAudit&#x3D;&quot;false&quot;&gt;</span><br><span class="line">            &lt;networkBridgeFilterFactory&gt;</span><br><span class="line">                &lt;conditionalNetworkBridgeFilterFactory replayWhenNoConsumers&#x3D;&quot;true&quot;&#x2F;&gt;</span><br><span class="line">            &lt;&#x2F;networkBridgeFilterFactory&gt;</span><br><span class="line">        &lt;&#x2F;policyEntry&gt;</span><br><span class="line">      &lt;&#x2F;policyEntries&gt;</span><br><span class="line">    &lt;&#x2F;policyMap&gt;</span><br><span class="line">&lt;&#x2F;destinationPolicy&gt;</span><br></pre></td></tr></table></figure>



<h3 id="消息副本"><a href="#消息副本" class="headerlink" title="消息副本"></a>消息副本</h3><p><a href="http://activemq.apache.org/replicated-message-store" target="_blank" rel="noopener">http://activemq.apache.org/replicated-message-store</a></p>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97%EF%BC%8C%E4%B8%AD%E9%97%B4%E4%BB%B6%EF%BC%8CActiveMQ/" rel="tag"># 消息队列，中间件，ActiveMQ</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/07/03/MySQL%E8%B0%83%E4%BC%98/" rel="next" title="MySQL调优">
                <i class="fa fa-chevron-left"></i> MySQL调优
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/12/MySQL%E7%B4%A2%E5%BC%95%E6%95%B0%E6%8D%AE%E7%BB%93%E6%9E%84%E5%88%86%E6%9E%90/" rel="prev" title="MySQL索引数据结构分析">
                MySQL索引数据结构分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/oi.jpg"
                alt="CodingPunk" />
            
              <p class="site-author-name" itemprop="name">CodingPunk</p>
              <p class="site-description motion-element" itemprop="description">A Punk loves Coding</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">33</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">19</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/OiPunk" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="codingpunk@gmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#1-详细介绍"><span class="nav-number">1.</span> <span class="nav-text">1. 详细介绍</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#什么是JMS-MQ"><span class="nav-number">1.1.</span> <span class="nav-text">什么是JMS MQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息中间件应用场景"><span class="nav-number">1.2.</span> <span class="nav-text">消息中间件应用场景</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#异步通信"><span class="nav-number">1.2.1.</span> <span class="nav-text">异步通信</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#缓冲"><span class="nav-number">1.2.2.</span> <span class="nav-text">缓冲</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解耦"><span class="nav-number">1.2.3.</span> <span class="nav-text">解耦</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#冗余"><span class="nav-number">1.2.4.</span> <span class="nav-text">冗余</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#扩展性"><span class="nav-number">1.2.5.</span> <span class="nav-text">扩展性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可恢复性"><span class="nav-number">1.2.6.</span> <span class="nav-text">可恢复性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#顺序保证"><span class="nav-number">1.2.7.</span> <span class="nav-text">顺序保证</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#过载保护"><span class="nav-number">1.2.8.</span> <span class="nav-text">过载保护</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#数据流处理"><span class="nav-number">1.2.9.</span> <span class="nav-text">数据流处理</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较"><span class="nav-number">1.3.</span> <span class="nav-text">常用消息队列（ActiveMQ、RabbitMQ、RocketMQ、Kafka）比较</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JMS中的一些角色"><span class="nav-number">1.4.</span> <span class="nav-text">JMS中的一些角色</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Broker"><span class="nav-number">1.4.1.</span> <span class="nav-text">Broker</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#provider"><span class="nav-number">1.4.2.</span> <span class="nav-text">provider</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Consumer"><span class="nav-number">1.4.3.</span> <span class="nav-text">Consumer</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#p2p"><span class="nav-number">1.4.4.</span> <span class="nav-text">p2p</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#pub-sub"><span class="nav-number">1.4.5.</span> <span class="nav-text">pub&#x2F;sub</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PTP-和-PUB-SUB-简单对"><span class="nav-number">1.4.6.</span> <span class="nav-text">PTP 和 PUB&#x2F;SUB 简单对</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Queue"><span class="nav-number">1.4.7.</span> <span class="nav-text">Queue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Topic"><span class="nav-number">1.4.8.</span> <span class="nav-text">Topic</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ConnectionFactory"><span class="nav-number">1.4.9.</span> <span class="nav-text">ConnectionFactory</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Connection"><span class="nav-number">1.4.10.</span> <span class="nav-text">Connection</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Destination"><span class="nav-number">1.4.11.</span> <span class="nav-text">Destination</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Session"><span class="nav-number">1.4.12.</span> <span class="nav-text">Session</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JMS的消息格式"><span class="nav-number">1.5.</span> <span class="nav-text">JMS的消息格式</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JMS消息由以下三部分组成的："><span class="nav-number">1.5.1.</span> <span class="nav-text">JMS消息由以下三部分组成的：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TextMessage"><span class="nav-number">1.5.2.</span> <span class="nav-text">TextMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MapMessage"><span class="nav-number">1.5.3.</span> <span class="nav-text">MapMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#BytesMessage"><span class="nav-number">1.5.4.</span> <span class="nav-text">BytesMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#StreamMessage"><span class="nav-number">1.5.5.</span> <span class="nav-text">StreamMessage</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#ObjectMessage"><span class="nav-number">1.5.6.</span> <span class="nav-text">ObjectMessage</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息可靠性机制"><span class="nav-number">1.6.</span> <span class="nav-text">消息可靠性机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#确认-JMS消息"><span class="nav-number">1.6.1.</span> <span class="nav-text">确认 JMS消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久性"><span class="nav-number">1.6.2.</span> <span class="nav-text">持久性</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级"><span class="nav-number">1.6.3.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息过期"><span class="nav-number">1.6.4.</span> <span class="nav-text">消息过期</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#临时目的地"><span class="nav-number">1.6.5.</span> <span class="nav-text">临时目的地</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久订阅"><span class="nav-number">1.6.6.</span> <span class="nav-text">持久订阅</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#本地事务"><span class="nav-number">1.6.7.</span> <span class="nav-text">本地事务</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActiveMQ"><span class="nav-number">1.7.</span> <span class="nav-text">ActiveMQ</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Broker-1"><span class="nav-number">1.8.</span> <span class="nav-text">Broker</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#存储"><span class="nav-number">1.9.</span> <span class="nav-text">存储</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#KahaDB存储"><span class="nav-number">1.9.1.</span> <span class="nav-text">KahaDB存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AMQ-方式"><span class="nav-number">1.9.2.</span> <span class="nav-text">AMQ 方式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDBC存储"><span class="nav-number">1.9.3.</span> <span class="nav-text">JDBC存储</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#表字段解释"><span class="nav-number">1.9.3.1.</span> <span class="nav-text">表字段解释</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#LevelDB存储"><span class="nav-number">1.9.4.</span> <span class="nav-text">LevelDB存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Memory-消息存储"><span class="nav-number">1.9.5.</span> <span class="nav-text">Memory 消息存储</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JDBC-Message-store-with-ActiveMQ-Journal"><span class="nav-number">1.9.6.</span> <span class="nav-text">JDBC Message store with ActiveMQ Journal</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#协议"><span class="nav-number">1.10.</span> <span class="nav-text">协议</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Transmission-Control-Protocol-TCP"><span class="nav-number">1.10.1.</span> <span class="nav-text">Transmission Control Protocol (TCP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#New-I-O-API-Protocol（NIO）"><span class="nav-number">1.10.2.</span> <span class="nav-text">New I&#x2F;O API Protocol（NIO）</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#User-Datagram-Protocol（UDP"><span class="nav-number">1.10.3.</span> <span class="nav-text">User Datagram Protocol（UDP)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Secure-Sockets-Layer-Protocol-SSL"><span class="nav-number">1.10.4.</span> <span class="nav-text">Secure Sockets Layer Protocol (SSL)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hypertext-Transfer-Protocol-HTTP-HTTPS"><span class="nav-number">1.10.5.</span> <span class="nav-text">Hypertext Transfer Protocol (HTTP&#x2F;HTTPS)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#VM-Protocol（VM）"><span class="nav-number">1.10.6.</span> <span class="nav-text">VM Protocol（VM）</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#HelloWorld"><span class="nav-number">1.11.</span> <span class="nav-text">HelloWorld</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#下载"><span class="nav-number">1.11.1.</span> <span class="nav-text">下载</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#安装启动"><span class="nav-number">1.11.2.</span> <span class="nav-text">安装启动</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#web控制台"><span class="nav-number">1.11.3.</span> <span class="nav-text">web控制台</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#修改访问端口"><span class="nav-number">1.11.4.</span> <span class="nav-text">修改访问端口</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开发"><span class="nav-number">1.11.5.</span> <span class="nav-text">开发</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Sender"><span class="nav-number">1.11.5.1.</span> <span class="nav-text">Sender</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Receiver"><span class="nav-number">1.11.5.2.</span> <span class="nav-text">Receiver</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Active-MQ的安全机制"><span class="nav-number">1.12.</span> <span class="nav-text">Active MQ的安全机制</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#web控制台安全"><span class="nav-number">1.12.1.</span> <span class="nav-text">web控制台安全</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息安全机制"><span class="nav-number">1.12.2.</span> <span class="nav-text">消息安全机制</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#2-基本使用"><span class="nav-number">2.</span> <span class="nav-text">2. 基本使用</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#常用API"><span class="nav-number">2.1.</span> <span class="nav-text">常用API</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#事务"><span class="nav-number">2.1.1.</span> <span class="nav-text">事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Purge"><span class="nav-number">2.1.2.</span> <span class="nav-text">Purge</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#签收模式"><span class="nav-number">2.1.3.</span> <span class="nav-text">签收模式</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-AUTO-ACKNOWLEDGE"><span class="nav-number">2.1.3.1.</span> <span class="nav-text">Session.AUTO_ACKNOWLEDGE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-CLIENT-ACKNOWLEDGE"><span class="nav-number">2.1.3.2.</span> <span class="nav-text">Session.CLIENT_ACKNOWLEDGE</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Session-DUPS-OK-ACKNOWLEDGE"><span class="nav-number">2.1.3.3.</span> <span class="nav-text">Session.DUPS_OK_ACKNOWLEDGE</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#持久化"><span class="nav-number">2.1.4.</span> <span class="nav-text">持久化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优先级-1"><span class="nav-number">2.1.5.</span> <span class="nav-text">优先级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息超时-过期"><span class="nav-number">2.1.6.</span> <span class="nav-text">消息超时&#x2F;过期</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#死信"><span class="nav-number">2.1.6.1.</span> <span class="nav-text">死信</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#修改死信队列名称"><span class="nav-number">2.1.6.2.</span> <span class="nav-text">修改死信队列名称</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#让非持久化的消息也进入死信队列"><span class="nav-number">2.1.6.3.</span> <span class="nav-text">让非持久化的消息也进入死信队列</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#过期消息不进死信队列"><span class="nav-number">2.1.6.4.</span> <span class="nav-text">过期消息不进死信队列</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#独占消费者"><span class="nav-number">2.1.7.</span> <span class="nav-text">独占消费者</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息类型"><span class="nav-number">2.2.</span> <span class="nav-text">消息类型</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#object"><span class="nav-number">2.2.1.</span> <span class="nav-text">object</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送端"><span class="nav-number">2.2.1.1.</span> <span class="nav-text">发送端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接受端"><span class="nav-number">2.2.1.2.</span> <span class="nav-text">接受端</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#bytesMessage"><span class="nav-number">2.2.2.</span> <span class="nav-text">bytesMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送端-1"><span class="nav-number">2.2.2.1.</span> <span class="nav-text">发送端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接受端-1"><span class="nav-number">2.2.2.2.</span> <span class="nav-text">接受端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#写入文件"><span class="nav-number">2.2.2.3.</span> <span class="nav-text">写入文件</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#MapMessage-1"><span class="nav-number">2.2.3.</span> <span class="nav-text">MapMessage</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#发送端-2"><span class="nav-number">2.2.3.1.</span> <span class="nav-text">发送端</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#接收端"><span class="nav-number">2.2.3.2.</span> <span class="nav-text">接收端</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息发送原理"><span class="nav-number">2.3.</span> <span class="nav-text">消息发送原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#同步与异步"><span class="nav-number">2.3.1.</span> <span class="nav-text">同步与异步</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息堆积"><span class="nav-number">2.3.2.</span> <span class="nav-text">消息堆积</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#延迟消息投递"><span class="nav-number">2.3.3.</span> <span class="nav-text">延迟消息投递</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#延迟发送"><span class="nav-number">2.3.4.</span> <span class="nav-text">延迟发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#带间隔的重复发送"><span class="nav-number">2.3.5.</span> <span class="nav-text">带间隔的重复发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Cron表达式定时发送"><span class="nav-number">2.3.6.</span> <span class="nav-text">Cron表达式定时发送</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#监听器"><span class="nav-number">2.4.</span> <span class="nav-text">监听器</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#消息过滤"><span class="nav-number">2.5.</span> <span class="nav-text">消息过滤</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#消息发送"><span class="nav-number">2.5.1.</span> <span class="nav-text">消息发送</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息接收"><span class="nav-number">2.5.2.</span> <span class="nav-text">消息接收</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#整合SpringBoot"><span class="nav-number">2.6.</span> <span class="nav-text">整合SpringBoot</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#配置文件"><span class="nav-number">2.6.1.</span> <span class="nav-text">配置文件</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#POM"><span class="nav-number">2.6.1.1.</span> <span class="nav-text">POM</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#yml"><span class="nav-number">2.6.1.2.</span> <span class="nav-text">yml</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Config类"><span class="nav-number">2.6.1.3.</span> <span class="nav-text">Config类</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#收"><span class="nav-number">2.6.1.4.</span> <span class="nav-text">收</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#发"><span class="nav-number">2.6.1.5.</span> <span class="nav-text">发</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Linux下安装"><span class="nav-number">2.7.</span> <span class="nav-text">Linux下安装</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#NIO配置"><span class="nav-number">2.7.1.</span> <span class="nav-text">NIO配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#OpenWire-可用配置选项"><span class="nav-number">2.7.2.</span> <span class="nav-text">OpenWire 可用配置选项</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Transport-可用配置选项"><span class="nav-number">2.7.3.</span> <span class="nav-text">Transport 可用配置选项</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#ActiveMQ服务监控-Hawtio"><span class="nav-number">2.8.</span> <span class="nav-text">ActiveMQ服务监控 Hawtio</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#官方网站"><span class="nav-number">2.8.1.</span> <span class="nav-text">官方网站</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#部署"><span class="nav-number">2.8.2.</span> <span class="nav-text">部署</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#独立jar包的形式运行"><span class="nav-number">2.8.2.1.</span> <span class="nav-text">独立jar包的形式运行</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#嵌入ActiveMQ"><span class="nav-number">2.8.2.2.</span> <span class="nav-text">嵌入ActiveMQ</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#JMS消息结构（Message）"><span class="nav-number">2.9.</span> <span class="nav-text">JMS消息结构（Message）</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Header"><span class="nav-number">2.9.1.</span> <span class="nav-text">Header</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#自动头信息"><span class="nav-number">2.9.1.1.</span> <span class="nav-text">自动头信息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#手动头信息"><span class="nav-number">2.9.1.2.</span> <span class="nav-text">手动头信息</span></a></li></ol></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#下一代-ActiveMQ-6？Artemis"><span class="nav-number">2.10.</span> <span class="nav-text">下一代 ActiveMQ 6？Artemis</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#高级使用"><span class="nav-number">2.11.</span> <span class="nav-text">高级使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#JMSCorrelationID"><span class="nav-number">2.11.1.</span> <span class="nav-text">JMSCorrelationID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMSReplyTo"><span class="nav-number">2.11.2.</span> <span class="nav-text">JMSReplyTo</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#面试题"><span class="nav-number">2.12.</span> <span class="nav-text">面试题</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#ActiveMQ如何防止消息丢失？会不会丢消息？"><span class="nav-number">2.12.1.</span> <span class="nav-text">ActiveMQ如何防止消息丢失？会不会丢消息？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何防止重复消费？"><span class="nav-number">2.12.2.</span> <span class="nav-text">如何防止重复消费？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#如何保证消费顺序？"><span class="nav-number">2.12.3.</span> <span class="nav-text">如何保证消费顺序？</span></a></li></ol></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#3-高级使用"><span class="nav-number">3.</span> <span class="nav-text">3. 高级使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#queue-browser"><span class="nav-number">3.0.1.</span> <span class="nav-text">queue browser</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMSCorrelationID-1"><span class="nav-number">3.0.2.</span> <span class="nav-text">JMSCorrelationID</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMSReplyTo-1"><span class="nav-number">3.0.3.</span> <span class="nav-text">JMSReplyTo</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#QueueRequestor同步消息"><span class="nav-number">3.0.4.</span> <span class="nav-text">QueueRequestor同步消息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#生产环境中影响性能的几个因素"><span class="nav-number">3.0.5.</span> <span class="nav-text">生产环境中影响性能的几个因素</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Out-of-memory"><span class="nav-number">3.0.5.1.</span> <span class="nav-text">Out of memory</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#持久化和非持久化"><span class="nav-number">3.0.5.2.</span> <span class="nav-text">持久化和非持久化</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#消息异步发送"><span class="nav-number">3.0.5.3.</span> <span class="nav-text">消息异步发送</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#批量确认"><span class="nav-number">3.0.5.4.</span> <span class="nav-text">批量确认</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消费缓冲与消息积压prefetchSize"><span class="nav-number">3.0.6.</span> <span class="nav-text">消费缓冲与消息积压prefetchSize</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#可以通过3中方式设置prefetchSize"><span class="nav-number">3.0.6.1.</span> <span class="nav-text">可以通过3中方式设置prefetchSize</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息到底是推还是拉"><span class="nav-number">3.0.7.</span> <span class="nav-text">消息到底是推还是拉?</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#EIP-Enterprise-Integration-Patterns"><span class="nav-number">3.0.8.</span> <span class="nav-text">EIP Enterprise Integration Patterns.</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#Request-Response模型实现"><span class="nav-number">3.1.</span> <span class="nav-text">Request&#x2F;Response模型实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#QueueRequestor"><span class="nav-number">3.1.1.</span> <span class="nav-text">QueueRequestor</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#TemporaryQueue"><span class="nav-number">3.1.2.</span> <span class="nav-text">TemporaryQueue</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JMSCorrelationID-消息属性"><span class="nav-number">3.1.3.</span> <span class="nav-text">JMSCorrelationID 消息属性</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#调优总结"><span class="nav-number">3.2.</span> <span class="nav-text">调优总结</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#Topic加强-可追溯消息"><span class="nav-number">3.2.1.</span> <span class="nav-text">Topic加强 可追溯消息</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#消费者设置"><span class="nav-number">3.2.1.1.</span> <span class="nav-text">消费者设置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Summary-of-Available-Recovery-Policies"><span class="nav-number">3.2.2.</span> <span class="nav-text">Summary of Available Recovery Policies</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#保留固定字节的消息"><span class="nav-number">3.2.2.1.</span> <span class="nav-text">保留固定字节的消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保留固定数量的消息"><span class="nav-number">3.2.2.2.</span> <span class="nav-text">保留固定数量的消息</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保留时间"><span class="nav-number">3.2.2.3.</span> <span class="nav-text">保留时间</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#保留最后一条"><span class="nav-number">3.2.2.4.</span> <span class="nav-text">保留最后一条</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#慢速消费"><span class="nav-number">3.2.3.</span> <span class="nav-text">慢速消费</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#SlowConsumerStrategy"><span class="nav-number">3.2.3.1.</span> <span class="nav-text">SlowConsumerStrategy</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#PendingMessageLimitStrategy：消息限制策略（面向慢消费者）"><span class="nav-number">3.2.3.2.</span> <span class="nav-text">PendingMessageLimitStrategy：消息限制策略（面向慢消费者）</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息堆积内存上涨"><span class="nav-number">3.2.4.</span> <span class="nav-text">消息堆积内存上涨</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#磁盘满"><span class="nav-number">3.2.5.</span> <span class="nav-text">磁盘满</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开启事务"><span class="nav-number">3.2.6.</span> <span class="nav-text">开启事务</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prefetchSize影响消费倾斜"><span class="nav-number">3.2.7.</span> <span class="nav-text">prefetchSize影响消费倾斜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#prefetchSize造成消费者内存溢出"><span class="nav-number">3.2.8.</span> <span class="nav-text">prefetchSize造成消费者内存溢出</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#AUTO-ACKNOWLEDGE造成消息丢失-乱序"><span class="nav-number">3.2.9.</span> <span class="nav-text">AUTO_ACKNOWLEDGE造成消息丢失&#x2F;乱序</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#exclusive-和selector有可能造成消息堆积"><span class="nav-number">3.2.10.</span> <span class="nav-text">exclusive 和selector有可能造成消息堆积</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#集群配置"><span class="nav-number">3.3.</span> <span class="nav-text">集群配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#主备集群"><span class="nav-number">3.3.1.</span> <span class="nav-text">主备集群</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Shared-File-System-Master-Slave"><span class="nav-number">3.3.1.1.</span> <span class="nav-text">Shared File System Master Slave</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#failover-故障转移协议"><span class="nav-number">3.3.1.2.</span> <span class="nav-text">failover 故障转移协议</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#Transport-Options"><span class="nav-number">3.3.1.3.</span> <span class="nav-text">Transport Options</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#负载均衡"><span class="nav-number">3.3.2.</span> <span class="nav-text">负载均衡</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#静态网络配置"><span class="nav-number">3.3.2.1.</span> <span class="nav-text">静态网络配置</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#可配置属性"><span class="nav-number">3.3.2.2.</span> <span class="nav-text">可配置属性</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#URI的几个属性"><span class="nav-number">3.3.2.2.1.</span> <span class="nav-text">URI的几个属性</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#NetworkConnector-Properties"><span class="nav-number">3.3.2.2.2.</span> <span class="nav-text">NetworkConnector Properties</span></a></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#动态网络配置"><span class="nav-number">3.3.2.3.</span> <span class="nav-text">动态网络配置</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息回流"><span class="nav-number">3.3.3.</span> <span class="nav-text">消息回流</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#消息副本"><span class="nav-number">3.3.4.</span> <span class="nav-text">消息副本</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">CodingPunk</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
