<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="Spring Cloud,框架,微服务," />










<meta name="description" content="在微服务调用过程中，如何防止服务雪崩？如何服务降级？">
<meta property="og:type" content="article">
<meta property="og:title" content="Hystrix原理及使用;">
<meta property="og:url" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/index.html">
<meta property="og:site_name" content="为了明天！">
<meta property="og:description" content="在微服务调用过程中，如何防止服务雪崩？如何服务降级？">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F.png">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E9%9B%AA%E5%B4%A9%E7%A4%BA%E6%84%8F%E5%9B%BE.png">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%85%B3%E6%97%B6%E5%BA%8F%E5%9B%BE.png">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/Turbine%E5%8E%9F%E7%90%86.png">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/Hystrix%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5.png">
<meta property="og:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E6%96%AD%E8%B7%AF%E5%99%A8%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png">
<meta property="article:published_time" content="2020-08-03T11:36:29.000Z">
<meta property="article:modified_time" content="2020-08-23T11:43:00.182Z">
<meta property="article:author" content="OiPunk">
<meta property="article:tag" content="Spring Cloud">
<meta property="article:tag" content="框架">
<meta property="article:tag" content="微服务">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '作者'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/08/03/Hystrix原理及使用/"/>





  <title>Hystrix原理及使用; | 为了明天！</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    
    <a href="https://github.com/OiPunk" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>    
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">为了明天！</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">没伞的孩子，请努力奔跑</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            日志
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OiPunk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/oi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="为了明天！">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">Hystrix原理及使用;</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-08-03T19:36:29+08:00">
                2020-08-03
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          
              <div class="post-description">
                  在微服务调用过程中，如何防止服务雪崩？如何服务降级？
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="Hystrix"><a href="#Hystrix" class="headerlink" title="Hystrix"></a>Hystrix</h1><h2 id="1-概念："><a href="#1-概念：" class="headerlink" title="1 概念："></a>1 概念：</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>​        在分布式系统下，微服务之间不可避免地会发生相互调用，但每个系统都无法百分之百保证自身运行不出问题。在服务调用中，很可能面临依赖服务失效的问题（网络延时，服务异常，负载过大无法及时响应）。因此需要一个组件，能提供强大的容错能力，为服务间调用提供保护和控制。</p>
<p>我们的目的：<strong><em>当我自身 依赖的服务不可用时，服务自身不会被拖垮。防止微服务级联异常</em></strong>。</p>
<p>图。</p>
<p>本质：就是隔离坏的服务，不让坏服务拖垮其他服务（调用坏服务的服务）。</p>
<p>比如：武汉发生疫情，隔离它，不让依赖于武汉的地方感染。</p>
<p>和我们课程中熔断降级更贴切一点：北京从武汉招聘大学生，武汉有疫情了，当北京去武汉请求大学生来的时候，武汉熔断，然后北京启动自身的备用逻辑：去上海找大学生（降级）。</p>
<h3 id="舱壁模式"><a href="#舱壁模式" class="headerlink" title="舱壁模式"></a>舱壁模式</h3><p>舱壁模式（Bulkhead）隔离了每个工作负载或服务的关键资源，如连接池、内存和CPU，硬盘。每个工作单元都有独立的 连接池，内存，CPU。</p>
<p>使用舱壁避免了单个服务消耗掉所有资源，从而导致其他服务出现故障的场景。<br>这种模式主要是通过防止由一个服务引起的级联故障来增加系统的弹性。</p>
<p>据说泰坦尼克原因：泰坦尼克号上有16个防水舱，设计可以保障如果只有4个舱进水，密闭和隔离可以阻止水继续进入下一个防水舱，从而保证船的基本浮力。</p>
<p>但是当时冰山从侧面划破了船体，从而导致有5个防水舱同时进水，而为了建造豪华的头等舱大厅，也就是电影里杰克和罗斯约会的地方，5号舱的顶部并未达到密闭所需要的高度，水就一层层进入了船体，隔离的失败导致了泰坦尼克的沉没。</p>
<blockquote>
<p>舱壁模式<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E8%88%B1%E5%A3%81%E6%A8%A1%E5%BC%8F.png" alt="舱壁模式"></p>
</blockquote>
<p>给我们的思路：可以对每个请求设置，单独的连接池，配置连接数，不要影响 别的请求。就像一个一个的防水舱。</p>
<p>对在公司中的管理也一样：给每个独立的 小组，分配独立的资源，比如产品，开发，测试。在小公司，大多数情况 这些资源都是共享的，有一个好处是充分利用资源，坏处是，如果一个项目延期，会影响别的项目推进。自己权衡利弊。</p>
<p>最近比较火的一句话： 真正的知识，是 产品提高一个等级和成本提高0.2元的 痛苦抉择。</p>
<h3 id="雪崩效应"><a href="#雪崩效应" class="headerlink" title="雪崩效应"></a>雪崩效应</h3><p>​        每个服务 发出一个HTTP请求都会 在 服务中 开启一个新线程。而下游服务挂了或者网络不可达，通常线程会阻塞住，直到Timeout。如果并发量多一点，这些阻塞的线程就会占用大量的资源，很有可能把自己本身这个微服务所在的机器资源耗尽，导致自己也挂掉。</p>
<p>​        如果服务提供者响应非常缓慢，那么服务消费者调用此提供者就会一直等待，直到提供者响应或超时。在高并发场景下，此种情况，如果不做任何处理，就会导致服务消费者的资源耗竭甚至整个系统的崩溃。一层一层的崩溃，导致所有的系统崩溃。</p>
<blockquote>
<p>《雪崩示意图》<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E9%9B%AA%E5%B4%A9%E7%A4%BA%E6%84%8F%E5%9B%BE.png" alt="雪崩示意图"></p>
</blockquote>
<p>​        雪崩：由基础服务故障导致级联故障的现象。描述的是：提供者不可用 导致消费者不可用，并将不可用逐渐放大的过程。像滚雪球一样，不可用的服务越来越多。影响越来越恶劣。</p>
<p>雪崩三个流程：</p>
<p>服务提供者不可用</p>
<p>重试会导致网络流量加大，更影响服务提供者。</p>
<p>导致服务调用者不可用，由于服务调用者 一直等待返回，一直占用系统资源。</p>
<p>（不可用的范围 被逐步放大）</p>
<p>服务不可用原因：</p>
<p>服务器宕机</p>
<p>网络故障</p>
<p>宕机</p>
<p>程序异常</p>
<p>负载过大，导致服务提供者响应慢</p>
<p>缓存击穿导致服务超负荷运行</p>
<p>总之 ： 基础服务故障  导致 级联故障   就是  雪崩。</p>
<h3 id="容错机制"><a href="#容错机制" class="headerlink" title="容错机制"></a>容错机制</h3><ol>
<li><p>为网络请求设置超时。</p>
<p>必须为网络请求设置超时。一般的调用一般在几十毫秒内响应。如果服务不可用，或者网络有问题，那么响应时间会变很长。长到几十秒。</p>
<p>每一次调用，对应一个线程或进程，如果响应时间长，那么线程就长时间得不到释放，而线程对应着系统资源，包括CPU,内存，得不到释放的线程越多，资源被消耗的越多，最终导致系统崩溃。</p>
<p>因此必须设置超时时间，让资源尽快释放。</p>
</li>
<li><p>使用断路器模式。</p>
<p>想一下家里的保险丝，跳闸。如果家里有短路或者大功率电器使用，超过电路负载时，就会跳闸，如果不跳闸，电路烧毁，波及到其他家庭，导致其他家庭也不可用。通过跳闸保护电路安全，当短路问题，或者大功率问题被解决，在合闸。</p>
<p>自己家里电路，不影响整个小区每家每户的电路。</p>
</li>
</ol>
<h3 id="断路器"><a href="#断路器" class="headerlink" title="断路器"></a>断路器</h3><pre><code>如果对某个微服务请求有大量超时（说明该服务不可用），再让新的请求访问该服务就没有意义，只会无谓的消耗资源。例如设置了超时时间1s，如果短时间内有大量的请求无法在1s内响应，就没有必要去请求依赖的服务了。</code></pre><ol>
<li><p>断路器是对容易导致错误的操作的代理。这种代理能统计一段时间内的失败次数，并依据次数决定是正常请求依赖的服务还是直接返回。</p>
</li>
<li><p>断路器可以实现快速失败，如果它在一段时间内检测到许多类似的错误（超时），就会在之后的一段时间，强迫对该服务的调用快速失败，即不再请求所调用的服务。这样对于消费者就无须再浪费CPU去等待长时间的超时。</p>
</li>
<li><p>断路器也可自动诊断依赖的服务是否恢复正常。如果发现依赖的服务已经恢复正常，那么就会恢复请求该服务。通过重置时间来决定断路器的重新闭合。</p>
<p>这样就实现了微服务的“自我修复”：当依赖的服务不可用时，打开断路器，让服务快速失败，从而防止雪崩。当依赖的服务恢复正常时，又恢复请求。</p>
</li>
</ol>
<blockquote>
<p>断路器开关时序图<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E6%96%AD%E8%B7%AF%E5%99%A8%E5%BC%80%E5%85%B3%E6%97%B6%E5%BA%8F%E5%9B%BE.png" alt="断路器开关时序图"></p>
</blockquote>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">第一次正常</span><br><span class="line"></span><br><span class="line">第二次提供者异常</span><br><span class="line"></span><br><span class="line">提供者多次异常后，断路器打开</span><br><span class="line"></span><br><span class="line">后续请求，则直接降级，走备用逻辑。</span><br></pre></td></tr></table></figure>



<p>​    断路器状态转换的逻辑：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">关闭状态：正常情况下，断路器关闭，可以正常请求依赖的服务。</span><br><span class="line"></span><br><span class="line">打开状态：当一段时间内，请求失败率达到一定阈值，断路器就会打开。服务请求不会去请求依赖的服务。调用方直接返回。不发生真正的调用。重置时间过后，进入半开模式。</span><br><span class="line"></span><br><span class="line">半开状态：断路器打开一段时间后，会自动进入“半开模式”，此时，断路器允许一个服务请求访问依赖的服务。如果此请求成功(或者成功达到一定比例)，则关闭断路器，恢复正常访问。否则，则继续保持打开状态。</span><br><span class="line"></span><br><span class="line">断路器的打开，能保证服务调用者在调用异常服务时，快速返回结果，避免大量的同步等待，减少服务调用者的资源消耗。并且断路器能在打开一段时间后继续侦测请求执行结果，判断断路器是否能关闭，恢复服务的正常调用。</span><br></pre></td></tr></table></figure>

<blockquote>
<p>《熔断.doc》《断路器开关时序图》《状态转换》</p>
</blockquote>
<h3 id="降级"><a href="#降级" class="headerlink" title="降级"></a>降级</h3><p>为了在整体资源不够的时候，适当放弃部分服务，将主要的资源投放到核心服务中，待渡过难关之后，再重启已关闭的服务，保证了系统核心服务的稳定。当服务停掉后，自动进入fallback替换主方法。</p>
<p>用fallback方法代替主方法执行并返回结果，对失败的服务进行降级。当调用服务失败次数在一段时间内超过了断路器的阈值时，断路器将打开，不再进行真正的调用，而是快速失败，直接执行fallback逻辑。服务降级保护了服务调用者的逻辑。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">熔断和降级：</span><br><span class="line">共同点：</span><br><span class="line">	1、为了防止系统崩溃，保证主要功能的可用性和可靠性。</span><br><span class="line">	2、用户体验到某些功能不能用。</span><br><span class="line">不同点：</span><br><span class="line">	1、熔断由下级故障触发，主动惹祸。</span><br><span class="line">	2、降级由调用方从负荷角度触发，无辜被抛弃。</span><br></pre></td></tr></table></figure>



<p>19年春晚 百度 红包，凤巢的5万台机器熄火4小时，让给了红包。</p>
<h3 id="Hystrix-1"><a href="#Hystrix-1" class="headerlink" title="Hystrix"></a>Hystrix</h3><p>spring cloud 用的是 hystrix，是一个容错组件。</p>
<p>Hystrix实现了 超时机制和断路器模式。</p>
<p>Hystrix是Netflix开源的一个类库，用于隔离远程系统、服务或者第三方库，防止级联失败，从而提升系统的可用性与容错性。主要有以下几点功能：</p>
<ol>
<li>为系统提供保护机制。在依赖的服务出现高延迟或失败时，为系统提供保护和控制。</li>
<li>防止雪崩。</li>
<li>包裹请求：使用HystrixCommand（或HystrixObservableCommand）包裹对依赖的调用逻辑，每个命令在独立线程中运行。</li>
<li>跳闸机制：当某服务失败率达到一定的阈值时，Hystrix可以自动跳闸，停止请求该服务一段时间。</li>
<li>资源隔离：Hystrix为每个请求都的依赖都维护了一个小型线程池，如果该线程池已满，发往该依赖的请求就被立即拒绝，而不是排队等候，从而加速失败判定。防止级联失败。</li>
<li>快速失败：Fail Fast。同时能快速恢复。侧重点是：（不去真正的请求服务，发生异常再返回），而是直接失败。</li>
<li>监控：Hystrix可以实时监控运行指标和配置的变化，提供近实时的监控、报警、运维控制。</li>
<li>回退机制：fallback，当请求失败、超时、被拒绝，或当断路器被打开时，执行回退逻辑。回退逻辑我们自定义，提供优雅的服务降级。</li>
<li>自我修复：断路器打开一段时间后，会自动进入“半开”状态，可以进行打开，关闭，半开状态的转换。前面有介绍。</li>
</ol>
<h2 id="2-Hystrix-使用"><a href="#2-Hystrix-使用" class="headerlink" title="2 Hystrix 使用"></a>2 Hystrix 使用</h2><h3 id="hystrix独立使用脱离spring-cloud"><a href="#hystrix独立使用脱离spring-cloud" class="headerlink" title="hystrix独立使用脱离spring cloud"></a>hystrix独立使用脱离spring cloud</h3><p>代码：study-hystrix项目，HelloWorldHystrixCommand类。看着类讲解。</p>
<p>关注点：</p>
<p>继承hystrixCommand</p>
<p>重写run</p>
<p>fallback（程序发生非HystrixBadRequestException异常，运行超时，熔断开关打开，线程池/信号量满了）</p>
<p>熔断（熔断机制相当于电路的跳闸功能，我们可以配置熔断策略为当请求错误比例在10s内&gt;50%时，该服务将进入熔断状态，后续请求都会进入fallback。）</p>
<p>结果缓存（支持将一个请求结果缓存起来，下一个具有相同key的请求将直接从缓存中取出结果，减少请求开销。）</p>
<p>这个例子，只是独立使用hystrix，  通过这个例子，了解 hystrix 的运行逻辑。</p>
<h3 id="和restTemplate结合"><a href="#和restTemplate结合" class="headerlink" title="和restTemplate结合"></a>和restTemplate结合</h3><p>在api-driver（服务消费端）中：</p>
<p>pom.xml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;!-- 引入hystrix依赖 --&gt;</span><br><span class="line">		&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-hystrix&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableCircuitBreaker</span><br></pre></td></tr></table></figure>

<p>调用的方法上，通过使用@HystrixCommand，将方法纳入到hystrix监控中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCommand(fallbackMethod = <span class="string">"sendFail"</span>)</span><br><span class="line"></span><br><span class="line">下面的service，功能只是：调用service-sms服务。</span><br><span class="line">RestTemplateRequestServiceImpl中的smsSend</span><br></pre></td></tr></table></figure>



<p>sendFail，此处需要注意：此方法的 请求参数和 返回参数 要和原方法一致。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">private ResponseResult sendFail(SmsSendRequest smsSendRequest) &#123;</span><br><span class="line">	</span><br><span class="line">	//备用逻辑</span><br><span class="line">	<span class="built_in">return</span> ResponseResult.fail(-3, <span class="string">"熔断"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>正常调用：启动eureka-7900，service-sms 8002，api-driver。</p>
<p>测试点：</p>
<ol>
<li>访问sms是否正常。</li>
<li>访问yapi：api-driver下：司机获取验证码。是否正常。</li>
<li>停止service-sms。访问司机获取验证码，是否走备用逻辑。</li>
</ol>
<p>两个注解@EnableCircuitBreaker，@EnableHystrix点进去看，其实一样。</p>
<p>点@EnableHystrix进去。</p>
<p>ps：配置：HystrixCommandProperties</p>
<p>写好方法封装restTemplate 请求的service。一般将HystrixCommand，写在此service。也可以扩大范围。</p>
<p>上面的例子中，如果不走熔断的备用方法，则，停止提供者时，会抛出500错误。</p>
<p>更多的配置：</p>
<p>点击@HystrixCommand 进去。可以看到很多配置项。</p>
<p>下面说一下：commandProperties。</p>
<p><a href="https://github.com/Netflix/Hystrix/wiki/Configuration" target="_blank" rel="noopener">https://github.com/Netflix/Hystrix/wiki/Configuration</a></p>
<p>打开官网，对比着看一下。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">1、Execution：</span><br><span class="line">用来控制HystrixCommand.run()的执行</span><br><span class="line">具体意义：</span><br><span class="line">execution.isolation.strategy：该属性用来设置HystrixCommand.run()执行的隔离策略。默认为THREAD。</span><br><span class="line">execution.isolation.thread.timeoutInMilliseconds：该属性用来配置HystrixCommand执行的超时时间，单位为毫秒。</span><br><span class="line">execution.timeout.enabled：该属性用来配置HystrixCommand.run()的执行是否启用超时时间。默认为<span class="literal">true</span>。</span><br><span class="line">execution.isolation.thread.interruptOnTimeout：该属性用来配置当HystrixCommand.run()执行超时的时候是否要它中断。</span><br><span class="line">execution.isolation.thread.interruptOnCancel：该属性用来配置当HystrixCommand.run()执行取消时是否要它中断。</span><br><span class="line">execution.isolation.semaphore.maxConcurrentRequests：当HystrixCommand命令的隔离策略使用信号量时，该属性用来配置信号量的大小。当最大并发请求达到该设置值时，后续的请求将被拒绝。</span><br><span class="line"></span><br><span class="line">2、Fallback：</span><br><span class="line">用来控制HystrixCommand.getFallback()的执行</span><br><span class="line">fallback.isolation.semaphore.maxConcurrentRequests：该属性用来设置从调用线程中允许HystrixCommand.getFallback()方法执行的最大并发请求数。当达到最大并发请求时，后续的请求将会被拒绝并抛出异常。</span><br><span class="line">fallback.enabled：该属性用来设置服务降级策略是否启用，默认是<span class="literal">true</span>。如果设置为<span class="literal">false</span>，当请求失败或者拒绝发生时，将不会调用HystrixCommand.getFallback()来执行服务降级逻辑。</span><br><span class="line"></span><br><span class="line">mock。</span><br><span class="line"></span><br><span class="line">3、Circuit Breaker：用来控制HystrixCircuitBreaker的行为。</span><br><span class="line">circuitBreaker.enabled：确定当服务请求命令失败时，是否使用断路器来跟踪其健康指标和熔断请求。默认为<span class="literal">true</span>。</span><br><span class="line">circuitBreaker.requestVolumeThreshold：用来设置在滚动时间窗中，断路器熔断的最小请求数。例如，默认该值为20的时候，如果滚动时间窗（默认10秒）内仅收到19个请求，即使这19个请求都失败了，断路器也不会打开。</span><br><span class="line">circuitBreaker.sleepWindowInMilliseconds：用来设置当断路器打开之后的休眠时间窗。休眠时间窗结束之后，会将断路器设置为“半开”状态，尝试熔断的请求命令，如果依然时候就将断路器继续设置为“打开”状态，如果成功，就设置为“关闭”状态。</span><br><span class="line">circuitBreaker.errorThresholdPercentage：该属性用来设置断路器打开的错误百分比条件。默认值为50，表示在滚动时间窗中，在请求值超过requestVolumeThreshold阈值的前提下，如果错误请求数百分比超过50，就把断路器设置为“打开”状态，否则就设置为“关闭”状态。</span><br><span class="line">circuitBreaker.forceOpen：该属性默认为<span class="literal">false</span>。如果该属性设置为<span class="literal">true</span>，断路器将强制进入“打开”状态，它会拒绝所有请求。该属性优于forceClosed属性。</span><br><span class="line">circuitBreaker.forceClosed：该属性默认为<span class="literal">false</span>。如果该属性设置为<span class="literal">true</span>，断路器强制进入“关闭”状态，它会接收所有请求。如果forceOpen属性为<span class="literal">true</span>，该属性不生效。</span><br><span class="line"></span><br><span class="line">4、Metrics：该属性与HystrixCommand和HystrixObservableCommand执行中捕获的指标相关。</span><br><span class="line">metrics.rollingStats.timeInMilliseconds：该属性用来设置滚动时间窗的长度，单位为毫秒。该时间用于断路器判断健康度时需要收集信息的持续时间。断路器在收集指标信息时会根据设置的时间窗长度拆分成多个桶来累计各度量值，每个桶记录了一段时间的采集指标。例如，当为默认值10000毫秒时，断路器默认将其分成10个桶，每个桶记录1000毫秒内的指标信息。</span><br><span class="line">metrics.rollingStats.numBuckets：用来设置滚动时间窗统计指标信息时划分“桶”的数量。默认值为10。</span><br><span class="line">metrics.rollingPercentile.enabled：用来设置对命令执行延迟是否使用百分位数来跟踪和计算。默认为<span class="literal">true</span>，如果设置为<span class="literal">false</span>，那么所有的概要统计都将返回-1。</span><br><span class="line">metrics.rollingPercentile.timeInMilliseconds：用来设置百分位统计的滚动窗口的持续时间，单位为毫秒。</span><br><span class="line">metrics.rollingPercentile.numBuckets：用来设置百分位统计滚动窗口中使用桶的数量。</span><br><span class="line">metrics.rollingPercentile.bucketSize：用来设置每个“桶”中保留的最大执行数。</span><br><span class="line">metrics.healthSnapshot.intervalInMilliseconds：用来设置采集影响断路器状态的健康快照的间隔等待时间。</span><br><span class="line"></span><br><span class="line">5、Request Context：涉及HystrixCommand使用HystrixRequestContext的设置。</span><br><span class="line">requestCache.enabled：用来配置是否开启请求缓存。</span><br><span class="line">requestLog.enabled：用来设置HystrixCommand的执行和事件是否打印到日志的HystrixRequestLog中。</span><br></pre></td></tr></table></figure>



<p>通过下面例子，说一下配置方法。大家下去可以参考上面 看需要试试。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">将下面  值  写成<span class="literal">false</span></span><br><span class="line">@HystrixCommand(fallbackMethod = <span class="string">"sendFail"</span>,ignoreExceptions = &#123;HystrixIgnoreException.class&#125;,</span><br><span class="line">	commandProperties = &#123;</span><br><span class="line">			@HystrixProperty(name = <span class="string">"fallback.enabled"</span>,value = <span class="string">"false"</span>)</span><br><span class="line">			</span><br><span class="line">	&#125;)</span><br><span class="line"></span><br><span class="line">则请求，如果熔断，报500，</span><br><span class="line"></span><br><span class="line">改成<span class="literal">true</span>，则走熔断逻辑。</span><br><span class="line"></span><br><span class="line">测试点：</span><br><span class="line">1.默认熔断走降级逻辑。</span><br><span class="line">2.false后，报500.</span><br><span class="line">3.改成<span class="literal">true</span>后，走降级逻辑。</span><br></pre></td></tr></table></figure>





<h3 id="和feign结合"><a href="#和feign结合" class="headerlink" title="和feign结合"></a>和feign结合</h3><p>api-passenger</p>
<p>上面的pom一样。</p>
<p>feign自带Hystrix，但是默认没有打开，首先打开Hystrix。(从Spring Cloud Dalston开始，feign的Hystrix 默认关闭，如果要用feign，必须开启)</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">feign:</span><br><span class="line">  hystrix:</span><br><span class="line">    enabled: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>注解添加feignclient</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(name = <span class="string">"service-sms"</span>,fallback = SmsClientFallback.class)</span><br></pre></td></tr></table></figure>

<p>类，实现feignClient接口</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">import java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line">import org.apache.commons.lang.StringUtils;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.redis.core.StringRedisTemplate;</span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import com.online.taxi.common.dto.ResponseResult;</span><br><span class="line">import com.online.taxi.common.dto.sms.SmsSendRequest;</span><br><span class="line">import com.online.taxi.passenger.service.SmsClient;</span><br><span class="line">/**</span><br><span class="line"> * @author yueyi2019</span><br><span class="line"> */</span><br><span class="line">@Component</span><br><span class="line">public class SmsClientFallback implements SmsClient &#123;</span><br><span class="line"></span><br><span class="line">	</span><br><span class="line">	@Override</span><br><span class="line">	public ResponseResult sendSms(SmsSendRequest smsSendRequest) &#123;</span><br><span class="line">		System.out.println(<span class="string">"不好意思，我熔断了"</span>);</span><br><span class="line">		</span><br><span class="line">		<span class="built_in">return</span> ResponseResult.fail(-3, <span class="string">"feign熔断"</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">@EnableFeignClients</span><br><span class="line">@EnableCircuitBreaker</span><br></pre></td></tr></table></figure>

<p>正常调用：启动eureka-7900，service-sms 8002，api-passenger。</p>
<p>测试点：</p>
<ol>
<li><p>访问sms是否正常。</p>
</li>
<li><p>访问yapi：api-passenger下：乘客获取验证码。是否正常。</p>
</li>
<li><p>停止service-sms。访问乘客获取验证码，是否走备用逻辑。</p>
</li>
<li><p>去掉yml中熔断改成false。  熔断是否生效。</p>
<p>feign:</p>
<p>  hystrix:</p>
<pre><code>enabled: false </code></pre></li>
</ol>
<h3 id="所有（restTemplate和feign）配置默认值"><a href="#所有（restTemplate和feign）配置默认值" class="headerlink" title="所有（restTemplate和feign）配置默认值"></a>所有（restTemplate和feign）配置默认值</h3><p>HystrixCommandProperties</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">/* --------------统计相关------------------*/ </span><br><span class="line">// 统计滚动的时间窗口,默认:5000毫秒（取自circuitBreakerSleepWindowInMilliseconds）   </span><br><span class="line">private final HystrixProperty metricsRollingStatisticalWindowInMilliseconds;   </span><br><span class="line">// 统计窗口的Buckets的数量,默认:10个,每秒一个Buckets统计   </span><br><span class="line">private final HystrixProperty metricsRollingStatisticalWindowBuckets; // number of buckets <span class="keyword">in</span> the statisticalWindow   </span><br><span class="line">// 是否开启监控统计功能,默认:<span class="literal">true</span>   </span><br><span class="line">private final HystrixProperty metricsRollingPercentileEnabled;   </span><br><span class="line">/* --------------熔断器相关------------------*/ </span><br><span class="line">// 熔断器在整个统计时间内是否开启的阀值，默认20。也就是在metricsRollingStatisticalWindowInMilliseconds（默认10s）内至少请求20次，熔断器才发挥起作用   </span><br><span class="line">private final HystrixProperty circuitBreakerRequestVolumeThreshold;   </span><br><span class="line">// 熔断时间窗口，默认:5秒.熔断器中断请求5秒后会进入半打开状态,放下一个请求进来重试，如果该请求成功就关闭熔断器，否则继续等待一个熔断时间窗口</span><br><span class="line">private final HystrixProperty circuitBreakerSleepWindowInMilliseconds;   </span><br><span class="line">//是否启用熔断器,默认<span class="literal">true</span>. 启动   </span><br><span class="line">private final HystrixProperty circuitBreakerEnabled;   </span><br><span class="line">//默认:50%。当出错率超过50%后熔断器启动</span><br><span class="line">private final HystrixProperty circuitBreakerErrorThresholdPercentage;  </span><br><span class="line">//是否强制开启熔断器阻断所有请求,默认:<span class="literal">false</span>,不开启。置为<span class="literal">true</span>时，所有请求都将被拒绝，直接到fallback </span><br><span class="line">private final HystrixProperty circuitBreakerForceOpen;   </span><br><span class="line">//是否允许熔断器忽略错误,默认<span class="literal">false</span>, 不开启   </span><br><span class="line">private final HystrixProperty circuitBreakerForceClosed; </span><br><span class="line">/* --------------信号量相关------------------*/ </span><br><span class="line">//使用信号量隔离时，命令调用最大的并发数,默认:10   </span><br><span class="line">private final HystrixProperty executionIsolationSemaphoreMaxConcurrentRequests;   </span><br><span class="line">//使用信号量隔离时，命令fallback(降级)调用最大的并发数,默认:10   </span><br><span class="line">private final HystrixProperty fallbackIsolationSemaphoreMaxConcurrentRequests; </span><br><span class="line">/* --------------其他------------------*/ </span><br><span class="line">//使用命令调用隔离方式,默认:采用线程隔离,ExecutionIsolationStrategy.THREAD   </span><br><span class="line">private final HystrixProperty executionIsolationStrategy;   </span><br><span class="line">//使用线程隔离时，调用超时时间，默认:1秒   </span><br><span class="line">private final HystrixProperty executionIsolationThreadTimeoutInMilliseconds;   </span><br><span class="line">//线程池的key,用于决定命令在哪个线程池执行   </span><br><span class="line">private final HystrixProperty executionIsolationThreadPoolKeyOverride;   </span><br><span class="line">//是否开启fallback降级策略 默认:<span class="literal">true</span>   </span><br><span class="line">private final HystrixProperty fallbackEnabled;   </span><br><span class="line">// 使用线程隔离时，是否对命令执行超时的线程调用中断（Thread.interrupt()）操作.默认:<span class="literal">true</span>   </span><br><span class="line">private final HystrixProperty executionIsolationThreadInterruptOnTimeout; </span><br><span class="line">// 是否开启请求日志,默认:<span class="literal">true</span>   </span><br><span class="line">private final HystrixProperty requestLogEnabled;   </span><br><span class="line">//是否开启请求缓存,默认:<span class="literal">true</span>   </span><br><span class="line">private final HystrixProperty requestCacheEnabled; // Whether request caching is enabled.</span><br></pre></td></tr></table></figure>

<p>HystrixThreadPoolProperties</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">/* 配置线程池大小,默认值10个 */ </span><br><span class="line">private final HystrixProperty corePoolSize; </span><br><span class="line">/* 配置线程值等待队列长度,默认值:-1 建议值:-1表示不等待直接拒绝,测试表明线程池使用直接决绝策略+ 合适大小的非回缩线程池效率最高.所以不建议修改此值。 当使用非回缩线程池时，queueSizeRejectionThreshold,keepAliveTimeMinutes 参数无效 */</span><br><span class="line">private final HystrixProperty maxQueueSize;</span><br></pre></td></tr></table></figure>



<h3 id="捕获熔断的异常信息"><a href="#捕获熔断的异常信息" class="headerlink" title="捕获熔断的异常信息"></a>捕获熔断的异常信息</h3><ol>
<li>restTemplate中：</li>
</ol>
<p>在备用方法中 api-driver</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">public ResponseResult sendFail(ShortMsgRequest shortMsgRequest,Throwable throwable) &#123;</span><br><span class="line">	log.info(<span class="string">"异常信息："</span>+throwable);</span><br><span class="line">	//备用逻辑</span><br><span class="line">	<span class="built_in">return</span> ResponseResult.fail(-1, <span class="string">"熔断"</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>加上一个Throwable，就Ok。</p>
<p>上面例子跑一便。停止服务提供者，测试结果如下：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">2020-02-01 23:00:44.182  INFO [api-driver,f1100452d8b33b08,874b9cac5fe20385,<span class="literal">true</span>] 18088 --- [SmsController-1] c.o.t.driver.controller.SmsController    : 异常信息：java.lang.IllegalStateException: No instances available <span class="keyword">for</span> SERVICE-SMS</span><br></pre></td></tr></table></figure>



<p>不走异常，就走500方法。</p>
<ol start="2">
<li>feign中：</li>
</ol>
<p>注解</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(name = <span class="string">"service-sms"</span>,fallbackFactory = SmsClientFallbackFactory.class)</span><br></pre></td></tr></table></figure>

<p>factory类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.online.taxi.passenger.fallback;</span><br><span class="line"></span><br><span class="line">import org.springframework.stereotype.Component;</span><br><span class="line"></span><br><span class="line">import com.online.taxi.common.dto.ResponseResult;</span><br><span class="line">import com.online.taxi.common.dto.sms.SmsSendRequest;</span><br><span class="line">import com.online.taxi.passenger.feign.SmsClient;</span><br><span class="line"></span><br><span class="line">import feign.hystrix.FallbackFactory;</span><br><span class="line"></span><br><span class="line">@Component</span><br><span class="line">public class SmsClientFallbackFactory implements FallbackFactory&lt;SmsClient&gt; &#123;</span><br><span class="line"></span><br><span class="line">	@Override</span><br><span class="line">	public SmsClient create(Throwable cause) &#123;</span><br><span class="line">		<span class="built_in">return</span> new <span class="function"><span class="title">SmsClient</span></span>() &#123;</span><br><span class="line">			</span><br><span class="line">			@Override</span><br><span class="line">			public ResponseResult sendSms(SmsSendRequest smsSendRequest) &#123;</span><br><span class="line">				System.out.println(<span class="string">"feign异常："</span>+cause);</span><br><span class="line">				<span class="built_in">return</span> ResponseResult.fail(-3, <span class="string">"feign fallback factory熔断"</span>);</span><br><span class="line">			&#125;</span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">参数和返回值一样。匿名内部类。</span><br></pre></td></tr></table></figure>

<p>测试点：</p>
<ol>
<li>启动eureka 7900，api-driver,是否走降级方法。</li>
</ol>
<hr>
<ol start="3">
<li>忽略异常</li>
</ol>
<p>有些情况下，提供者是好的，但在消费者发生业务异常时，我们不希望走熔断的备用方法。则用以下两个办法。</p>
<ol>
<li>第一种方式：继承HystrixBadRequestException</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">自定义异常，继承HystrixBadRequestException，当发生此异常时，不走备用方法。</span><br><span class="line"></span><br><span class="line">public class BusinessException extends HystrixBadRequestException &#123;</span><br><span class="line">	</span><br><span class="line">	private String message;</span><br><span class="line">	</span><br><span class="line">	public BusinessException(String message) &#123;</span><br><span class="line">		super(message);</span><br><span class="line">		this.message = message;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 */</span><br><span class="line">	private static final long serialVersionUID = 1L;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">在调用的地方前：</span><br><span class="line">		// 下面是故意跑出异常代码</span><br><span class="line">		try &#123;</span><br><span class="line">			int i = 1/0;</span><br><span class="line">		&#125; catch (Exception e) &#123;</span><br><span class="line">			// TODO: handle exception</span><br><span class="line">			throw new BusinessException(<span class="string">"熔断忽略的异常"</span>);</span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<ol start="2">
<li>第二种方式：Hystrix属性配置。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">配置属性：</span><br><span class="line">@HystrixCommand(fallbackMethod = <span class="string">"sendFail"</span>,</span><br><span class="line">   ignoreExceptions = &#123;HystrixIgnoreException.class&#125;)</span><br><span class="line"></span><br><span class="line">自定义异常：</span><br><span class="line"></span><br><span class="line">public class HystrixIgnoreException extends RuntimeException &#123;</span><br><span class="line">	</span><br><span class="line">	private String message;</span><br><span class="line">	</span><br><span class="line">	public HystrixIgnoreException(String message) &#123;</span><br><span class="line">		this.message = message;</span><br><span class="line">	&#125;</span><br><span class="line">	</span><br><span class="line">	/**</span><br><span class="line">	 * </span><br><span class="line">	 */</span><br><span class="line">	private static final long serialVersionUID = 1L;</span><br><span class="line">	</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">此异常也不走备用逻辑。</span><br></pre></td></tr></table></figure>



<h3 id="禁用feign客户端的hystrix"><a href="#禁用feign客户端的hystrix" class="headerlink" title="禁用feign客户端的hystrix"></a>禁用feign客户端的hystrix</h3><p>为@feignclient单独配置Feign.Builder</p>
<p>配置类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">@Configuration</span><br><span class="line">@ExcudeFeignConfig</span><br><span class="line">public class FeignDisableHystrixConfiguration &#123;</span><br><span class="line">	</span><br><span class="line">	@Bean</span><br><span class="line">	@Scope(<span class="string">"prototype"</span>)</span><br><span class="line">	public Feign.Builder <span class="function"><span class="title">feignBuilder</span></span>()&#123;</span><br><span class="line">		<span class="built_in">return</span> Feign.builder();</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>注解</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@FeignClient(name = <span class="string">"service-sms"</span>,configuration = FeignDisableHystrixConfiguration.class)</span><br></pre></td></tr></table></figure>

<p>测试点：</p>
<p>启动eureka，api-passenger。测试发送验证码，是否走熔断。没走是正确，报500.</p>
<p>hystrix command 配置</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">@HystrixCommand(fallbackMethod = <span class="string">"sendFail"</span>,ignoreExceptions = &#123;HystrixIgnoreException.class&#125;,</span><br><span class="line">	commandProperties = &#123;</span><br><span class="line">			@HystrixProperty(name = <span class="string">"fallback.enabled"</span>,value = <span class="string">"true"</span>)</span><br><span class="line">	&#125;)</span><br></pre></td></tr></table></figure>







<p>操作步骤：</p>
<ol>
<li>启动eureka7900，service-sms 8002，api-driver 9002，</li>
<li>正常访问 yapi-&gt;api-driver-&gt;司机获取验证码。正常。查看开关，UP。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9002/actuator/health</span><br><span class="line"></span><br><span class="line">hystrix: &#123;</span><br><span class="line">status: <span class="string">"UP"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="3">
<li>关闭 service-sms 8002。</li>
<li>打开jemeter，（检查jmeter设置，api-driver设置日志为info。）设置1秒访问25次(默认10秒 20次，才开始熔断计算)。错误，熔断。查看开关.</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9002/actuator/health</span><br><span class="line"></span><br><span class="line">hystrix: &#123;</span><br><span class="line">status: <span class="string">"CIRCUIT_OPEN"</span>,</span><br><span class="line">details: &#123;</span><br><span class="line">openCircuitBreakers: [</span><br><span class="line"><span class="string">"RestTemplateRequestServiceImpl::smsSend"</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol start="5">
<li>恢复UP。启动service-sms 8002,成功请求一次yapi中 司机发送验证码。查看开关。又变成了UP。</li>
</ol>
<p>熔断计算：先10秒20次，再算错误次数超过阈值 50%。</p>
<p>小结：</p>
<ol>
<li>注意上面发生的异常信息：有下面不同的2种。</li>
</ol>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">异常信息：java.lang.IllegalStateException: No instances available <span class="keyword">for</span> service-sms</span><br><span class="line"></span><br><span class="line">异常信息：java.lang.RuntimeException: Hystrix circuit short-circuited and is OPEN</span><br></pre></td></tr></table></figure>

<ol start="2">
<li><p>上节课开关不生效.</p>
<p>原因：我最后讲 熔断忽略的异常时，走了忽略的异常，不走熔断。所以开关没打开。</p>
<p>此次熔断触发的条件：1、走熔断处理，2、依赖服务停止。</p>
<p>熔断恢复：1、底层服务启动，2、成功请求一次。</p>
</li>
</ol>
<p>课下问题:</p>
<ol>
<li>两个eureka，彼此注册，为什么 连个eureka里面都有 彼此。1向2注册，2将1信息同步给1,2向1注册。</li>
<li>eureka server中的url和eureka client 中的url没关系。没必要一致。</li>
</ol>
<h3 id="断路器开关演示"><a href="#断路器开关演示" class="headerlink" title="断路器开关演示"></a>断路器开关演示</h3><p>在项目中引入</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>访问健康地址：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">http://localhost:9002/actuator/health</span><br><span class="line">最开始：</span><br><span class="line">hystrix: &#123;</span><br><span class="line">status: <span class="string">"UP"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HystrixCommandProperties   default_circuitBreakerRequestVolumeThreshold（在hyxtrix的properties中设置）</span><br><span class="line">10秒内，20次失败（20 requests <span class="keyword">in</span> 10 seconds），则断路器打开。</span><br><span class="line">hystrix: &#123;</span><br><span class="line">status: <span class="string">"CIRCUIT_OPEN"</span>,</span><br><span class="line">details: &#123;</span><br><span class="line">openCircuitBreakers: [</span><br><span class="line"><span class="string">"SmsController::verifyCodeSend"</span></span><br><span class="line">]</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>相关的配置，主要是10秒20次，失败率超过 50%。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">Execution相关的属性的配置：</span><br><span class="line">hystrix.command.default.execution.isolation.strategy 隔离策略，默认是Thread, 可选Thread｜Semaphore</span><br><span class="line">thread 通过线程数量来限制并发请求数，可以提供额外的保护，但有一定的延迟。一般用于网络调用</span><br><span class="line">semaphore 通过semaphore count来限制并发请求数，适用于无网络的高并发请求</span><br><span class="line">hystrix.command.default.execution.isolation.thread.timeoutInMilliseconds 命令执行超时时间，默认1000ms</span><br><span class="line">hystrix.command.default.execution.timeout.enabled 执行是否启用超时，默认启用<span class="literal">true</span></span><br><span class="line">hystrix.command.default.execution.isolation.thread.interruptOnTimeout 发生超时是是否中断，默认<span class="literal">true</span></span><br><span class="line">hystrix.command.default.execution.isolation.semaphore.maxConcurrentRequests 最大并发请求数，默认10，该参数当使用ExecutionIsolationStrategy.SEMAPHORE策略时才有效。如果达到最大并发请求数，请求会被拒绝。理论上选择semaphore size的原则和选择thread size一致，但选用semaphore时每次执行的单元要比较小且执行速度快（ms级别），否则的话应该用thread。</span><br><span class="line">semaphore应该占整个容器（tomcat）的线程池的一小部分。</span><br><span class="line"></span><br><span class="line">Fallback相关的属性</span><br><span class="line">这些参数可以应用于Hystrix的THREAD和SEMAPHORE策略</span><br><span class="line">hystrix.command.default.fallback.isolation.semaphore.maxConcurrentRequests 如果并发数达到该设置值，请求会被拒绝和抛出异常并且fallback不会被调用。默认10</span><br><span class="line">hystrix.command.default.fallback.enabled 当执行失败或者请求被拒绝，是否会尝试调用hystrixCommand.getFallback() 。默认<span class="literal">true</span></span><br><span class="line"></span><br><span class="line">Circuit Breaker相关的属性</span><br><span class="line">hystrix.command.default.circuitBreaker.enabled 用来跟踪circuit的健康性，如果未达标则让request短路。默认<span class="literal">true</span></span><br><span class="line">hystrix.command.default.circuitBreaker.requestVolumeThreshold 一个rolling window内最小的请求数。如果设为20，那么当一个rolling window的时间内（比如说1个rolling window是10秒）收到19个请求，即使19个请求都失败，也不会触发circuit <span class="built_in">break</span>。默认20</span><br><span class="line">hystrix.command.default.circuitBreaker.sleepWindowInMilliseconds 触发短路的时间值，当该值设为5000时，则当触发circuit <span class="built_in">break</span>后的5000毫秒内都会拒绝request，也就是5000毫秒后才会关闭circuit。默认5000</span><br><span class="line">hystrix.command.default.circuitBreaker.errorThresholdPercentage错误比率阀值，如果错误率&gt;=该值，circuit会被打开，并短路所有请求触发fallback。默认50，即为50%。</span><br><span class="line">hystrix.command.default.circuitBreaker.forceOpen 强制打开熔断器，如果打开这个开关，那么拒绝所有request，默认<span class="literal">false</span></span><br><span class="line">hystrix.command.default.circuitBreaker.forceClosed 强制关闭熔断器 如果这个开关打开，circuit将一直关闭且忽略circuitBreaker.errorThresholdPercentage</span><br><span class="line"></span><br><span class="line">Metrics相关参数</span><br><span class="line">hystrix.command.default.metrics.rollingStats.timeInMilliseconds 设置统计的时间窗口值的，毫秒值，circuit <span class="built_in">break</span> 的打开会根据1个rolling window的统计来计算。若rolling window被设为10000毫秒，则rolling window会被分成n个buckets，每个bucket包含success，failure，timeout，rejection的次数的统计信息。默认10000</span><br><span class="line">hystrix.command.default.metrics.rollingStats.numBuckets 设置一个rolling window被划分的数量，若numBuckets＝10，rolling window＝10000，那么一个bucket的时间即1秒。必须符合rolling window % numberBuckets == 0。默认10</span><br><span class="line">hystrix.command.default.metrics.rollingPercentile.enabled 执行时是否<span class="built_in">enable</span>指标的计算和跟踪，默认<span class="literal">true</span></span><br><span class="line">hystrix.command.default.metrics.rollingPercentile.timeInMilliseconds 设置rolling percentile window的时间，默认60000</span><br><span class="line">hystrix.command.default.metrics.rollingPercentile.numBuckets 设置rolling percentile window的numberBuckets。逻辑同上。默认6</span><br><span class="line">hystrix.command.default.metrics.rollingPercentile.bucketSize 如果bucket size＝100，window＝10s，若这10s里有500次执行，只有最后100次执行会被统计到bucket里去。增加该值会增加内存开销以及排序的开销。默认100</span><br><span class="line">hystrix.command.default.metrics.healthSnapshot.intervalInMilliseconds 记录health 快照（用来统计成功和错误绿）的间隔，默认500ms</span><br></pre></td></tr></table></figure>



<h3 id="熔断强制配置"><a href="#熔断强制配置" class="headerlink" title="熔断强制配置"></a>熔断强制配置</h3><p>此处配置强制走熔断方法。。</p>
<p>api-driver中RestTemplateRequestServiceImpl</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">例子：</span><br><span class="line">@HystrixCommand(fallbackMethod = <span class="string">"sendFail"</span>,ignoreExceptions = &#123;HystrixIgnoreException.class&#125;,</span><br><span class="line">	commandProperties = &#123;</span><br><span class="line">			@HystrixProperty(name = <span class="string">"fallback.enabled"</span>,value = <span class="string">"true"</span>),</span><br><span class="line">			@HystrixProperty(name = <span class="string">"circuitBreaker.forceOpen"</span>,value = <span class="string">"true"</span>)</span><br><span class="line">			</span><br><span class="line">	&#125;)</span><br><span class="line">演示一下。</span><br></pre></td></tr></table></figure>

<p>测试点：启动eureka，service-sms，api-driver</p>
<ol>
<li><p>访问直接熔断。</p>
</li>
<li><p>将circuitBreaker.forceOpen改成false，正常返回，（默认为false）</p>
</li>
<li><p>观察异常信息。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">异常信息：java.lang.RuntimeException: Hystrix circuit short-circuited and is OPEN</span><br></pre></td></tr></table></figure>





</li>
</ol>
<h3 id="开关例子"><a href="#开关例子" class="headerlink" title="开关例子"></a>开关例子</h3><p>HelloWorldHystrixCommand2</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">调用次数:1   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:2   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:3   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:4   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:5   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:6   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:7   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:8   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:9   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:10   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:11   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:12   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:13   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:14   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:15   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:16   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:17   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:18   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:19   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:20   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:21   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:22   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:23   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:24   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:25   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:26   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:27   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:28   结果:正常调用 Hello testCircuitBreaker 开关是否打开: <span class="literal">false</span></span><br><span class="line">调用次数:29   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br><span class="line">调用次数:30   结果:熔断：fallback,name:testCircuitBreaker 开关是否打开: <span class="literal">true</span></span><br></pre></td></tr></table></figure>

<p>细看日志从里面找规律</p>
<ol>
<li>第10次，熔断开关才打开。之前的 异常 虽然也报错，但是开关没开。（10秒，9次）默认：10秒，20次。</li>
<li>后面有10-19次，总计5秒钟，因为我们设置程序 500毫秒执行。开关一直打开，都走的熔断。（开关打开）</li>
<li>第20次，距离第一次熔断过去了 5秒钟。断路器尝试放开一部分请求过去，正常了就关闭开关。（如果正常，开关关闭，否则，不关闭）</li>
<li>第29次，开关又打开。又到了下一个周期。</li>
</ol>
<h3 id="监控"><a href="#监控" class="headerlink" title="监控"></a>监控</h3><p>在服务消费端 api-driver，配置actuator,jar</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">	&lt;groupId&gt;org.springframework.boot&lt;/groupId&gt;</span><br><span class="line">	&lt;artifactId&gt;spring-boot-starter-actuator&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>通过event-stream暴露出来的。hystrix的jar包已经包含了下面这个jar包。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">没必要配。</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">				&lt;groupId&gt;com.netflix.hystrix&lt;/groupId&gt;</span><br><span class="line">				&lt;artifactId&gt;hystrix-metrics-event-stream&lt;/artifactId&gt;</span><br><span class="line">				&lt;version&gt;<span class="variable">$&#123;hystrix.version&#125;</span>&lt;/version&gt;</span><br><span class="line">				&lt;exclusions&gt;</span><br><span class="line">					&lt;exclusion&gt;</span><br><span class="line">						&lt;groupId&gt;javax.servlet&lt;/groupId&gt;</span><br><span class="line">						&lt;artifactId&gt;servlet-api&lt;/artifactId&gt;</span><br><span class="line">					&lt;/exclusion&gt;</span><br><span class="line">				&lt;/exclusions&gt;</span><br><span class="line">			&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>启动 eureka 7900，api-driver 9002，service-sms 8002。</p>
<p>地址：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">api-driver</span><br><span class="line">http://localhost:9002/actuator/hystrix.stream</span><br><span class="line"></span><br><span class="line">访问，会看到页面一直在ping。</span><br><span class="line"></span><br><span class="line">ping: </span><br><span class="line"></span><br><span class="line">data: &#123;<span class="string">"type"</span>:<span class="string">"HystrixCommand"</span>,<span class="string">"name"</span>:<span class="string">"SmsClient#sendSms(SmsSendRequest)"</span>,<span class="string">"group"</span>:<span class="string">"service-sms"</span>,<span class="string">"currentTime"</span>:1581931881830,<span class="string">"isCircuitBreakerOpen"</span>:<span class="literal">false</span>,<span class="string">"errorPercentage"</span>:0,<span class="string">"errorCount"</span>:0,<span class="string">"requestCount"</span>:1,<span class="string">"rollingCountBadRequests"</span>:0,<span class="string">"rollingCountCollapsedRequests"</span>:0,<span class="string">"rollingCountEmit"</span>:0,<span class="string">"rollingCountExceptionsThrown"</span>:0,<span class="string">"rollingCountFailure"</span>:0,<span class="string">"rollingCountFallbackEmit"</span>:0,<span class="string">"rollingCountFallbackFailure"</span>:0,<span class="string">"rollingCountFallbackMissing"</span>:0,<span class="string">"rollingCountFallbackRejection"</span>:0,<span class="string">"rollingCountFallbackSuccess"</span>:0,<span class="string">"rollingCountResponsesFromCache"</span>:0,<span class="string">"rollingCountSemaphoreRejected"</span>:0,<span class="string">"rollingCountShortCircuited"</span>:0,<span class="string">"rollingCountSuccess"</span>:0,<span class="string">"rollingCountThreadPoolRejected"</span>:0,<span class="string">"rollingCountTimeout"</span>:0,<span class="string">"currentConcurrentExecutionCount"</span>:0,<span class="string">"rollingMaxConcurrentExecutionCount"</span>:0,<span class="string">"latencyExecute_mean"</span>:0,<span class="string">"latencyExecute"</span>:&#123;<span class="string">"0"</span>:0,<span class="string">"25"</span>:0,<span class="string">"50"</span>:0,<span class="string">"75"</span>:0,<span class="string">"90"</span>:0,<span class="string">"95"</span>:0,<span class="string">"99"</span>:0,<span class="string">"99.5"</span>:0,<span class="string">"100"</span>:0&#125;,<span class="string">"latencyTotal_mean"</span>:0,<span class="string">"latencyTotal"</span>:&#123;<span class="string">"0"</span>:0,<span class="string">"25"</span>:0,<span class="string">"50"</span>:0,<span class="string">"75"</span>:0,<span class="string">"90"</span>:0,<span class="string">"95"</span>:0,<span class="string">"99"</span>:0,<span class="string">"99.5"</span>:0,<span class="string">"100"</span>:0&#125;,<span class="string">"propertyValue_circuitBreakerRequestVolumeThreshold"</span>:20,<span class="string">"propertyValue_circuitBreakerSleepWindowInMilliseconds"</span>:5000,<span class="string">"propertyValue_circuitBreakerErrorThresholdPercentage"</span>:50,<span class="string">"propertyValue_circuitBreakerForceOpen"</span>:<span class="literal">false</span>,<span class="string">"propertyValue_circuitBreakerForceClosed"</span>:<span class="literal">false</span>,<span class="string">"propertyValue_circuitBreakerEnabled"</span>:<span class="literal">true</span>,<span class="string">"propertyValue_executionIsolationStrategy"</span>:<span class="string">"THREAD"</span>,<span class="string">"propertyValue_executionIsolationThreadTimeoutInMilliseconds"</span>:1000,<span class="string">"propertyValue_executionTimeoutInMilliseconds"</span>:1000,<span class="string">"propertyValue_executionIsolationThreadInterruptOnTimeout"</span>:<span class="literal">true</span>,<span class="string">"propertyValue_executionIsolationThreadPoolKeyOverride"</span>:null,<span class="string">"propertyValue_executionIsolationSemaphoreMaxConcurrentRequests"</span>:10,<span class="string">"propertyValue_fallbackIsolationSemaphoreMaxConcurrentRequests"</span>:10,<span class="string">"propertyValue_metricsRollingStatisticalWindowInMilliseconds"</span>:10000,<span class="string">"propertyValue_requestCacheEnabled"</span>:<span class="literal">true</span>,<span class="string">"propertyValue_requestLogEnabled"</span>:<span class="literal">true</span>,<span class="string">"reportingHosts"</span>:1,<span class="string">"threadPool"</span>:<span class="string">"service-sms"</span>&#125;</span><br><span class="line"></span><br><span class="line">data: &#123;<span class="string">"type"</span>:<span class="string">"HystrixThreadPool"</span>,<span class="string">"name"</span>:<span class="string">"service-sms"</span>,<span class="string">"currentTime"</span>:1581931881830,<span class="string">"currentActiveCount"</span>:0,<span class="string">"currentCompletedTaskCount"</span>:1,<span class="string">"currentCorePoolSize"</span>:10,<span class="string">"currentLargestPoolSize"</span>:1,<span class="string">"currentMaximumPoolSize"</span>:10,<span class="string">"currentPoolSize"</span>:1,<span class="string">"currentQueueSize"</span>:0,<span class="string">"currentTaskCount"</span>:1,<span class="string">"rollingCountThreadsExecuted"</span>:0,<span class="string">"rollingMaxActiveThreads"</span>:0,<span class="string">"rollingCountCommandRejections"</span>:0,<span class="string">"propertyValue_queueSizeRejectionThreshold"</span>:5,<span class="string">"propertyValue_metricsRollingStatisticalWindowInMilliseconds"</span>:10000,<span class="string">"reportingHosts"</span>:1&#125;</span><br></pre></td></tr></table></figure>

<p>测试点：</p>
<p>重新 启动eureka7900，service-sms,api-driver</p>
<p>api-driver方。（此时注意，如果熔断了，查看forceOpen）</p>
<ol>
<li>访问<a href="http://localhost:9002/actuator/hystrix.stream。" target="_blank" rel="noopener">http://localhost:9002/actuator/hystrix.stream。</a></li>
<li>不发起任何请求，观察页面。一直ping。</li>
<li>发起正常请求（发送验证码），观察页面。ping回来data。查看data。</li>
<li>关闭service-sms，访问（jemeter）。查看data。在页面中搜索：”isCircuitBreakerOpen”:true</li>
</ol>
<p>feign和ribbon在这个点上是一样的操作。</p>
<h3 id="可视化"><a href="#可视化" class="headerlink" title="可视化"></a>可视化</h3><p>上面的操作有点原始，刀耕火种。下面可视化。</p>
<p>项目：hystrix-dashboard</p>
<p>pom</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-hystrix-dashboard&lt;/artifactId&gt;</span><br><span class="line">		&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableHystrixDashboard</span><br></pre></td></tr></table></figure>





<p>使用 重新启动eureka7900，service-sms,api-driver</p>
<p>访问：<a href="http://localhost:6101/hystrix" target="_blank" rel="noopener">http://localhost:6101/hystrix</a></p>
<p>输入：上面的地址：<a href="http://localhost:9002/actuator/hystrix.stream" target="_blank" rel="noopener">http://localhost:9002/actuator/hystrix.stream</a></p>
<p>停止 service-sms 8002 只留 eureka 7900和api-driver 9002</p>
<p>再发一次25次 jmeter。</p>
<p>查看面板，注意面板变化。</p>
<p>面板说明：</p>
<p>github：<a href="https://github.com/Netflix-Skunkworks/hystrix-dashboard" target="_blank" rel="noopener">https://github.com/Netflix-Skunkworks/hystrix-dashboard</a></p>
<p>解释：<a href="https://github.com/Netflix-Skunkworks/hystrix-dashboard/wiki" target="_blank" rel="noopener">https://github.com/Netflix-Skunkworks/hystrix-dashboard/wiki</a></p>
<blockquote>
<p>《熔断》</p>
</blockquote>
<p>无需纠结它只能监控10秒的信息，因为如果出问题，会一直报问题。</p>
<h3 id="集中可视化"><a href="#集中可视化" class="headerlink" title="集中可视化"></a>集中可视化</h3><p>上面的方法只能监控一个服务。实际生产中不方便。</p>
<blockquote>
<p>《Turbine原理》<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/Turbine%E5%8E%9F%E7%90%86.png" alt="Turbine原理"></p>
</blockquote>
<p>下面接着改造。</p>
<p>创建study-hystrix-turbine</p>
<p>pom</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">			&lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">			&lt;artifactId&gt;spring-cloud-starter-netflix-turbine&lt;/artifactId&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;!-- eureka客户端 --&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;org.springframework.cloud&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;spring-cloud-starter-netflix-eureka-client&lt;/artifactId&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>yml</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">turbine:</span><br><span class="line">  app-config: api-driver,api-passenger</span><br><span class="line">  cluster-name-expression: <span class="string">"'default'"</span></span><br></pre></td></tr></table></figure>

<p>启动类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">@EnableTurbine</span><br></pre></td></tr></table></figure>

<p>地址：<a href="http://localhost:6102/turbine.stream,也是一直ping，相当于原来的hystrix.stream,不过此处是综合了所有的项目。" target="_blank" rel="noopener">http://localhost:6102/turbine.stream,也是一直ping，相当于原来的hystrix.stream,不过此处是综合了所有的项目。</a></p>
<p>启动hystrix-dashboard。</p>
<p>访问：<a href="http://localhost:6101/hystrix" target="_blank" rel="noopener">http://localhost:6101/hystrix</a></p>
<p>填上上面的地址：<a href="http://localhost:6102/turbine.stream" target="_blank" rel="noopener">http://localhost:6102/turbine.stream</a></p>
<p>此时注意测试api-driver,api-passenger两个服务。在《熔断中有效果》</p>
<p>停一下service-sms，看界面。</p>
<h2 id="3-原理"><a href="#3-原理" class="headerlink" title="3 原理"></a>3 原理</h2><p>了解前面一些概念：舱壁模式，命令模式（下面），雪崩，容错，断路器，降级。</p>
<p>熔断降级：北京去武汉招大学生的例子。</p>
<p>资源隔离：类似于高铁高架桥，并不是一个整体，而是一块一块的拼装的，一段路坏了，不会影响整条路。</p>
<h3 id="隔离策略"><a href="#隔离策略" class="headerlink" title="隔离策略"></a>隔离策略</h3><p>概念中的舱壁模式。想一下货船上，每个货仓中间的隔离。两个好处：</p>
<ol>
<li>服务提供者高延迟或异常，不会影响到整个系统的失败。</li>
<li>能够控制每个调用者的并发度。因为有独立的线程池。</li>
</ol>
<p>两种线程隔离策略：线程池（默认）、信号量。</p>
<blockquote>
<p>《Hystrix隔离策略》<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/Hystrix%E9%9A%94%E7%A6%BB%E7%AD%96%E7%95%A5.png" alt="Hystrix隔离策略"></p>
</blockquote>
<p>@HystrixCommand注释修饰一个服务时，HystrixCommand的运行逻辑有可能是在该请求的主线程上一并执行，也有可能是单独起一个线程来执行，这取决于我们如何设置Hystrix线程的隔离策略。<br>execution.isolation.strategy属性就是用来设置HystrixCommand.run()执行的隔离策略的。（回忆上面讲过的配置，设置线程策略的）</p>
<p>两种隔离策略：线程隔离和信号量隔离，即“THREAD”和“SEMAPHORE”，系统默认为“THREAD”。<br>它们的含义是：</p>
<p>THREAD(线程隔离）：使用该方式，HystrixCommand将会在单独的线程上执行，并发请求受线程池中线程数量的限制。不同服务通过使用不同线程池，彼此间将不受影响，达到隔离效果。</p>
<p>此种隔离方式：将调用服务线程与服务访问的执行线程分割开来，调用线程能够空出来去做其他工作，而不至于因为服务调用的执行，阻塞过长时间。</p>
<p>hystrix将使用独立的线程池对应每一个服务提供者，用于隔离和限制这些服务。于是某个服务提供者的高延迟或者资源受限只会发生在该服务提供者对应的线程池中。</p>
<p>SEMAPHORE（信号量隔离）：其实就是个计数器，使用该方式，HystrixCommand将会在调用线程上执行，通过信号量限制单个服务提供者的并发量，开销相对较小（因为不用那么多线程池），并发请求受到信号量个数的限制。 线程隔离会带来线程开销，有些场景（比如无网络请求场景）可能会因为用开销换隔离得不偿失，为此hystrix提供了信号量隔离，当服务的并发数大于信号量阈值时将进入fallback。</p>
<p>Hystrix中默认并且推荐使用线程隔离（THREAD)，<br>一般来说，只有当调用负载异常高时（例如每个实例每秒调用数百次）才需要信号量隔离，因为这种场景下使用THREAD开销会比较高。信号量隔离一般仅适用于非网络调用的隔离。 </p>
<p>正常情况下，默认为线程隔离, 保持默认即可。</p>
<p>取舍：</p>
<p>线程池和信号量都支持熔断和限流。相比线程池，信号量不需要线程切换，因此避免了不必要的开销。但是信号量不支持异步，也不支持超时，也就是说当所请求的服务不可用时，信号量会控制超过限制的请求立即返回，但是已经持有信号量的线程只能等待服务响应或从超时中返回，即可能出现长时间等待。线程池模式下，当超过指定时间未响应的服务，Hystrix会通过响应中断的方式通知线程立即结束并返回。</p>
<h3 id="Hystrix实现思路"><a href="#Hystrix实现思路" class="headerlink" title="Hystrix实现思路"></a>Hystrix实现思路</h3><ol>
<li><p>请求过来时，将请求的远程调用逻辑，封装到HystrixCommand或者HystrixObservableCommand对象（并在构造方法配置请求被执行需要的参数）中，这些远程调用将会在独立的线程中执行。（资源隔离、命令模式）。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">https://www.runoob.com/design-pattern/<span class="built_in">command</span>-pattern.html</span><br><span class="line">介绍</span><br><span class="line">意图：将一个请求封装成一个对象，从而使您可以用不同的请求对客户进行参数化。</span><br><span class="line"></span><br><span class="line">主要解决：在软件系统中，行为请求者与行为实现者通常是一种紧耦合的关系，但某些场合，比如需要对行为进行记录、撤销或重做、事务等处理时，这种无法抵御变化的紧耦合的设计就不太合适。</span><br><span class="line"></span><br><span class="line">何时使用：在某些场合，比如要对行为进行<span class="string">"记录、撤销/重做、事务"</span>等处理，这种无法抵御变化的紧耦合是不合适的。在这种情况下，如何将<span class="string">"行为请求者"</span>与<span class="string">"行为实现者"</span>解耦？将一组行为抽象为对象，可以实现二者之间的松耦合。</span><br><span class="line"></span><br><span class="line">如何解决：通过调用者调用接受者执行命令，顺序：调用者→接受者→命令。</span><br><span class="line"></span><br><span class="line">关键代码：定义三个角色：1、received 真正的命令执行对象 2、Command 3、invoker 使用命令对象的入口</span><br><span class="line"></span><br><span class="line">应用实例：struts 1 中的 action 核心控制器 ActionServlet 只有一个，相当于 Invoker，而模型层的类会随着不同的应用有不同的模型类，相当于具体的 Command。</span><br><span class="line"></span><br><span class="line">优点： 1、降低了系统耦合度。 2、新的命令可以很容易添加到系统中去。</span><br><span class="line"></span><br><span class="line">缺点：使用命令模式可能会导致某些系统有过多的具体命令类。</span><br><span class="line"></span><br><span class="line">使用场景：认为是命令的地方都可以使用命令模式，比如： 1、GUI 中每一个按钮都是一条命令。 2、模拟 CMD。</span><br><span class="line"></span><br><span class="line">注意事项：系统需要支持命令的撤销(Undo)操作和恢复(Redo)操作，也可以考虑使用命令模式，见命令模式的扩展。</span><br></pre></td></tr></table></figure>





</li>
</ol>
<ol start="2">
<li><p>Hystrix对访问耗时超过设置阈值的请求采用自动超时的策略。该策略对所有的命令都有效。（如果是信号量隔离方式，则此特性失效），超时的阈值可以通过命令配置进行自定义。</p>
</li>
<li><p>为每个服务提供者维护一个线程池（信号量），当线程池（信号量）被占满时，对于该服务提供者的请求将会被直接拒绝（快速失败，走回滚）而不是排队等待，减少系统等待资源。</p>
</li>
<li><p>针对请求服务提供者划分出成功、失效、超时和线程池被占满等情况。</p>
</li>
<li><p>断路器将在请求服务提供者失败次数超过一定阈值后手动或自动切断服务一段时间。</p>
</li>
<li><p>当请求服务提供者出现服务拒绝、超时和 短路（多个服务提供者依次顺序请求，前面的服务提供者请求失败，后面的请求将不再发出）等情况，执行器fallback方法，服务降级。</p>
</li>
<li><p>提供近乎实时的监控和配置变更服务。</p>
</li>
</ol>
<h3 id="hystrix实现流程"><a href="#hystrix实现流程" class="headerlink" title="hystrix实现流程"></a>hystrix实现流程</h3><ol>
<li><p>构建HystrixCommand或者HystrixObservableCommand对象，用于封装请求，并在构造方法配置请求被执行需要的参数。</p>
</li>
<li><p>执行命令，Hystrix提供了4种执行命令的方法。</p>
</li>
<li><p>检查是否有相同命令执行的缓存，若启用了缓存，且缓存可用，直接使用缓存响应请求。Hystrix支持请求缓存，但需要用户自定义启动。</p>
</li>
<li><p>检查断路器是否打开，如果打开走 第8步。</p>
</li>
<li><p>检查线程池或者信号量是否被消耗完，如果已满，走第8步。</p>
</li>
<li><p>调用HystrixCommand的run 或者 HystrixObservableCommand的construct 执行被封装的调用逻辑，如果执行失败或超时，走第8步。</p>
</li>
<li><p>计算链路的健康情况</p>
</li>
<li><p>在命令执行失败时获取fallback逻辑。</p>
</li>
<li><p>返回响应。</p>
<blockquote>
<p>《断路器整体流程》<img src="/2020/08/03/Hystrix%E5%8E%9F%E7%90%86%E5%8F%8A%E4%BD%BF%E7%94%A8/%E6%96%AD%E8%B7%AF%E5%99%A8%E6%95%B4%E4%BD%93%E6%B5%81%E7%A8%8B.png" alt="断路器整体流程"></p>
</blockquote>
</li>
</ol>
<h2 id="4-源码"><a href="#4-源码" class="headerlink" title="4 源码"></a>4 源码</h2><p>debug时，注意上面类名的变化。</p>
<h3 id="包裹请求"><a href="#包裹请求" class="headerlink" title="包裹请求"></a>包裹请求</h3><p>@HystrixCommand，用此注解来包装需要保护的远程调用方法。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br></pre></td><td class="code"><pre><span class="line">public @interface HystrixCommand &#123;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The <span class="built_in">command</span> group key is used <span class="keyword">for</span> grouping together commands such as <span class="keyword">for</span> reporting,</span><br><span class="line">     * alerting, dashboards or team/library ownership.</span><br><span class="line">     * &lt;p/&gt;</span><br><span class="line">     * default =&gt; the runtime class name of annotated method</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> group key</span><br><span class="line">     */</span><br><span class="line">     命令分组键：被此注解修饰的命令被归为一组，默认组名：类名。用于报告，预警，面板展示</span><br><span class="line">    String groupKey() default <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Hystrix <span class="built_in">command</span> key.</span><br><span class="line">     * &lt;p/&gt;</span><br><span class="line">     * default =&gt; the name of annotated method. <span class="keyword">for</span> example:</span><br><span class="line">     * &lt;code&gt;</span><br><span class="line">     *     ...</span><br><span class="line">     *     @HystrixCommand</span><br><span class="line">     *     public User getUserById(...)</span><br><span class="line">     *     ...</span><br><span class="line">     *     the <span class="built_in">command</span> name will be: <span class="string">'getUserById'</span></span><br><span class="line">     * &lt;/code&gt;</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> <span class="built_in">command</span> key</span><br><span class="line">     */</span><br><span class="line">     命令键：默认为注解的方法名，用于区分不同的方法。</span><br><span class="line">    String commandKey() default <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * The thread-pool key is used to represent a</span><br><span class="line">     * HystrixThreadPool <span class="keyword">for</span> monitoring, metrics publishing, caching and other such uses.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> thread pool key</span><br><span class="line">     */</span><br><span class="line">     线程池键，用来指定执行命令的 hystrixThreadPool</span><br><span class="line">    String threadPoolKey() default <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies a method to process fallback logic.</span><br><span class="line">     * A fallback method should be defined <span class="keyword">in</span> the same class <span class="built_in">where</span> is HystrixCommand.</span><br><span class="line">     * Also a fallback method should have same signature to a method <span class="built_in">which</span> was invoked as hystrix <span class="built_in">command</span>.</span><br><span class="line">     * <span class="keyword">for</span> example:</span><br><span class="line">     * &lt;code&gt;</span><br><span class="line">     *      @HystrixCommand(fallbackMethod = <span class="string">"getByIdFallback"</span>)</span><br><span class="line">     *      public String getById(String id) &#123;...&#125;</span><br><span class="line">     *</span><br><span class="line">     *      private String getByIdFallback(String id) &#123;...&#125;</span><br><span class="line">     * &lt;/code&gt;</span><br><span class="line">     * Also a fallback method can be annotated with &#123;@link HystrixCommand&#125;</span><br><span class="line">     * &lt;p/&gt;</span><br><span class="line">     * default =&gt; see &#123;@link com.netflix.hystrix.contrib.javanica.command.GenericCommand<span class="comment">#getFallback()&#125;</span></span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> method name</span><br><span class="line">     */</span><br><span class="line">     回调方法名</span><br><span class="line">    String fallbackMethod() default <span class="string">""</span>;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies <span class="built_in">command</span> properties.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> <span class="built_in">command</span> properties</span><br><span class="line">     */</span><br><span class="line">     自定义命令相关配置。我们前面讲过有例子</span><br><span class="line">    HystrixProperty[] commandProperties() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies thread pool properties.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> thread pool properties</span><br><span class="line">     */</span><br><span class="line">     自定义线程池相关配置，</span><br><span class="line">    HystrixProperty[] threadPoolProperties() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Defines exceptions <span class="built_in">which</span> should be ignored.</span><br><span class="line">     * Optionally these can be wrapped <span class="keyword">in</span> HystrixRuntimeException <span class="keyword">if</span> raiseHystrixExceptions contains RUNTIME_EXCEPTION.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> exceptions to ignore</span><br><span class="line">     */</span><br><span class="line">     自定义忽略的异常</span><br><span class="line">    Class&lt;? extends Throwable&gt;[] ignoreExceptions() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies the mode that should be used to execute hystrix observable <span class="built_in">command</span>.</span><br><span class="line">     * For more information see &#123;@link ObservableExecutionMode&#125;.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> observable execution mode</span><br><span class="line">     */</span><br><span class="line">    ObservableExecutionMode observableExecutionMode() default ObservableExecutionMode.EAGER;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * When includes RUNTIME_EXCEPTION, any exceptions that are not ignored are wrapped <span class="keyword">in</span> HystrixRuntimeException.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> exceptions to wrap</span><br><span class="line">     */</span><br><span class="line">    HystrixException[] raiseHystrixExceptions() default &#123;&#125;;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Specifies default fallback method <span class="keyword">for</span> the <span class="built_in">command</span>. If both &#123;@link <span class="comment">#fallbackMethod&#125; and &#123;@link #defaultFallback&#125;</span></span><br><span class="line">     * methods are specified <span class="keyword">then</span> specific one is used.</span><br><span class="line">     * note: default fallback method cannot have parameters, <span class="built_in">return</span> <span class="built_in">type</span> should be compatible with <span class="built_in">command</span> <span class="built_in">return</span> <span class="built_in">type</span>.</span><br><span class="line">     *</span><br><span class="line">     * @<span class="built_in">return</span> the name of default fallback method</span><br><span class="line">     */</span><br><span class="line">    String defaultFallback() default <span class="string">""</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>上面的配置，我们大部分情况仅需要关注fallbackMethod，看注释中关于fallback方法的说明，如果需要对线程池和和命令有特殊要求，可进行额外配置，其实99%不需要配置。</p>
<p>HystrixCommandAspect切面</p>
<p>被注解@HystrixCommand修饰的方法，会被HystrixCommand包装执行，通过切面来实现。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.hystrix.contrib.javanica.aop.aspectj.HystrixCommandAspect</span><br><span class="line"></span><br><span class="line">定义切面</span><br><span class="line">@Around(<span class="string">"hystrixCommandAnnotationPointcut() || hystrixCollapserAnnotationPointcut()"</span>)</span><br><span class="line">    public Object methodsAnnotatedWithHystrixCommand(final ProceedingJoinPoint joinPoint) throws Throwable &#123;</span><br><span class="line">    </span><br><span class="line">主要地方：</span><br><span class="line">备注：</span><br><span class="line">（</span><br><span class="line">@Pointcut(<span class="string">"@annotation(com.netflix.hystrix.contrib.javanica.annotation.HystrixCommand)"</span>)</span><br><span class="line"></span><br><span class="line">    public void <span class="function"><span class="title">hystrixCommandAnnotationPointcut</span></span>() &#123;</span><br><span class="line">    &#125;</span><br><span class="line"> ）   </span><br><span class="line">    </span><br><span class="line">此方法主要：构建了MetaHolder（请求必要的信息）,在此方法第一行（Method method = getMethodFromTarget(joinPoint);）打断点。 </span><br><span class="line">鼠标放到joinPoint上面看内容：execution(ResponseResult com.online.taxi.driver.service.impl.RestTemplateRequestServiceImpl.smsSend(SmsSendRequest))</span><br><span class="line"></span><br><span class="line">鼠标放上去，查看metaHolder</span><br><span class="line">观察hystrixCommand。</span><br><span class="line"></span><br><span class="line">构建MetaHolder</span><br><span class="line">根据MetaHolder构建合适的HystrixCommand</span><br><span class="line">委托CommandExecutor执行HystrixCommand</span><br><span class="line">得到结果</span><br><span class="line"></span><br><span class="line">此方法中：</span><br><span class="line">Object result;</span><br><span class="line">        try &#123;</span><br><span class="line">            <span class="keyword">if</span> (!metaHolder.isObservable()) &#123;</span><br><span class="line">                result = CommandExecutor.execute(invokable, executionType, metaHolder);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                result = executeObservable(invokable, executionType, metaHolder);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; catch (HystrixBadRequestException e) &#123;</span><br><span class="line">            throw e.getCause();</span><br><span class="line">        &#125; catch (HystrixRuntimeException e) &#123;</span><br><span class="line">            throw hystrixRuntimeExceptionToThrowable(metaHolder, e);</span><br><span class="line">        &#125;</span><br><span class="line">此处判断是用HystrixCommand还是HystrixObservableCommand，执行HystrixCommand命令执行。</span><br><span class="line">HystrixCommand：同步，异步执行。</span><br><span class="line">HystrixObservableCommand: 异步回调执行（响应式）。</span><br></pre></td></tr></table></figure>



<p>MetaHolder 持有用于构建HystrixCommand和与被包装方法相关的必要信息，如被注解的方法，失败回滚执行的方法等</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.hystrix.contrib.javanica.command.MetaHolder</span><br><span class="line"></span><br><span class="line">    private final HystrixCollapser hystrixCollapser;</span><br><span class="line">    private final HystrixCommand hystrixCommand;</span><br><span class="line">    private final DefaultProperties defaultProperties;</span><br><span class="line"></span><br><span class="line">    private final Method method;被注解的方法。</span><br><span class="line">    private final Method cacheKeyMethod;</span><br><span class="line">    private final Method ajcMethod;</span><br><span class="line">    private final Method fallbackMethod;失败回滚执行的方法。</span><br><span class="line">    private final Object obj;</span><br><span class="line">    private final Object proxyObj;</span><br><span class="line">    private final Object[] args;</span><br><span class="line">    private final Closure closure;</span><br><span class="line">    private final String defaultGroupKey;默认的group键</span><br><span class="line">    private final String defaultCommandKey;默认的命令键</span><br><span class="line">    private final String defaultCollapserKey;合并请求键</span><br><span class="line">    private final String defaultThreadPoolKey;线程池 键</span><br><span class="line">    private final ExecutionType executionType;执行类型</span><br><span class="line">    private final boolean extendedFallback;</span><br><span class="line">    private final ExecutionType collapserExecutionType;</span><br><span class="line">    private final ExecutionType fallbackExecutionType;</span><br><span class="line">    private final boolean fallback;</span><br><span class="line">    private boolean extendedParentFallback;</span><br><span class="line">    private final boolean defaultFallback;</span><br><span class="line">    private final JoinPoint joinPoint;</span><br><span class="line">    private final boolean observable;</span><br><span class="line">    private final ObservableExecutionMode observableExecutionMode;</span><br></pre></td></tr></table></figure>



<p>创建HystrixCommand方法如下</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.hystrix.contrib.javanica.command.HystrixCommandFactory</span><br><span class="line"></span><br><span class="line">    public HystrixInvokable create(MetaHolder metaHolder) &#123;</span><br><span class="line">        HystrixInvokable executable;</span><br><span class="line">        <span class="keyword">if</span> (metaHolder.isCollapserAnnotationPresent()) &#123;</span><br><span class="line">            executable = new CommandCollapser(metaHolder);</span><br><span class="line">            根据metaHolder.isObservable()来判断，是生成HystrixCommand还是HystrixObservableCommand。</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (metaHolder.isObservable()) &#123;</span><br><span class="line">            executable = new GenericObservableCommand(HystrixCommandBuilderFactory.getInstance().create(metaHolder));</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            executable = new GenericCommand(HystrixCommandBuilderFactory.getInstance().create(metaHolder));</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">return</span> executable;</span><br><span class="line">    &#125;</span><br><span class="line"> </span><br><span class="line"> 点击GenericObservableCommand（异步回调执行，也就是响应式）和GenericCommand（同步，异步执行）进去，查看父类发现HystrixObservableCommand和HystrixCommand。</span><br></pre></td></tr></table></figure>



<p>ExecutionType</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">/**</span><br><span class="line">     * Used <span class="keyword">for</span> asynchronous execution of <span class="built_in">command</span>.</span><br><span class="line">     */</span><br><span class="line">    ASYNCHRONOUS,异步</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Used <span class="keyword">for</span> synchronous execution of <span class="built_in">command</span>.</span><br><span class="line">     */</span><br><span class="line">    SYNCHRONOUS,同步</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Reactive execution (asynchronous callback).</span><br><span class="line">     */</span><br><span class="line">    OBSERVABLE;异步回调</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * Gets execution <span class="built_in">type</span> <span class="keyword">for</span> specified class <span class="built_in">type</span>.</span><br><span class="line">     * @param <span class="built_in">type</span> the <span class="built_in">type</span></span><br><span class="line">     * @<span class="built_in">return</span> the execution <span class="built_in">type</span> &#123;@link ExecutionType&#125;</span><br><span class="line">     */</span><br><span class="line">    public static ExecutionType getExecutionType(Class&lt;?&gt; <span class="built_in">type</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (Future.class.isAssignableFrom(<span class="built_in">type</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> ExecutionType.ASYNCHRONOUS;</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Observable.class.isAssignableFrom(<span class="built_in">type</span>)) &#123;</span><br><span class="line">            <span class="built_in">return</span> ExecutionType.OBSERVABLE;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="built_in">return</span> ExecutionType.SYNCHRONOUS;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">根据被包装方法的返回值类型觉得命令执行的ExecutionType，从而（通过上面代码块中的一步）决定构建HystrixCommand   还是 HystrixObservableCommand。 </span><br><span class="line">方法的返回值为Future：异步执行，rx类型：异步回调，其他类型：同步执行。</span><br><span class="line"></span><br><span class="line">@HystrixCommand</span><br><span class="line">public Future&lt;T&gt; <span class="function"><span class="title">find</span></span>()&#123;&#125;</span><br></pre></td></tr></table></figure>

<p>debug到：</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">HystrixCommandAspect类中。</span><br><span class="line">create方法。</span><br><span class="line"></span><br><span class="line">HystrixCommand hystrixCommand = method.getAnnotation(HystrixCommand.class);</span><br><span class="line">            ExecutionType executionType = ExecutionType.getExecutionType(method.getReturnType());</span><br><span class="line">            </span><br><span class="line">可以看到命令是同步还是异步，又方法的返回值决定。</span><br></pre></td></tr></table></figure>





<p>命令模式在此的应用</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">HystrixInvokable是被HystrixCommand标记的接口，继承了它的类，都是可以被执行的HystrixCommand。提供具体方法的为HystrixExecutable。</span><br></pre></td></tr></table></figure>



<p>主要的2个类</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">public abstract class HystrixCommand&lt;R&gt; extends AbstractCommand&lt;R&gt;</span><br><span class="line"></span><br><span class="line">public abstract class HystrixObservableCommand&lt;R&gt; extends AbstractCommand&lt;R&gt;</span><br></pre></td></tr></table></figure>

<p>queue和execute</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">public abstract class HystrixCommand&lt;R&gt; extends AbstractCommand&lt;R&gt;的下面的方法，</span><br><span class="line"> public Future&lt;R&gt; <span class="function"><span class="title">queue</span></span>() &#123;</span><br><span class="line"> </span><br><span class="line"> 回想study-hystrix中queue的说明，异步执行。execute同步执行。</span><br></pre></td></tr></table></figure>



<h3 id="断路器-1"><a href="#断路器-1" class="headerlink" title="断路器"></a>断路器</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">断路器核心接口：</span><br><span class="line">com.netflix.hystrix.HystrixCircuitBreaker</span><br><span class="line"></span><br><span class="line">一个Command key （也就是method）对应一个HystrixCircuitBreaker。</span><br><span class="line"></span><br><span class="line">public boolean allowRequest();//是否允许命令执行</span><br><span class="line"></span><br><span class="line">public boolean isOpen();//断路器是否打开（开关）</span><br><span class="line"></span><br><span class="line">void markSuccess();//在半开状态时，执行成功反馈。将半开转为关闭。</span><br><span class="line"></span><br><span class="line">void markNonSuccess();//在半开状态时，执行失败反馈。将半开转为打开。</span><br><span class="line"></span><br><span class="line">实现类：HystrixCircuitBreakerImpl</span><br><span class="line">@Override</span><br><span class="line">        public boolean <span class="function"><span class="title">allowRequest</span></span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (properties.circuitBreakerForceOpen().get()) &#123;</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (properties.circuitBreakerForceClosed().get()) &#123;</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">if</span> (circuitOpened.get() == -1) &#123;</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (status.get().equals(Status.HALF_OPEN)) &#123;</span><br><span class="line">                    <span class="built_in">return</span> <span class="literal">false</span>;</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="built_in">return</span> isAfterSleepWindow();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">此处有强制打开，强制关闭，可以通过配置更改。</span><br><span class="line"></span><br><span class="line">上面有测试例子（断路器开关强制配置）。</span><br></pre></td></tr></table></figure>



<h3 id="统计命令"><a href="#统计命令" class="headerlink" title="统计命令"></a>统计命令</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">com.netflix.hystrix.HystrixMetrics</span><br><span class="line"></span><br><span class="line">HystrixCommandMetrics是上面的子类</span><br><span class="line">在断路器的isOpen等方法中，均有对HealthCount的数量的计算，来判断断路器状态：</span><br><span class="line">public boolean <span class="function"><span class="title">isOpen</span></span>() &#123;</span><br><span class="line">            <span class="keyword">if</span> (circuitOpen.get()) &#123;</span><br><span class="line">                // <span class="keyword">if</span> we<span class="string">'re open we immediately return true and don'</span>t bother attempting to <span class="string">'close'</span> ourself as that is left to allowSingleTest and a subsequent successful <span class="built_in">test</span> to close</span><br><span class="line">                <span class="built_in">return</span> <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            // we<span class="string">'re closed, so let'</span>s see <span class="keyword">if</span> errors have made us so we should trip the circuit open</span><br><span class="line">            HealthCounts health = metrics.getHealthCounts();</span><br><span class="line"></span><br><span class="line">            // check <span class="keyword">if</span> we are past the statisticalWindowVolumeThreshold</span><br><span class="line">            <span class="keyword">if</span> (health.getTotalRequests() &lt; properties.circuitBreakerRequestVolumeThreshold().get()) &#123;</span><br><span class="line">                // we are not past the minimum volume threshold <span class="keyword">for</span> the statisticalWindow so we<span class="string">'ll return false immediately and not calculate anything</span></span><br><span class="line"><span class="string">                return false;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">            if (health.getErrorPercentage() &lt; properties.circuitBreakerErrorThresholdPercentage().get()) &#123;</span></span><br><span class="line"><span class="string">                return false;</span></span><br><span class="line"><span class="string">            &#125; else &#123;</span></span><br><span class="line"><span class="string">                // our failure rate is too high, trip the circuit</span></span><br><span class="line"><span class="string">                if (circuitOpen.compareAndSet(false, true)) &#123;</span></span><br><span class="line"><span class="string">                    // if the previousValue was false then we want to set the currentTime</span></span><br><span class="line"><span class="string">                    circuitOpenedOrLastTestedTime.set(System.currentTimeMillis());</span></span><br><span class="line"><span class="string">                    return true;</span></span><br><span class="line"><span class="string">                &#125; else &#123;</span></span><br><span class="line"><span class="string">                    // How could previousValue be true? If another thread was going through this code at the same time a race-condition could have</span></span><br><span class="line"><span class="string">                    // caused another thread to set it to true already even though we were in the process of doing the same</span></span><br><span class="line"><span class="string">                    // In this case, we know the circuit is open, so let the other thread set the currentTime and report back that the circuit is open</span></span><br><span class="line"><span class="string">                    return true;</span></span><br><span class="line"><span class="string">                &#125;</span></span><br><span class="line"><span class="string">            &#125;</span></span><br><span class="line"><span class="string">        &#125;</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">统计数据：</span></span><br><span class="line"><span class="string">public static class HealthCounts &#123;</span></span><br><span class="line"><span class="string">        private final long totalCount;执行总数</span></span><br><span class="line"><span class="string">        private final long errorCount;失败数</span></span><br><span class="line"><span class="string">        private final int errorPercentage;失败百分比</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">用滑动窗口的方式统计，一个滑动窗口又划分为几个bucket（滑动窗口时间和bucket成整数倍关系），滑动窗口的移动，以bucket为单位，每个bucket仅统计该时间间隔内的请求数据。，最后将所有窗口中的bucket进行聚合。</span></span><br></pre></td></tr></table></figure>



<p>失败回滚</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">AbstractCommand的方法executeCommandAndObserve的局部变量：handleFallback（final Func1&lt;Throwable, Observable&lt;R&gt;&gt; handleFallback）</span><br><span class="line">如果失败，走失败逻辑。</span><br></pre></td></tr></table></figure>


      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/Spring-Cloud/" rel="tag"># Spring Cloud</a>
          
            <a href="/tags/%E6%A1%86%E6%9E%B6/" rel="tag"># 框架</a>
          
            <a href="/tags/%E5%BE%AE%E6%9C%8D%E5%8A%A1/" rel="tag"># 微服务</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/08/03/%E8%AF%A6%E8%A7%A3TCP-IP%E5%8D%8F%E8%AE%AE/" rel="next" title="详解TCP/IP协议;">
                <i class="fa fa-chevron-left"></i> 详解TCP/IP协议;
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/08/04/Spring%20AOP%E7%9A%84%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" rel="prev" title="Spring AOP的基本使用“">
                Spring AOP的基本使用“ <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/oi.jpg"
                alt="OiPunk" />
            
              <p class="site-author-name" itemprop="name">OiPunk</p>
              <p class="site-description motion-element" itemprop="description">跑到前面那棵小树再休息</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/OiPunk" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:oipunk@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#Hystrix"><span class="nav-number">1.</span> <span class="nav-text">Hystrix</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#1-概念："><span class="nav-number">1.1.</span> <span class="nav-text">1 概念：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#概述"><span class="nav-number">1.1.1.</span> <span class="nav-text">概述</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#舱壁模式"><span class="nav-number">1.1.2.</span> <span class="nav-text">舱壁模式</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#雪崩效应"><span class="nav-number">1.1.3.</span> <span class="nav-text">雪崩效应</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#容错机制"><span class="nav-number">1.1.4.</span> <span class="nav-text">容错机制</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#断路器"><span class="nav-number">1.1.5.</span> <span class="nav-text">断路器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#降级"><span class="nav-number">1.1.6.</span> <span class="nav-text">降级</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix-1"><span class="nav-number">1.1.7.</span> <span class="nav-text">Hystrix</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#2-Hystrix-使用"><span class="nav-number">1.2.</span> <span class="nav-text">2 Hystrix 使用</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#hystrix独立使用脱离spring-cloud"><span class="nav-number">1.2.1.</span> <span class="nav-text">hystrix独立使用脱离spring cloud</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#和restTemplate结合"><span class="nav-number">1.2.2.</span> <span class="nav-text">和restTemplate结合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#和feign结合"><span class="nav-number">1.2.3.</span> <span class="nav-text">和feign结合</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#所有（restTemplate和feign）配置默认值"><span class="nav-number">1.2.4.</span> <span class="nav-text">所有（restTemplate和feign）配置默认值</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#捕获熔断的异常信息"><span class="nav-number">1.2.5.</span> <span class="nav-text">捕获熔断的异常信息</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#禁用feign客户端的hystrix"><span class="nav-number">1.2.6.</span> <span class="nav-text">禁用feign客户端的hystrix</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#断路器开关演示"><span class="nav-number">1.2.7.</span> <span class="nav-text">断路器开关演示</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#熔断强制配置"><span class="nav-number">1.2.8.</span> <span class="nav-text">熔断强制配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#开关例子"><span class="nav-number">1.2.9.</span> <span class="nav-text">开关例子</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#监控"><span class="nav-number">1.2.10.</span> <span class="nav-text">监控</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#可视化"><span class="nav-number">1.2.11.</span> <span class="nav-text">可视化</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#集中可视化"><span class="nav-number">1.2.12.</span> <span class="nav-text">集中可视化</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#3-原理"><span class="nav-number">1.3.</span> <span class="nav-text">3 原理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#隔离策略"><span class="nav-number">1.3.1.</span> <span class="nav-text">隔离策略</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Hystrix实现思路"><span class="nav-number">1.3.2.</span> <span class="nav-text">Hystrix实现思路</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#hystrix实现流程"><span class="nav-number">1.3.3.</span> <span class="nav-text">hystrix实现流程</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#4-源码"><span class="nav-number">1.4.</span> <span class="nav-text">4 源码</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#包裹请求"><span class="nav-number">1.4.1.</span> <span class="nav-text">包裹请求</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#断路器-1"><span class="nav-number">1.4.2.</span> <span class="nav-text">断路器</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#统计命令"><span class="nav-number">1.4.3.</span> <span class="nav-text">统计命令</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">OiPunk</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
