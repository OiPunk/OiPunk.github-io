<!DOCTYPE html>



  


<html class="theme-next gemini use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>
<meta name="theme-color" content="#222">









<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />







<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.4" rel="stylesheet" type="text/css" />


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png?v=5.1.4">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=5.1.4">


  <link rel="mask-icon" href="/images/logo.svg?v=5.1.4" color="#222">





  <meta name="keywords" content="JVM,GC,调优," />










<meta name="description" content="JVM垃圾回收原理及常见调优方式，常用OOM问题排查方法">
<meta property="og:type" content="article">
<meta property="og:title" content="GC原理及JVM调优;">
<meta property="og:url" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/index.html">
<meta property="og:site_name" content="JavaCode">
<meta property="og:description" content="JVM垃圾回收原理及常见调优方式，常用OOM问题排查方法">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201439482.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201402853.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201631482.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201701612.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201758859.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514202139228.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514202209712.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514202311041.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514202408229.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514202909198.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514205704893.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514205752680.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514210723893.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200514215248207.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514211954944.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514211600983.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514214712694.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514212726203.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514213900741.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514213945581.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514214444383.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200514225853468.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514221637508.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514222109594.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514222439096.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514222721561.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514222947737.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514223309422.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514223523536.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514223553121.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514223735412.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514224446760.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514224502994.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514224540674.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514224623029.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514225129294.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/GC%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/GCHeapDump.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525205925292.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525210259678.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525210355804.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525210539634.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525210626011.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525210709897.png">
<meta property="og:image" content="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200525203133244.png">
<meta property="og:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200525201039210.png">
<meta property="article:published_time" content="2020-06-23T12:37:26.000Z">
<meta property="article:modified_time" content="2020-08-23T12:46:24.657Z">
<meta property="article:author" content="OiPunk">
<meta property="article:tag" content="JVM">
<meta property="article:tag" content="GC">
<meta property="article:tag" content="调优">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2020/%E5%8F%AA%E8%A6%81%E5%AD%A6%E4%B8%8D%E6%AD%BB%20%E5%B0%B1%E5%BE%80%E6%AD%BB%E9%87%8C%E5%AD%A6/note/JVM/image/05_GC%20and%20Tuning/image-20200514201439482.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Gemini',
    version: '5.1.4',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":false,"onmobile":false},
    fancybox: true,
    tabs: true,
    motion: {"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    duoshuo: {
      userId: '0',
      author: '作者'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2020/06/23/GC原理及JVM调优/"/>





  <title>GC原理及JVM调优; | JavaCode</title>
  








<meta name="generator" content="Hexo 4.2.1"></head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    
    <a href="https://github.com/OiPunk" target="_blank" rel="noopener" class="github-corner" aria-label="View source on GitHub"><svg width="80" height="80" viewBox="0 0 250 250" style="fill:#151513; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true"><path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path><path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"></path></svg></a><style>.github-corner:hover .octo-arm{animation:octocat-wave 560ms ease-in-out}@keyframes octocat-wave{0%,100%{transform:rotate(0)}20%,60%{transform:rotate(-25deg)}40%,80%{transform:rotate(10deg)}}@media (max-width:500px){.github-corner:hover .octo-arm{animation:none}.github-corner .octo-arm{animation:octocat-wave 560ms ease-in-out}}</style>    
    
    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">JavaCode</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle">Oi!</p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            日志
          </a>
        </li>
      

      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br />
            
            搜索
          </a>
        </li>
      
    </ul>
  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off"
             placeholder="搜索..." spellcheck="false"
             type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal" itemscope itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="http://yoursite.com/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="OiPunk">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/oi.jpg">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="JavaCode">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">GC原理及JVM调优;</h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2020-06-23T20:37:26+08:00">
                2020-06-23
              </time>
            

            

            
          </span>

          

          
            
          

          
          

          
            <span class="post-meta-divider">|</span>
            <span class="page-pv"><i class="fa fa-file-o"></i>
            <span class="busuanzi-value" id="busuanzi_value_page_pv" ></span>
            </span>
          

          

          
              <div class="post-description">
                  JVM垃圾回收原理及常见调优方式，常用OOM问题排查方法
              </div>
          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="GC-及-JVM-Tuning"><a href="#GC-及-JVM-Tuning" class="headerlink" title="GC 及 JVM Tuning"></a>GC 及 JVM Tuning</h1><h3 id="GC的基础知识"><a href="#GC的基础知识" class="headerlink" title="GC的基础知识"></a>GC的基础知识</h3><h4 id="1-什么是垃圾"><a href="#1-什么是垃圾" class="headerlink" title="1.什么是垃圾"></a>1.什么是垃圾</h4><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514201439482.png" alt="image-20200514201439482" style="zoom: 50%;">

<blockquote>
<p>C语言申请内存：malloc free</p>
<p>C++： new delete</p>
<p>c/C++ 手动回收内存，比较精确，开发效率低</p>
<p>Java: new ？</p>
<p>自动内存回收，编程上简单，系统不容易出错，手动释放内存，容易出两种类型的问题：</p>
<ol>
<li>忘记回收</li>
<li>多次回收</li>
</ol>
</blockquote>
<p>没有任何引用指向的一个对象或者多个对象（循环引用）</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514201402853.png" alt="image-20200514201402853" style="zoom:50%;">

<h4 id="2-如何定位垃圾"><a href="#2-如何定位垃圾" class="headerlink" title="2.如何定位垃圾"></a>2.如何定位垃圾</h4><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514201631482.png" alt="image-20200514201631482" style="zoom: 50%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514201701612.png" alt="image-20200514201701612" style="zoom:50%;">

<ol>
<li><p>引用计数（ReferenceCount）</p>
<p>不能解决循环引用，可能都是1</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514201758859.png" alt="image-20200514201758859" style="zoom:50%;">
</li>
<li><p>根可达算法(RootSearching)</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514202139228.png" alt="image-20200514202139228" style="zoom:50%;">

</li>
</ol>
<h4 id="3-常见的垃圾回收算法"><a href="#3-常见的垃圾回收算法" class="headerlink" title="3.常见的垃圾回收算法"></a>3.常见的垃圾回收算法</h4><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514202209712.png" alt="image-20200514202209712" style="zoom:50%;">

<ol>
<li><p>标记清除(mark sweep) - 没用的标记出来，直接清掉，其他不动<br>不适合伊甸区<br>位置不连续，容易产生碎片，效率偏低（两遍扫描：1.找出有用的 2。找出没用的）<br>算法相对简单，存活对象比较多的情况下效率较高</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514202311041.png" alt="image-20200514202311041" style="zoom:67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514202408229.png" alt="image-20200514202408229" style="zoom:67%;">
</li>
<li><p>拷贝算法 (copying) - 有用的拷贝过来<br>适合伊甸区<br>浪费空间<br>移动复制对象，需要调整对象引用<br>适用于存活对象较少的情况，只扫描一次，效率提高</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514202909198.png" alt="image-20200514202909198" style="zoom:67%;">
![image-20200514202929940](GC原理及JVM调优/image-20200514202929940.png)
</li>
<li><p>标记压缩(mark compact) - 有用的聚到一起，没用的清掉，空间是连续的，慢<br>没有碎片，方便对象分配<br>不会产生内存减半<br>需要移动对象，效率偏低（两遍扫描，指针需要调整）</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514205704893.png" alt="image-20200514205704893" style="zoom:67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514205752680.png" alt="image-20200514205752680" style="zoom:67%;">

</li>
</ol>
<h4 id="4-JVM内存分代模型（用于分代垃圾回收算法）"><a href="#4-JVM内存分代模型（用于分代垃圾回收算法）" class="headerlink" title="4.JVM内存分代模型（用于分代垃圾回收算法）"></a>4.JVM内存分代模型（用于分代垃圾回收算法）</h4><ol>
<li><p>部分垃圾回收器使用的模型</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514210723893.png" alt="image-20200514210723893" style="zoom:67%;">
新生代大量复制，少量存活，采用‘复制’算法
老年代存活率高，回收较少，采用‘标记清除’或‘标记压缩’

<blockquote>
<p>除Epsilon ZGC Shenandoah之外的GC都是使用逻辑分代模型</p>
<p>G1是逻辑分代，物理不分代</p>
<p>除此之外不仅逻辑分代，而且物理分代</p>
</blockquote>
</li>
</ol>
<p>   逻辑分代：<br>   <img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200514215248207.png" alt="image-20200514215248207">新生代大量复制，少量存活，采用‘复制’算法<br>   老年代存活率高，回收较少，采用‘标记清除’或‘标记压缩’</p>
<ol start="2">
<li><p>新生代 + 老年代 + 永久代（1.7）Perm Generation/ 元数据区(1.8) Metaspace</p>
<ol>
<li>永久代 元数据 - Class</li>
<li>永久代必须指定大小限制 ，元数据可以设置，也可以不设置，无上限（受限于物理内存）</li>
<li>字符串常量 1.7 - 永久代，1.8 - 堆</li>
<li>MethodArea逻辑概念 - 永久代、元数据</li>
</ol>
</li>
<li><p>新生代 = Eden + 2个suvivor区<br>默认8:1:1</p>
<ol>
<li>YGC回收之后，大多数的对象会被回收，活着的进入s0</li>
<li>再次YGC，活着的对象eden + s0 -&gt; s1</li>
<li>再次YGC，eden + s1 -&gt; s0</li>
<li>年龄足够 -&gt; 老年代 （15 CMS 6）</li>
<li>s区装不下 -&gt; 老年代</li>
</ol>
</li>
<li><p>老年代</p>
<ol>
<li>顽固分子</li>
<li>老年代满了FGC Full GC</li>
</ol>
</li>
<li><p>GC Tuning (Generation)</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514211954944.png" alt="image-20200514211954944" style="zoom:67%;">

<ol>
<li>尽量减少FGC</li>
<li>MinorGC = YGC：年轻代空间耗尽时触发</li>
<li>MajorGC = FullGC：在老年代无法继续分配空间时触发，新生代</li>
<li>-Xms 最小内存</li>
<li>-Xmx 最大内存</li>
</ol>
</li>
<li><p>对象分配过程图</p>
<ol>
<li>首先尝试栈上分配，分配不下，进入伊甸区</li>
<li>1次垃圾回收之后，进入survivor幸存区，来回复制</li>
<li>多次垃圾回收之后，进入old去<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514211600983.png" alt="image-20200514211600983" style="zoom:67%;"><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514214712694.png" alt="image-20200514214712694">



</li>
</ol>
</li>
</ol>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514212726203.png" alt="image-20200514212726203" style="zoom: 80%;">

<ol>
<li>什么情况下，栈上分配（无需人工调整）<ol>
<li>线程私有的小对象</li>
<li>无逃逸：只在某一段代码使用，没有被外部引用所引用<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514213900741.png" alt="image-20200514213900741" style="zoom: 67%;"></li>
<li>支持标量替换：用普通属性代替整个对象</li>
</ol>
</li>
<li>什么情况下，线程本地分配TLAB<ol>
<li>每个线程在eden取1%的空间，分配对象时，优先往这块空间分配</li>
</ol>
</li>
</ol>
<h6 id="何时进入老年代"><a href="#何时进入老年代" class="headerlink" title="何时进入老年代"></a>何时进入老年代</h6><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514213945581.png" alt="image-20200514213945581" style="zoom:67%;">

<ol>
<li>Mark word对象头中，GC的Age是4位，最大15，不能调大</li>
<li>Eden + S1 进入S2，超过S2的50%，年龄最大的放进Old<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514214444383.png" alt="image-20200514214444383" style="zoom: 67%;">

</li>
</ol>
<p><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/%E5%AF%B9%E8%B1%A1%E5%88%86%E9%85%8D%E8%BF%87%E7%A8%8B%E8%AF%A6%E8%A7%A3.png" alt></p>
<ol>
<li>动态年龄：（不重要）<br><a href="https://www.jianshu.com/p/989d3b06a49d" target="_blank" rel="noopener">https://www.jianshu.com/p/989d3b06a49d</a></li>
<li>分配担保：（不重要）<br>YGC期间 survivor区空间不够了 空间担保直接进入老年代<br>参考：<a href="https://cloud.tencent.com/developer/article/1082730" target="_blank" rel="noopener">https://cloud.tencent.com/developer/article/1082730</a></li>
</ol>
<h4 id="5-常见的垃圾回收器"><a href="#5-常见的垃圾回收器" class="headerlink" title="5.常见的垃圾回收器"></a>5.常见的垃圾回收器</h4><p><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200514225853468.png" alt="image-20200514225853468"></p>
<p>JDK诞生 Serial(单线程)第一个诞生 提高效率，诞生了PS，为了配合CMS，诞生了PN，CMS是1.4版本后期引入，CMS是里程碑式的GC，它开启了并发回收的过程，但是CMS毛病较多，因此目前任何一个JDK版本默认是CMS<br>并发垃圾回收是因为无法忍受STW</p>
<p>常见组合：这些逻辑上，物理上都分代<br><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514221637508.png" alt="image-20200514221637508" style="zoom: 67%;"></p>
<p>G1：只在逻辑上分代</p>
<ol>
<li><p>Serial(单线程) 年轻代 串行回收：回收时，其他线程都停止(STW)<br>safe point：在安全点上，停止<br>单CPU效率最高<br>停顿时间长<br>用的极少</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514222109594.png" alt="image-20200514222109594" style="zoom:67%;">



</li>
</ol>
<ol start="2">
<li><p>SerialOld ：MS或MC算法</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514222439096.png" alt="image-20200514222439096" style="zoom: 50%;">
</li>
<li><p>(默认PS+PO)Parallel Scavenge 年轻代 并行回收，多线程清理垃圾<br>STW, COPY</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514222721561.png" alt="image-20200514222721561" style="zoom:50%;">
</li>
<li><p>(默认)Parallel Old<br>MC</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514222947737.png" alt="image-20200514222947737" style="zoom:50%;">
</li>
<li><p>ParNew 年轻代 配合CMS的并行回收</p>
<p>没有不会产生STW的垃圾回收器<br>增强了PS, 配合CMS</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514223309422.png" alt="image-20200514223309422" style="zoom:50%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514223523536.png" alt="image-20200514223523536" style="zoom:67%;">
</li>
<li><p>CMS</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514223553121.png" alt="image-20200514223553121" style="zoom: 67%;">
CMS是1.4版本后期引入，CMS是里程碑式的GC，它开启了并发回收的过程，但是CMS毛病较多，因此目前任何一个JDK版本默认是CMS

<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514223735412.png" alt="image-20200514223735412" style="zoom: 50%;">
垃圾回收线程和其他线程同时执行
并发垃圾回收是因为无法忍受STW (内存很大的时候)

<ol>
<li>初始标记：STW很短, 只标记根对象<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514224446760.png" alt="image-20200514224446760" style="zoom:50%;"></li>
<li>并发标记：并发标记有引用的对象, 时间最长，和应用程序同时运行<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514224502994.png" alt="image-20200514224502994" style="zoom:50%;"></li>
<li>重新标记：STW很短, 把并发标记时新产生的垃圾取消标记, 重新标记被引用的垃圾对象<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514224540674.png" alt="image-20200514224540674" style="zoom:50%;"></li>
<li>并发清理：还会产生浮动垃圾<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514224623029.png" alt="image-20200514224623029" style="zoom:50%;">

</li>
</ol>
<p>ConcurrentMarkSweep 老年代 并发的， 垃圾回收和应用程序同时运行，降低STW的时间(200ms)<br>CMS问题比较多，所以现在没有一个版本默认是CMS，只能手工指定<br>CMS既然是MarkSweep，就一定会有碎片化的问题，碎片到达一定程度，CMS的老年代分配</p>
<p>对象分配不下的时候，使用SerialOld 进行老年代回收</p>
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200514225129294.png" alt="image-20200514225129294" style="zoom:50%;">

<p>想象一下：<br>PS + PO -&gt; 加内存 换垃圾回收器 -&gt; PN + CMS + SerialOld（几个小时 - 几天的STW）<br>几十个G的内存，单线程回收 -&gt; G1 + FGC 几十个G -&gt; 上T内存的服务器 ZGC<br>算法：三色标记 + Incremental Update</p>
</li>
<li><p>G1(10ms)<br>算法：三色标记 + SATB</p>
</li>
<li><p>ZGC (1ms) PK C++<br>算法：ColoredPointers + LoadBarrier</p>
</li>
<li><p>Shenandoah<br>算法：ColoredPointers + WriteBarrier</p>
</li>
<li><p>Eplison</p>
</li>
<li><p>PS 和 PN区别的延伸阅读：<br>▪<a href="https://docs.oracle.com/en/java/javase/13/gctuning/ergonomics.html" target="_blank" rel="noopener">https://docs.oracle.com/en/java/javase/13/gctuning/ergonomics.html#GUID-3D0BB91E-9BFF-4EBB-B523-14493A860E73</a></p>
</li>
<li><p>垃圾收集器跟内存大小的关系</p>
<ol>
<li>Serial 几十兆</li>
<li>PS 上百兆 - 几个G</li>
<li>CMS - 20G</li>
<li>G1 - 上百G</li>
<li>ZGC - 4T - 16T（JDK13）</li>
</ol>
</li>
</ol>
<p>1.8默认的垃圾回收：PS + ParallelOld</p>
<h3 id="常见垃圾回收器组合参数设定：-1-8"><a href="#常见垃圾回收器组合参数设定：-1-8" class="headerlink" title="常见垃圾回收器组合参数设定：(1.8)"></a>常见垃圾回收器组合参数设定：(1.8)</h3><ul>
<li><p>-XX:+UseSerialGC = Serial New (DefNew) + Serial Old</p>
<ul>
<li>小型程序。默认情况下不会是这种选项，HotSpot会根据计算及配置和JDK版本自动选择收集器</li>
</ul>
</li>
<li><p>-XX:+UseParNewGC = ParNew + SerialOld</p>
<ul>
<li>这个组合已经很少用（在某些版本中已经废弃）</li>
<li><a href="https://stackoverflow.com/questions/34962257/why-remove-support-for-parnewserialold-anddefnewcms-in-the-future" target="_blank" rel="noopener">https://stackoverflow.com/questions/34962257/why-remove-support-for-parnewserialold-anddefnewcms-in-the-future</a></li>
</ul>
</li>
<li><p>-XX:+UseConc<font color="red">(urrent)</font>MarkSweepGC = ParNew + CMS + Serial Old</p>
</li>
<li><p>-XX:+UseParallelGC = Parallel Scavenge + Parallel Old (1.8默认) 【PS + SerialOld】</p>
</li>
<li><p>-XX:+UseParallelOldGC = Parallel Scavenge + Parallel Old</p>
</li>
<li><p>-XX:+UseG1GC = G1</p>
</li>
<li><p>Linux中没找到默认GC的查看方法，而windows中会打印UseParallelGC </p>
<ul>
<li>java +XX:+PrintCommandLineFlags -version</li>
<li>通过GC的日志来分辨</li>
</ul>
</li>
<li><p>Linux下1.8版本默认的垃圾回收器到底是什么？</p>
<ul>
<li>1.8.0_181 默认（看不出来）Copy MarkCompact</li>
<li>1.8.0_222 默认 PS + PO</li>
</ul>
</li>
</ul>
<h3 id="JVM调优第一步，了解JVM常用命令行参数"><a href="#JVM调优第一步，了解JVM常用命令行参数" class="headerlink" title="JVM调优第一步，了解JVM常用命令行参数"></a>JVM调优第一步，了解JVM常用命令行参数</h3><ul>
<li><p>JVM的命令行参数参考：<a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></p>
</li>
<li><p>HotSpot参数分类</p>
<blockquote>
<p>标准： - 开头，所有的HotSpot都支持</p>
<p>非标准：-X 开头，特定版本HotSpot支持特定命令</p>
<p>不稳定：-XX 开头，下个版本可能取消</p>
</blockquote>
<p>java -version</p>
<p>java -X</p>
</li>
</ul>
<p>  试验用程序：</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.LinkedList;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloGC</span> </span>&#123;</span><br><span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span><br><span class="line">    System.out.println(<span class="string">"HelloGC!"</span>);</span><br><span class="line">    List list = <span class="keyword">new</span> LinkedList();</span><br><span class="line">    <span class="keyword">for</span>(;;) &#123;</span><br><span class="line">      <span class="keyword">byte</span>[] b = <span class="keyword">new</span> <span class="keyword">byte</span>[<span class="number">1024</span>*<span class="number">1024</span>];</span><br><span class="line">      list.add(b);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<ol>
<li>区分概念：内存泄漏memory leak，内存溢出out of memory</li>
<li>java -XX:+PrintCommandLineFlags HelloGC</li>
<li>java -Xmn10M -Xms40M -Xmx60M -XX:+PrintCommandLineFlags -XX:+PrintGC  HelloGC<br>PrintGCDetails PrintGCTimeStamps PrintGCCauses</li>
<li>java -XX:+UseConcMarkSweepGC -XX:+PrintCommandLineFlags HelloGC</li>
<li>java -XX:+PrintFlagsInitial 默认参数值</li>
<li>java -XX:+PrintFlagsFinal 最终参数值</li>
<li>java -XX:+PrintFlagsFinal | grep xxx 找到对应的参数</li>
<li>java -XX:+PrintFlagsFinal -version |grep GC</li>
</ol>
<h3 id="PS-GC日志详解"><a href="#PS-GC日志详解" class="headerlink" title="PS GC日志详解"></a>PS GC日志详解</h3><p>每种垃圾回收器的日志格式是不同的！</p>
<p>PS日志格式</p>
<p><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/GC%E6%97%A5%E5%BF%97%E8%AF%A6%E8%A7%A3.png" alt="GC日志详解"></p>
<p>heap dump部分：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">eden space <span class="number">5632</span>K, <span class="number">94</span>% used [<span class="number">0x00000000ff980000</span>,<span class="number">0x00000000ffeb3e28</span>,<span class="number">0x00000000fff00000</span>)</span><br><span class="line">                            后面的内存地址指的是，起始地址，使用空间结束地址，整体空间结束地址</span><br></pre></td></tr></table></figure>

<p><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/GCHeapDump.png" alt="GCHeapDump"></p>
<p>total = eden + 1个survivor</p>
<h3 id="调优前的基础概念："><a href="#调优前的基础概念：" class="headerlink" title="调优前的基础概念："></a>调优前的基础概念：</h3><ol>
<li>吞吐量：用户代码时间 /（用户代码执行时间 + 垃圾回收时间）</li>
<li>响应时间：STW越短，响应时间越好</li>
</ol>
<p>所谓调优，首先确定，追求啥？吞吐量优先，还是响应时间优先？还是在满足一定的响应时间的情况下，要求达到多大的吞吐量…</p>
<p>问题：</p>
<p>科学计算，吞吐量。数据挖掘，thrput。吞吐量优先的一般：（PS + PO）</p>
<p>响应时间：网站 GUI API （1.8 G1）</p>
<h3 id="什么是调优？"><a href="#什么是调优？" class="headerlink" title="什么是调优？"></a>什么是调优？</h3><ol>
<li>根据需求进行JVM规划和预调优</li>
<li>优化运行JVM运行环境（慢，卡顿）</li>
<li>解决JVM运行过程中出现的各种问题(OOM)</li>
</ol>
<h3 id="调优，从规划开始"><a href="#调优，从规划开始" class="headerlink" title="调优，从规划开始"></a>调优，从规划开始</h3><ul>
<li><p>调优，从业务场景开始，没有业务场景的调优都是耍流氓</p>
</li>
<li><p>无监控（压力测试，能看到结果），不调优</p>
</li>
<li><p>步骤：</p>
<ol>
<li>熟悉业务场景（没有最好的垃圾回收器，只有最合适的垃圾回收器）<ol>
<li>响应时间、停顿时间 [CMS G1 ZGC] （需要给用户作响应）</li>
<li>吞吐量 = 用户时间 /( 用户时间 + GC时间) [PS]</li>
</ol>
</li>
<li>选择回收器组合</li>
<li>计算内存需求（经验值 1.5G 16G）</li>
<li>选定CPU（越高越好）</li>
<li>设定年代大小、升级年龄</li>
<li>设定日志参数<ol>
<li>-Xloggc:/opt/xxx/logs/xxx-xxx-gc-%t.log -XX:+UseGCLogFileRotation -XX:NumberOfGCLogFiles=5 -XX:GCLogFileSize=20M -XX:+PrintGCDetails -XX:+PrintGCDateStamps -XX:+PrintGCCause</li>
<li>或者每天产生一个日志文件</li>
</ol>
</li>
<li>观察日志情况</li>
</ol>
</li>
<li><p>案例1：垂直电商，最高每日百万订单，处理订单系统需要什么样的服务器配置？</p>
<blockquote>
<p>这个问题比较业余，因为很多不同的服务器配置都能支撑(1.5G 16G)</p>
<p>1小时360000集中时间段， 100个订单/秒，（找一小时内的高峰期，1000订单/秒）</p>
<p>经验值，</p>
<p>非要计算：一个订单产生需要多少内存？512K * 1000 500M内存</p>
<p>专业一点儿问法：要求响应时间100ms</p>
<p>压测！</p>
</blockquote>
</li>
<li><p>案例2：12306遭遇春节大规模抢票应该如何支撑？</p>
<blockquote>
<p>12306应该是中国并发量最大的秒杀网站：</p>
<p>号称并发量100W最高</p>
<p>CDN -&gt; LVS -&gt; NGINX -&gt; 业务系统 -&gt; 每台机器1W并发（10K问题） 100台机器</p>
<p>普通电商订单 -&gt; 下单 -&gt;订单系统（IO）减库存 -&gt;等待用户付款</p>
<p>12306的一种可能的模型： 下单 -&gt; 减库存 和 订单(redis kafka) 同时异步进行 -&gt;等付款</p>
<p>减库存最后还会把压力压到一台服务器</p>
<p>可以做分布式本地库存 + 单独服务器做库存均衡</p>
<p>大流量的处理方法：分而治之</p>
</blockquote>
</li>
<li><p>怎么得到一个事务会消耗多少内存？</p>
<blockquote>
<ol>
<li><p>弄台机器，看能承受多少TPS？是不是达到目标？扩容或调优，让它达到</p>
</li>
<li><p>用压测来确定</p>
</li>
</ol>
</blockquote>
</li>
</ul>
<h3 id="优化环境"><a href="#优化环境" class="headerlink" title="优化环境"></a>优化环境</h3><ol>
<li>有一个50万PV的资料类网站（从磁盘提取文档到内存）原服务器32位，1.5G<br>的堆，用户反馈网站比较缓慢，因此公司决定升级，新的服务器为64位，16G<br>的堆内存，结果用户反馈卡顿十分严重，反而比以前效率更低了<ol>
<li>为什么原网站慢?<br>很多用户浏览数据，很多数据load到内存，内存不足，频繁GC，STW长，响应时间变慢</li>
<li>为什么会更卡顿？<br>内存越大，FGC时间越长</li>
<li>咋办？<br>PS -&gt; PN + CMS 或者 G1</li>
</ol>
</li>
<li>系统CPU经常100%，如何调优？(面试高频)<br>CPU100%那么一定有线程在占用系统资源，<ol>
<li>找出哪个进程cpu高（top）</li>
<li>该进程中的哪个线程cpu高（top -Hp）</li>
<li>导出该线程的堆栈 (jstack)</li>
<li>查找哪个方法（栈帧）消耗时间 (jstack)</li>
<li>工作线程占比高 | 垃圾回收线程占比高</li>
</ol>
</li>
<li>系统内存飙高，如何查找问题？（面试高频）<ol>
<li>导出堆内存 (jmap)</li>
<li>分析 (jhat jvisualvm mat jprofiler … )</li>
</ol>
</li>
<li>如何监控JVM<ol>
<li>jstat jvisualvm jprofiler arthas top…</li>
</ol>
</li>
</ol>
<h3 id="解决JVM运行中的问题"><a href="#解决JVM运行中的问题" class="headerlink" title="解决JVM运行中的问题"></a>解决JVM运行中的问题</h3><h4 id="一个案例理解常用工具"><a href="#一个案例理解常用工具" class="headerlink" title="一个案例理解常用工具"></a>一个案例理解常用工具</h4><ol>
<li><p>测试代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.mashibing.jvm.gc;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.math.BigDecimal;</span><br><span class="line"><span class="keyword">import</span> java.util.ArrayList;</span><br><span class="line"><span class="keyword">import</span> java.util.Date;</span><br><span class="line"><span class="keyword">import</span> java.util.List;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ScheduledThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.ThreadPoolExecutor;</span><br><span class="line"><span class="keyword">import</span> java.util.concurrent.TimeUnit;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 从数据库中读取信用数据，套用模型，并把结果进行记录和传输</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">T15_FullGC_Problem01</span> </span>&#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CardInfo</span> </span>&#123;</span><br><span class="line">        BigDecimal price = <span class="keyword">new</span> BigDecimal(<span class="number">0.0</span>);</span><br><span class="line">        String name = <span class="string">"张三"</span>;</span><br><span class="line">        <span class="keyword">int</span> age = <span class="number">5</span>;</span><br><span class="line">        Date birthdate = <span class="keyword">new</span> Date();</span><br><span class="line"></span><br><span class="line">        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">m</span><span class="params">()</span> </span>&#123;&#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> ScheduledThreadPoolExecutor executor = <span class="keyword">new</span> ScheduledThreadPoolExecutor(<span class="number">50</span>,</span><br><span class="line">            <span class="keyword">new</span> ThreadPoolExecutor.DiscardOldestPolicy());</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception </span>&#123;</span><br><span class="line">        executor.setMaximumPoolSize(<span class="number">50</span>);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (;;)&#123;</span><br><span class="line">            modelFit();</span><br><span class="line">            Thread.sleep(<span class="number">100</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">modelFit</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;CardInfo&gt; taskList = getAllCardInfo();</span><br><span class="line">        taskList.forEach(info -&gt; &#123;</span><br><span class="line">            <span class="comment">// do something</span></span><br><span class="line">            executor.scheduleWithFixedDelay(() -&gt; &#123;</span><br><span class="line">                <span class="comment">//do sth with info</span></span><br><span class="line">                info.m();</span><br><span class="line"></span><br><span class="line">            &#125;, <span class="number">2</span>, <span class="number">3</span>, TimeUnit.SECONDS);</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> List&lt;CardInfo&gt; <span class="title">getAllCardInfo</span><span class="params">()</span></span>&#123;</span><br><span class="line">        List&lt;CardInfo&gt; taskList = <span class="keyword">new</span> ArrayList&lt;&gt;();</span><br><span class="line"></span><br><span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">100</span>; i++) &#123;</span><br><span class="line">            CardInfo ci = <span class="keyword">new</span> CardInfo();</span><br><span class="line">            taskList.add(ci);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> taskList;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>java -Xms200M -Xmx200M -XX:+PrintGC com.mashibing.jvm.gc.T15_FullGC_Problem01</p>
</li>
<li><p>一般是运维团队首先受到报警信息（CPU Memory）</p>
</li>
<li><p>top命令观察到问题：内存不断增长 CPU占用率居高不下</p>
</li>
<li><p>top -Hp 观察进程中的线程，哪个线程CPU和内存占比高</p>
</li>
<li><p>jps定位具体java进程<br>jstack 定位线程状况，重点关注：WAITING BLOCKED<br>eg.<br>waiting on &lt;0x0000000088ca3310&gt; (a java.lang.Object)<br>假如有一个进程中100个线程，很多线程都在waiting on <xx> ，一定要找到是哪个线程持有这把锁<br>怎么找？搜索jstack dump的信息，找<xx> ，看哪个线程持有这把锁RUNNABLE<br>作业：1：写一个死锁程序，用jstack观察 2 ：写一个程序，一个线程持有锁不释放，其他线程等待</xx></xx></p>
</li>
<li><p>为什么阿里规范里规定，线程的名称（尤其是线程池）都要写有意义的名称<br>怎么样自定义线程池里的线程名称？（自定义ThreadFactory）</p>
</li>
<li><p>jinfo pid </p>
</li>
<li><p>jstat -gc 动态观察gc情况 / 阅读GC日志发现频繁GC / arthas观察 / jconsole/jvisualVM/ Jprofiler（最好用）<br>jstat -gc 4655 500 : 每个500个毫秒打印GC的情况<br>如果面试官问你是怎么定位OOM问题的？如果你回答用图形界面（错误）<br>1：已经上线的系统不用图形界面用什么？（cmdline arthas）<br>2：图形界面到底用在什么地方？测试！测试的时候进行监控！（压测观察）</p>
</li>
<li><p>jmap - histo 4655 | head -20，查找有多少对象产生</p>
</li>
<li><p>jmap -dump:format=b,file=xxx pid ：</p>
<p>线上系统，内存特别大，jmap执行期间会对进程产生很大影响，甚至卡顿（电商不适合）<br>1：设定了参数HeapDump，OOM的时候会自动产生堆转储文件<br>2：<font color="red">很多服务器备份（高可用），停掉这台服务器对其他服务器不影响</font><br>3：在线定位(一般小点儿公司用不到)</p>
</li>
<li><p>java -Xms20M -Xmx20M -XX:+UseParallelGC -XX:+HeapDumpOnOutOfMemoryError com.mashibing.jvm.gc.T15_FullGC_Problem01</p>
</li>
<li><p>使用MAT / jhat /jvisualvm 进行dump文件分析<br> <a href="https://www.cnblogs.com/baihuitestsoftware/articles/6406271.html" target="_blank" rel="noopener">https://www.cnblogs.com/baihuitestsoftware/articles/6406271.html</a><br>jhat -J-mx512M xxx.dump<br><a href="http://192.168.17.11:7000" target="_blank" rel="noopener">http://192.168.17.11:7000</a><br>拉到最后：找到对应链接<br>可以使用OQL查找特定问题对象</p>
</li>
<li><p>找到代码的问题</p>
</li>
</ol>
<h4 id="jconsole远程连接"><a href="#jconsole远程连接" class="headerlink" title="jconsole远程连接"></a>jconsole远程连接</h4><ol>
<li><p>程序启动加入参数：</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">java -Djava.rmi.server.hostname=192.168.17.11 -Dcom.sun.management.jmxremote -Dcom.sun.management.jmxremote.port=11111 -Dcom.sun.management.jmxremote.authenticate=false -Dcom.sun.management.jmxremote.ssl=false XXX</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>如果遭遇 Local host name unknown：XXX的错误，修改/etc/hosts文件，把XXX加入进去</p>
<blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">192.168</span><span class="number">.17</span><span class="number">.11</span> basic localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::<span class="number">1</span>         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>关闭linux防火墙（实战中应该打开对应端口）</p>
<blockquote>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">service iptables stop</span><br><span class="line">chkconfig iptables off #永久关闭</span><br></pre></td></tr></table></figure>
</blockquote>
</li>
<li><p>windows上打开 jconsole远程连接 192.168.17.11:11111</p>
</li>
</ol>
<h4 id="jvisualvm远程连接"><a href="#jvisualvm远程连接" class="headerlink" title="jvisualvm远程连接"></a>jvisualvm远程连接</h4><p> <a href="https://www.cnblogs.com/liugh/p/7620336.html" target="_blank" rel="noopener">https://www.cnblogs.com/liugh/p/7620336.html</a> （简单做法）</p>
<h4 id="jprofiler-收费"><a href="#jprofiler-收费" class="headerlink" title="jprofiler (收费)"></a>jprofiler (收费)</h4><h4 id="arthas在线排查工具"><a href="#arthas在线排查工具" class="headerlink" title="arthas在线排查工具"></a>arthas在线排查工具</h4><ul>
<li>为什么需要在线排查？<br>在生产上我们经常会碰到一些不好排查的问题，例如线程安全问题，用最简单的threaddump或者heapdump不好查到问题原因。为了排查这些问题，有时我们会临时加一些日志，比如在一些关键的函数里打印出入参，然后重新打包发布，如果打了日志还是没找到问题，继续加日志，重新打包发布。对于上线流程复杂而且审核比较严的公司，从改代码到上线需要层层的流转，会大大影响问题排查的进度。 </li>
<li>jvm观察jvm信息</li>
<li>thread定位线程问题</li>
<li>dashboard 观察系统情况</li>
<li>heapdump + jhat分析</li>
<li>jad反编译<br>动态代理生成类的问题定位<br>第三方的类（观察代码）<br>版本问题（确定自己最新提交的版本是不是被使用）</li>
<li>redefine 热替换<br>目前有些限制条件：只能改方法实现（方法已经运行完成），不能改方法名， 不能改属性<br>m() -&gt; mm()</li>
<li>sc  - search class</li>
<li>watch  - watch method</li>
<li>没有包含的功能：jmap</li>
</ul>
<h3 id="GC算法的基础概念"><a href="#GC算法的基础概念" class="headerlink" title="GC算法的基础概念"></a>GC算法的基础概念</h3><ul>
<li>Card Table<br>由于做YGC时，需要扫描整个OLD区，效率非常低，所以JVM设计了CardTable， 如果一个OLD区CardTable中有对象指向Y区，就将它设为Dirty，下次扫描时，只需要扫描Dirty Card<br>在结构上，Card Table用BitMap来实现</li>
</ul>
<h4 id="G1-垃圾优先-停200ms内-逻辑分代-分而治之的思想"><a href="#G1-垃圾优先-停200ms内-逻辑分代-分而治之的思想" class="headerlink" title="G1: 垃圾优先 (停200ms内, 逻辑分代, 分而治之的思想)"></a>G1: 垃圾优先 (停200ms内, 逻辑分代, 分而治之的思想)</h4><img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525205925292.png" alt="image-20200525205925292" style="zoom:67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525210259678.png" alt="image-20200525210259678" style="zoom:67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525210355804.png" alt="image-20200525210355804" style="zoom:80%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525210539634.png" alt="image-20200525210539634" style="zoom: 67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525210626011.png" alt="image-20200525210626011" style="zoom:67%;">
<img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525210709897.png" alt="image-20200525210709897" style="zoom:67%;">

<h4 id="CMS-JDK8是Parallel-JDK9是G1-但是CMS开创了并发回收的先河"><a href="#CMS-JDK8是Parallel-JDK9是G1-但是CMS开创了并发回收的先河" class="headerlink" title="CMS  (JDK8是Parallel, JDK9是G1, 但是CMS开创了并发回收的先河)"></a>CMS  (JDK8是Parallel, JDK9是G1, 但是CMS开创了并发回收的先河)</h4><ol>
<li><p>初始标记: (STW 很短) 通过GCRoot找到根对象</p>
</li>
<li><p>并发标记: (最耗时, 没有stw) 找到所有有引用的对象 和工作线程同时工作. 产生浮动垃圾, 因为工作在改变引用</p>
</li>
<li><p>重新标记: (STW 很短) 并发标记时, 取消标记产生的新垃圾, 标记重新被引用的垃圾对象</p>
</li>
<li><p>并发清理: 清理没有</p>
</li>
</ol>
<p>   <img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/image-20200525203133244.png" alt="image-20200525203133244"></p>
   <img src="/2020/06/23/GC%E5%8E%9F%E7%90%86%E5%8F%8AJVM%E8%B0%83%E4%BC%98/../../../只要学不死 就往死里学/note/JVM/image/05_GC and Tuning/image-20200525201039210.png" alt="image-20200525201039210" style="zoom: 67%;">

<h4 id="CMS的问题"><a href="#CMS的问题" class="headerlink" title="CMS的问题"></a>CMS的问题</h4><ol>
<li><p>Memory Fragmentation  内存碎片化 , 所以尽可能避免FGC</p>
<blockquote>
<p>-XX:+UseCMSCompactAtFullCollection<br>-XX:CMSFullGCsBeforeCompaction 默认为0 指的是经过多少次FGC才进行压缩</p>
</blockquote>
</li>
<li><p>Floating Garbage  浮动垃圾</p>
<blockquote>
<p>Concurrent Mode Failure<br>产生：if the concurrent collector is unable to finish reclaiming the unreachable objects before the tenured generation fills up, or if an allocation cannot be satisfiedwith the available free space blocks in the tenured generation, then theapplication is paused and the collection is completed with all the applicationthreads stopped</p>
<p>解决方案：降低触发CMS的阈值</p>
<p>PromotionFailed</p>
<p>解决方案类似，保持老年代有足够的空间</p>
<p>–XX:CMSInitiatingOccupancyFraction 92% 可以降低这个值，让CMS保持老年代足够的空间</p>
</blockquote>
</li>
</ol>
<h4 id="CMS日志分析"><a href="#CMS日志分析" class="headerlink" title="CMS日志分析"></a>CMS日志分析</h4><p>执行命令：java -Xms20M -Xmx20M -XX:+PrintGCDetails -XX:+UseConcMarkSweepGC com.mashibing.jvm.gc.T15_FullGC_Problem01</p>
<p>[GC (Allocation Failure) [ParNew: 6144K-&gt;640K(6144K), 0.0265885 secs] 6585K-&gt;2770K(19840K), 0.0268035 secs] [Times: user=0.02 sys=0.00, real=0.02 secs] </p>
<blockquote>
<p>ParNew：年轻代收集器</p>
<p>6144-&gt;640：收集前后的对比</p>
<p>（6144）：整个年轻代容量</p>
<p>6585 -&gt; 2770：整个堆的情况</p>
<p>（19840）：整个堆大小</p>
</blockquote>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[GC (CMS Initial Mark) [<span class="number">1</span> CMS-initial-mark: <span class="number">8511</span>K(<span class="number">13696</span>K)] <span class="number">9866</span>K(<span class="number">19840</span>K), <span class="number">0.0040321</span> secs] [Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">	<span class="comment">//8511 (13696) : 老年代使用（最大）</span></span><br><span class="line">	<span class="comment">//9866 (19840) : 整个堆使用（最大）</span></span><br><span class="line">[CMS-concurrent-mark-start]</span><br><span class="line">[CMS-concurrent-mark: <span class="number">0.018</span>/<span class="number">0.018</span> secs] [Times: user=<span class="number">0.01</span> sys=<span class="number">0.00</span>, real=<span class="number">0.02</span> secs] </span><br><span class="line">	<span class="comment">//这里的时间意义不大，因为是并发执行</span></span><br><span class="line">[CMS-concurrent-preclean-start]</span><br><span class="line">[CMS-concurrent-preclean: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">	<span class="comment">//标记Card为Dirty，也称为Card Marking</span></span><br><span class="line">[GC (CMS Final Remark) [YG occupancy: 1597 K (6144 K)][Rescan (parallel) , 0.0008396 secs][weak refs processing, 0.0000138 secs][class unloading, 0.0005404 secs][scrub symbol table, 0.0006169 secs][scrub string table, 0.0004903 secs][1 CMS-remark: 8511K(13696K)] 10108K(19840K), 0.0039567 secs] [Times: user=0.00 sys=0.00, real=0.00 secs] </span><br><span class="line">	<span class="comment">//STW阶段，YG occupancy:年轻代占用及容量</span></span><br><span class="line">	<span class="comment">//[Rescan (parallel)：STW下的存活对象标记</span></span><br><span class="line">	<span class="comment">//weak refs processing: 弱引用处理</span></span><br><span class="line">	<span class="comment">//class unloading: 卸载用不到的class</span></span><br><span class="line">	<span class="comment">//scrub symbol(string) table: </span></span><br><span class="line">		<span class="comment">//cleaning up symbol and string tables which hold class-level metadata and </span></span><br><span class="line">		<span class="comment">//internalized string respectively</span></span><br><span class="line">	<span class="comment">//CMS-remark: 8511K(13696K): 阶段过后的老年代占用及容量</span></span><br><span class="line">	<span class="comment">//10108K(19840K): 阶段过后的堆占用及容量</span></span><br><span class="line"></span><br><span class="line">[CMS-concurrent-sweep-start]</span><br><span class="line">[CMS-concurrent-sweep: <span class="number">0.005</span>/<span class="number">0.005</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">	<span class="comment">//标记已经完成，进行并发清理</span></span><br><span class="line">[CMS-concurrent-reset-start]</span><br><span class="line">[CMS-concurrent-reset: <span class="number">0.000</span>/<span class="number">0.000</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs]</span><br><span class="line">	<span class="comment">//重置内部结构，为下次GC做准备</span></span><br></pre></td></tr></table></figure>



<h3 id="G1"><a href="#G1" class="headerlink" title="G1"></a>G1</h3><ol>
<li>▪<a href="https://www.oracle.com/technical-resources/articles/java/g1gc.html" target="_blank" rel="noopener">https://www.oracle.com/technical-resources/articles/java/g1gc.html</a></li>
</ol>
<h4 id="G1日志详解"><a href="#G1日志详解" class="headerlink" title="G1日志详解"></a>G1日志详解</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[<span class="function">GC <span class="title">pause</span> <span class="params">(G1 Evacuation Pause)</span> <span class="params">(young)</span> <span class="params">(initial-mark)</span>, 0.0015790 secs]</span></span><br><span class="line"><span class="function"><span class="comment">//young -&gt; 年轻代 Evacuation-&gt; 复制存活对象 </span></span></span><br><span class="line"><span class="function"><span class="comment">//initial-mark 混合回收的阶段，这里是YGC混合老年代回收</span></span></span><br><span class="line"><span class="function">   [Parallel Time: 1.5 ms, GC Workers: 1] <span class="comment">//一个GC线程</span></span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Start</span> <span class="params">(ms)</span>:  92635.7]</span></span><br><span class="line"><span class="function">      [Ext Root <span class="title">Scanning</span> <span class="params">(ms)</span>:  1.1]</span></span><br><span class="line"><span class="function">      [Update <span class="title">RS</span> <span class="params">(ms)</span>:  0.0]</span></span><br><span class="line"><span class="function">         [Processed Buffers:  1]</span></span><br><span class="line"><span class="function">      [Scan <span class="title">RS</span> <span class="params">(ms)</span>:  0.0]</span></span><br><span class="line"><span class="function">      [Code Root <span class="title">Scanning</span> <span class="params">(ms)</span>:  0.0]</span></span><br><span class="line"><span class="function">      [Object <span class="title">Copy</span> <span class="params">(ms)</span>:  0.1]</span></span><br><span class="line"><span class="function">      [<span class="title">Termination</span> <span class="params">(ms)</span>:  0.0]</span></span><br><span class="line"><span class="function">         [Termination Attempts:  1]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Other</span> <span class="params">(ms)</span>:  0.0]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">Total</span> <span class="params">(ms)</span>:  1.2]</span></span><br><span class="line"><span class="function">      [GC Worker <span class="title">End</span> <span class="params">(ms)</span>:  92636.9]</span></span><br><span class="line"><span class="function">   [Code Root Fixup: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Code Root Purge: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Clear CT: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Other: 0.1 ms]</span></span><br><span class="line"><span class="function">      [Choose CSet: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Ref Proc: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Ref Enq: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Redirty Cards: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Humongous Register: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Humongous Reclaim: 0.0 ms]</span></span><br><span class="line"><span class="function">      [Free CSet: 0.0 ms]</span></span><br><span class="line"><span class="function">   [Eden: 0.0<span class="title">B</span><span class="params">(<span class="number">1024.0</span>K)</span>-&gt;0.0<span class="title">B</span><span class="params">(<span class="number">1024.0</span>K)</span> Survivors: 0.0B-&gt;0.0B Heap: 18.8<span class="title">M</span><span class="params">(<span class="number">20.0</span>M)</span>-&gt;18.8<span class="title">M</span><span class="params">(<span class="number">20.0</span>M)</span>]</span></span><br><span class="line"><span class="function"> [Times: user</span>=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line"><span class="comment">//以下是混合回收其他阶段</span></span><br><span class="line">[GC concurrent-root-region-scan-start]</span><br><span class="line">[GC concurrent-root-region-scan-end, <span class="number">0.0000078</span> secs]</span><br><span class="line">[GC concurrent-mark-start]</span><br><span class="line"><span class="comment">//无法evacuation，进行FGC</span></span><br><span class="line">[<span class="function">Full <span class="title">GC</span> <span class="params">(Allocation Failure)</span>  18M-&gt;18<span class="title">M</span><span class="params">(<span class="number">20</span>M)</span>, 0.0719656 secs]</span></span><br><span class="line"><span class="function">   [Eden: 0.0<span class="title">B</span><span class="params">(<span class="number">1024.0</span>K)</span>-&gt;0.0<span class="title">B</span><span class="params">(<span class="number">1024.0</span>K)</span> Survivors: 0.0B-&gt;0.0B Heap: 18.8<span class="title">M</span><span class="params">(<span class="number">20.0</span>M)</span>-&gt;18.8<span class="title">M</span><span class="params">(<span class="number">20.0</span>M)</span>], [Metaspace: 38</span></span><br><span class="line"><span class="function">76K-&gt;3876<span class="title">K</span><span class="params">(<span class="number">1056768</span>K)</span>] [Times: user</span>=<span class="number">0.07</span> sys=<span class="number">0.00</span>, real=<span class="number">0.07</span> secs]</span><br></pre></td></tr></table></figure>



<h3 id="案例汇总"><a href="#案例汇总" class="headerlink" title="案例汇总"></a>案例汇总</h3><p>OOM产生的原因多种多样，有些程序未必产生OOM，不断FGC(CPU飙高，但内存回收特别少) （上面案例）</p>
<ol>
<li><p>硬件升级系统反而卡顿的问题（见上）</p>
</li>
<li><p>线程池不当运用产生OOM问题（见上）<br>不断的往List里加对象（实在太LOW）</p>
</li>
<li><p>smile jira问题<br>实际系统不断重启<br>解决问题 加内存 + 更换垃圾回收器 G1<br>真正问题在哪儿？不知道</p>
</li>
<li><p>tomcat http-header-size过大问题（Hector）</p>
</li>
<li><p>lambda表达式导致方法区溢出问题(MethodArea / Perm Metaspace)<br>LambdaGC.java     -XX:MaxMetaspaceSize=9M -XX:+PrintGCDetails</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">"C:\Program Files\Java\jdk1.8.0_181\bin\java.exe"</span> -XX:MaxMetaspaceSize=<span class="number">9</span>M -XX:+PrintGCDetails <span class="string">"-javaagent:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2019.1\lib\idea_rt.jar=49316:C:\Program Files\JetBrains\IntelliJ IDEA Community Edition 2019.1\bin"</span> -Dfile.encoding=UTF-<span class="number">8</span> -classpath <span class="string">"C:\Program Files\Java\jdk1.8.0_181\jre\lib\charsets.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\deploy.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\access-bridge-64.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\cldrdata.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\dnsns.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\jaccess.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\jfxrt.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\localedata.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\nashorn.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunec.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunjce_provider.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunmscapi.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\sunpkcs11.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\ext\zipfs.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\javaws.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jce.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jfr.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jfxswt.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\jsse.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\management-agent.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\plugin.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\resources.jar;C:\Program Files\Java\jdk1.8.0_181\jre\lib\rt.jar;C:\work\ijprojects\JVM\out\production\JVM;C:\work\ijprojects\ObjectSize\out\artifacts\ObjectSize_jar\ObjectSize.jar"</span> com.mashibing.jvm.gc.LambdaGC</span><br><span class="line">[GC (Metadata GC Threshold) [PSYoungGen: <span class="number">11341</span>K-&gt;<span class="number">1880</span>K(<span class="number">38400</span>K)] <span class="number">11341</span>K-&gt;<span class="number">1888</span>K(<span class="number">125952</span>K), <span class="number">0.0022190</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">[<span class="function">Full <span class="title">GC</span> <span class="params">(Metadata GC Threshold)</span> [PSYoungGen: 1880K-&gt;0<span class="title">K</span><span class="params">(<span class="number">38400</span>K)</span>] [ParOldGen: 8K-&gt;1777<span class="title">K</span><span class="params">(<span class="number">35328</span>K)</span>] 1888K-&gt;1777<span class="title">K</span><span class="params">(<span class="number">73728</span>K)</span>, [Metaspace: 8164K-&gt;8164<span class="title">K</span><span class="params">(<span class="number">1056768</span>K)</span>], 0.0100681 secs] [Times: user</span>=<span class="number">0.02</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">[GC (Last ditch collection) [PSYoungGen: <span class="number">0</span>K-&gt;<span class="number">0</span>K(<span class="number">38400</span>K)] <span class="number">1777</span>K-&gt;<span class="number">1777</span>K(<span class="number">73728</span>K), <span class="number">0.0005698</span> secs] [Times: user=<span class="number">0.00</span> sys=<span class="number">0.00</span>, real=<span class="number">0.00</span> secs] </span><br><span class="line">[<span class="function">Full <span class="title">GC</span> <span class="params">(Last ditch collection)</span> [PSYoungGen: 0K-&gt;0<span class="title">K</span><span class="params">(<span class="number">38400</span>K)</span>] [ParOldGen: 1777K-&gt;1629<span class="title">K</span><span class="params">(<span class="number">67584</span>K)</span>] 1777K-&gt;1629<span class="title">K</span><span class="params">(<span class="number">105984</span>K)</span>, [Metaspace: 8164K-&gt;8156<span class="title">K</span><span class="params">(<span class="number">1056768</span>K)</span>], 0.0124299 secs] [Times: user</span>=<span class="number">0.06</span> sys=<span class="number">0.00</span>, real=<span class="number">0.01</span> secs] </span><br><span class="line">java.lang.reflect.InvocationTargetException</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke0(Native Method)</span><br><span class="line">	at sun.reflect.NativeMethodAccessorImpl.invoke(NativeMethodAccessorImpl.java:<span class="number">62</span>)</span><br><span class="line">	at sun.reflect.DelegatingMethodAccessorImpl.invoke(DelegatingMethodAccessorImpl.java:<span class="number">43</span>)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Method.java:<span class="number">498</span>)</span><br><span class="line">	at sun.instrument.InstrumentationImpl.loadClassAndStartAgent(InstrumentationImpl.java:<span class="number">388</span>)</span><br><span class="line">	at sun.instrument.InstrumentationImpl.loadClassAndCallAgentmain(InstrumentationImpl.java:<span class="number">411</span>)</span><br><span class="line">Caused by: java.lang.OutOfMemoryError: Compressed <span class="class"><span class="keyword">class</span> <span class="title">space</span></span></span><br><span class="line"><span class="class">	<span class="title">at</span> <span class="title">sun</span>.<span class="title">misc</span>.<span class="title">Unsafe</span>.<span class="title">defineClass</span>(<span class="title">Native</span> <span class="title">Method</span>)</span></span><br><span class="line">	at sun.reflect.ClassDefiner.defineClass(ClassDefiner.java:63)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator$<span class="number">1</span>.run(MethodAccessorGenerator.java:<span class="number">399</span>)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator$<span class="number">1</span>.run(MethodAccessorGenerator.java:<span class="number">394</span>)</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator.generate(MethodAccessorGenerator.java:<span class="number">393</span>)</span><br><span class="line">	at sun.reflect.MethodAccessorGenerator.generateSerializationConstructor(MethodAccessorGenerator.java:<span class="number">112</span>)</span><br><span class="line">	at sun.reflect.ReflectionFactory.generateConstructor(ReflectionFactory.java:<span class="number">398</span>)</span><br><span class="line">	at sun.reflect.ReflectionFactory.newConstructorForSerialization(ReflectionFactory.java:<span class="number">360</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.getSerializableConstructor(ObjectStreamClass.java:<span class="number">1574</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.access$<span class="number">1500</span>(ObjectStreamClass.java:<span class="number">79</span>)</span><br><span class="line">	at java.io.ObjectStreamClass$<span class="number">3</span>.run(ObjectStreamClass.java:<span class="number">519</span>)</span><br><span class="line">	at java.io.ObjectStreamClass$<span class="number">3</span>.run(ObjectStreamClass.java:<span class="number">494</span>)</span><br><span class="line">	at java.security.AccessController.doPrivileged(Native Method)</span><br><span class="line">	at java.io.ObjectStreamClass.&lt;init&gt;(ObjectStreamClass.java:<span class="number">494</span>)</span><br><span class="line">	at java.io.ObjectStreamClass.lookup(ObjectStreamClass.java:<span class="number">391</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:<span class="number">1134</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.defaultWriteFields(ObjectOutputStream.java:<span class="number">1548</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeSerialData(ObjectOutputStream.java:<span class="number">1509</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeOrdinaryObject(ObjectOutputStream.java:<span class="number">1432</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject0(ObjectOutputStream.java:<span class="number">1178</span>)</span><br><span class="line">	at java.io.ObjectOutputStream.writeObject(ObjectOutputStream.java:<span class="number">348</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeJRMPStub(RMIConnectorServer.java:<span class="number">727</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeStub(RMIConnectorServer.java:<span class="number">719</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.encodeStubInAddress(RMIConnectorServer.java:<span class="number">690</span>)</span><br><span class="line">	at javax.management.remote.rmi.RMIConnectorServer.start(RMIConnectorServer.java:<span class="number">439</span>)</span><br><span class="line">	at sun.management.jmxremote.ConnectorBootstrap.startLocalConnectorServer(ConnectorBootstrap.java:<span class="number">550</span>)</span><br><span class="line">	at sun.management.Agent.startLocalManagementAgent(Agent.java:<span class="number">137</span>)</span><br></pre></td></tr></table></figure>
</li>
<li><p>直接内存溢出问题（少见）<br>《深入理解Java虚拟机》P59，使用Unsafe分配直接内存，或者使用NIO的问题</p>
</li>
<li><p>栈溢出问题<br>-Xss设定太小</p>
</li>
<li><p>比较一下这两段程序的异同，分析哪一个是更优的写法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Object o = <span class="keyword">null</span>;</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">    o = <span class="keyword">new</span> Object();</span><br><span class="line">    <span class="comment">//业务处理</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;<span class="number">100</span>; i++) &#123;</span><br><span class="line">    Object o = <span class="keyword">new</span> Object();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>重写finalize引发频繁GC<br>小米云，HBase同步系统，系统通过nginx访问超时报警，最后排查，C++程序员重写finalize引发频繁GC问题<br>为什么C++程序员会重写finalize？（new delete）<br>finalize耗时比较长（200ms）</p>
</li>
<li><p>如果有一个系统，内存一直消耗不超过10%，但是观察GC日志，发现FGC总是频繁产生，会是什么引起的？<br>System.gc() (这个比较Low)</p>
</li>
<li><p>Distuptor有个可以设置链的长度，如果过大，然后对象大，消费完不主动释放，会溢出 (来自 死物风情)</p>
</li>
<li><p>用jvm都会溢出，mycat用崩过，1.6.5某个临时版本解析sql子查询算法有问题，9个exists的联合sql就导致生成几百万的对象（来自 死物风情）</p>
</li>
<li><p>new 大量线程，会产生 native thread OOM，（low）应该用线程池，<br>解决方案：减少堆空间（太TMlow了）,预留更多内存产生native thread<br>JVM内存占物理内存比例 50% - 80%</p>
</li>
</ol>
<h3 id="GC常用参数"><a href="#GC常用参数" class="headerlink" title="GC常用参数"></a>GC常用参数</h3><ul>
<li>-Xmn -Xms -Xmx -Xss<br>年轻代 最小堆 最大堆 栈空间</li>
<li>-XX:+UseTLAB<br>使用TLAB，默认打开</li>
<li>-XX:+PrintTLAB<br>打印TLAB的使用情况</li>
<li>-XX:TLABSize<br>设置TLAB大小</li>
<li>-XX:+DisableExplictGC<br>System.gc()不管用 ，FGC</li>
<li>-XX:+PrintGC</li>
<li>-XX:+PrintGCDetails</li>
<li>-XX:+PrintHeapAtGC</li>
<li>-XX:+PrintGCTimeStamps</li>
<li>-XX:+PrintGCApplicationConcurrentTime (低)<br>打印应用程序时间</li>
<li>-XX:+PrintGCApplicationStoppedTime （低）<br>打印暂停时长</li>
<li>-XX:+PrintReferenceGC （重要性低）<br>记录回收了多少种不同引用类型的引用</li>
<li>-verbose:class<br>类加载详细过程</li>
<li>-XX:+PrintVMOptions</li>
<li>-XX:+PrintFlagsFinal  -XX:+PrintFlagsInitial<br>必须会用</li>
<li>-Xloggc:opt/log/gc.log</li>
<li>-XX:MaxTenuringThreshold<br>升代年龄，最大值15</li>
<li>锁自旋次数 -XX:PreBlockSpin 热点代码检测参数-XX:CompileThreshold 逃逸分析 标量替换 …<br>这些不建议设置</li>
</ul>
<h3 id="Parallel常用参数"><a href="#Parallel常用参数" class="headerlink" title="Parallel常用参数"></a>Parallel常用参数</h3><ul>
<li>-XX:SurvivorRatio</li>
<li>-XX:PreTenureSizeThreshold<br>大对象到底多大</li>
<li>-XX:MaxTenuringThreshold</li>
<li>-XX:+ParallelGCThreads<br>并行收集器的线程数，同样适用于CMS，一般设为和CPU核数相同</li>
<li>-XX:+UseAdaptiveSizePolicy<br>自动选择各区大小比例</li>
</ul>
<h3 id="CMS常用参数"><a href="#CMS常用参数" class="headerlink" title="CMS常用参数"></a>CMS常用参数</h3><ul>
<li>-XX:+UseConcMarkSweepGC</li>
<li>-XX:ParallelCMSThreads<br>CMS线程数量</li>
<li>-XX:CMSInitiatingOccupancyFraction<br>使用多少比例的老年代后开始CMS收集，默认是68%(近似值)，如果频繁发生SerialOld卡顿，应该调小，（频繁CMS回收）</li>
<li>-XX:+UseCMSCompactAtFullCollection<br>在FGC时进行压缩</li>
<li>-XX:CMSFullGCsBeforeCompaction<br>多少次FGC之后进行压缩</li>
<li>-XX:+CMSClassUnloadingEnabled</li>
<li>-XX:CMSInitiatingPermOccupancyFraction<br>达到什么比例时进行Perm回收</li>
<li>GCTimeRatio<br>设置GC时间占用程序运行时间的百分比</li>
<li>-XX:MaxGCPauseMillis<br>停顿时间，是一个建议时间，GC会尝试用各种手段达到这个时间，比如减小年轻代</li>
</ul>
<h3 id="G1常用参数"><a href="#G1常用参数" class="headerlink" title="G1常用参数"></a>G1常用参数</h3><ul>
<li>-XX:+UseG1GC</li>
<li>-XX:MaxGCPauseMillis<br>建议值，G1会尝试调整Young区的块数来达到这个值</li>
<li>-XX:GCPauseIntervalMillis<br>？GC的间隔时间</li>
<li>-XX:+G1HeapRegionSize<br>分区大小，建议逐渐增大该值，1 2 4 8 16 32。<br>随着size增加，垃圾的存活时间更长，GC间隔更长，但每次GC的时间也会更长<br>ZGC做了改进（动态区块大小）</li>
<li>G1NewSizePercent<br>新生代最小比例，默认为5%</li>
<li>G1MaxNewSizePercent<br>新生代最大比例，默认为60%</li>
<li>GCTimeRatio<br>GC时间建议比例，G1会根据这个值调整堆空间</li>
<li>ConcGCThreads<br>线程数量</li>
<li>InitiatingHeapOccupancyPercent<br>启动G1的堆空间占用比例</li>
</ul>
<h4 id="作业"><a href="#作业" class="headerlink" title="作业"></a>作业</h4><ol>
<li><p>-XX:MaxTenuringThreshold控制的是什么？<br>A: 对象升入老年代的年龄</p>
<pre><code>B: 老年代触发FGC时的内存垃圾比例</code></pre></li>
<li><p>生产环境中，倾向于将最大堆内存和最小堆内存设置为：（为什么？）<br>A: 相同 B：不同</p>
</li>
<li><p>JDK1.8默认的垃圾回收器是：<br>A: ParNew + CMS</p>
<pre><code>B: G1
C: PS + ParallelOld
D: 以上都不是</code></pre></li>
<li><p>什么是响应时间优先？</p>
</li>
<li><p>什么是吞吐量优先？</p>
</li>
<li><p>ParNew和PS的区别是什么？</p>
</li>
<li><p>ParNew和ParallelOld的区别是什么？（年代不同，算法不同）</p>
</li>
<li><p>长时间计算的场景应该选择：A：停顿时间 B: 吞吐量</p>
</li>
<li><p>大规模电商网站应该选择：A：停顿时间 B: 吞吐量</p>
</li>
<li><p>HotSpot的垃圾收集器最常用有哪些？</p>
</li>
<li><p>常见的HotSpot垃圾收集器组合有哪些？</p>
</li>
<li><p>JDK1.7 1.8 1.9的默认垃圾回收器是什么？如何查看？</p>
</li>
<li><p>所谓调优，到底是在调什么？</p>
</li>
<li><p>如果采用PS + ParrallelOld组合，怎么做才能让系统基本不产生FGC</p>
</li>
<li><p>如果采用ParNew + CMS组合，怎样做才能够让系统基本不产生FGC</p>
<p> 1.加大JVM内存</p>
<p> 2.加大Young的比例</p>
<p> 3.提高Y-O的年龄</p>
<p> 4.提高S区比例</p>
<p> 5.避免代码内存泄漏</p>
</li>
<li><p>G1是否分代？G1垃圾回收器会产生FGC吗？</p>
</li>
<li><p>如果G1产生FGC，你应该做什么？</p>
<pre><code>1. 扩内存
2. 提高CPU性能（回收的快，业务逻辑产生对象的速度固定，垃圾回收越快，内存空间越大）
3. 降低MixedGC触发的阈值，让MixedGC提早发生（默认是45%）</code></pre><ol start="18">
<li><p>问：生产环境中能够随随便便的dump吗？<br>小堆影响不大，大堆会有服务暂停或卡顿（加live可以缓解），dump前会有FGC</p>
</li>
<li><p>问：常见的OOM问题有哪些？<br>栈 堆 MethodArea 直接内存</p>
</li>
</ol>
</li>
</ol>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><ol>
<li><a href="https://blogs.oracle.com/jonthecollector/our-collectors" target="_blank" rel="noopener">https://blogs.oracle.com/</a><a href="https://blogs.oracle.com/jonthecollector/our-collectors" target="_blank" rel="noopener">jonthecollector</a><a href="https://blogs.oracle.com/jonthecollector/our-collectors" target="_blank" rel="noopener">/our-collectors</a></li>
<li><a href="https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html" target="_blank" rel="noopener">https://docs.oracle.com/javase/8/docs/technotes/tools/unix/java.html</a></li>
<li><a href="http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp" target="_blank" rel="noopener">http://java.sun.com/javase/technologies/hotspot/vmoptions.jsp</a></li>
<li>JVM调优参考文档：<a href="https://docs.oracle.com/en/java/javase/13/gctuning/introduction-garbage-collection-tuning.html#GUID-8A443184-7E07-4B71-9777-4F12947C8184" target="_blank" rel="noopener">https://docs.oracle.com/en/java/javase/13/gctuning/introduction-garbage-collection-tuning.html#GUID-8A443184-7E07-4B71-9777-4F12947C8184</a> </li>
<li><a href="https://www.cnblogs.com/nxlhero/p/11660854.html" target="_blank" rel="noopener">https://www.cnblogs.com/nxlhero/p/11660854.html</a> 在线排查工具</li>
<li><a href="https://www.jianshu.com/p/507f7e0cc3a3" target="_blank" rel="noopener">https://www.jianshu.com/p/507f7e0cc3a3</a> arthas常用命令</li>
<li>Arthas手册：<ol>
<li>启动arthas java -jar arthas-boot.jar</li>
<li>绑定java进程</li>
<li>dashboard命令观察系统整体情况</li>
<li>help 查看帮助</li>
<li>help xx 查看具体命令帮助</li>
</ol>
</li>
<li>jmap命令参考： <a href="https://www.jianshu.com/p/507f7e0cc3a3" target="_blank" rel="noopener">https://www.jianshu.com/p/507f7e0cc3a3</a> <ol>
<li>jmap -heap pid</li>
<li>jmap -histo pid</li>
<li>jmap -clstats pid</li>
</ol>
</li>
</ol>

      
    </div>
    
    
    

    

    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/JVM/" rel="tag"># JVM</a>
          
            <a href="/tags/GC/" rel="tag"># GC</a>
          
            <a href="/tags/%E8%B0%83%E4%BC%98/" rel="tag"># 调优</a>
          
        </div>
      

      
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2020/06/23/Spring%20Cloud%E7%AE%80%E4%BB%8B-Eureka%E5%92%8CActuator%E5%9F%BA%E6%9C%AC%E4%BD%BF%E7%94%A8/" rel="next" title="Spring Cloud简介-Eureka和Actuator基本使用;">
                <i class="fa fa-chevron-left"></i> Spring Cloud简介-Eureka和Actuator基本使用;
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2020/07/02/%E5%88%86%E5%B8%83%E5%BC%8F%E4%BA%8B%E5%8A%A1%E5%B8%B8%E8%A7%81%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88/" rel="prev" title="分布式事务常见解决方案;">
                分布式事务常见解决方案; <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image"
                src="/images/oi.jpg"
                alt="OiPunk" />
            
              <p class="site-author-name" itemprop="name">OiPunk</p>
              <p class="site-description motion-element" itemprop="description">跑到前面那棵小树再休息</p>
          </div>

          <nav class="site-state motion-element">

            
              <div class="site-state-item site-state-posts">
              
                <a href="/archives/">
              
                  <span class="site-state-item-count">50</span>
                  <span class="site-state-item-name">文章</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-categories">
                <a href="/categories/index.html">
                  <span class="site-state-item-count">2</span>
                  <span class="site-state-item-name">分类</span>
                </a>
              </div>
            

            
              
              
              <div class="site-state-item site-state-tags">
                <a href="/tags/index.html">
                  <span class="site-state-item-count">39</span>
                  <span class="site-state-item-name">标签</span>
                </a>
              </div>
            

          </nav>

          

          
            <div class="links-of-author motion-element">
                
                  <span class="links-of-author-item">
                    <a href="https://github.com/OiPunk" target="_blank" title="GitHub">
                      
                        <i class="fa fa-fw fa-github"></i>GitHub</a>
                  </span>
                
                  <span class="links-of-author-item">
                    <a href="mailto:oipunk@foxmail.com" target="_blank" title="E-Mail">
                      
                        <i class="fa fa-fw fa-envelope"></i>E-Mail</a>
                  </span>
                
            </div>
          

          
          

          
          

          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#GC-及-JVM-Tuning"><span class="nav-number">1.</span> <span class="nav-text">GC 及 JVM Tuning</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#GC的基础知识"><span class="nav-number">1.0.1.</span> <span class="nav-text">GC的基础知识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#1-什么是垃圾"><span class="nav-number">1.0.1.1.</span> <span class="nav-text">1.什么是垃圾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#2-如何定位垃圾"><span class="nav-number">1.0.1.2.</span> <span class="nav-text">2.如何定位垃圾</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#3-常见的垃圾回收算法"><span class="nav-number">1.0.1.3.</span> <span class="nav-text">3.常见的垃圾回收算法</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#4-JVM内存分代模型（用于分代垃圾回收算法）"><span class="nav-number">1.0.1.4.</span> <span class="nav-text">4.JVM内存分代模型（用于分代垃圾回收算法）</span></a><ol class="nav-child"><li class="nav-item nav-level-6"><a class="nav-link" href="#何时进入老年代"><span class="nav-number">1.0.1.4.0.1.</span> <span class="nav-text">何时进入老年代</span></a></li></ol></li></ol></li><li class="nav-item nav-level-4"><a class="nav-link" href="#5-常见的垃圾回收器"><span class="nav-number">1.0.1.5.</span> <span class="nav-text">5.常见的垃圾回收器</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见垃圾回收器组合参数设定：-1-8"><span class="nav-number">1.0.2.</span> <span class="nav-text">常见垃圾回收器组合参数设定：(1.8)</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#JVM调优第一步，了解JVM常用命令行参数"><span class="nav-number">1.0.3.</span> <span class="nav-text">JVM调优第一步，了解JVM常用命令行参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#PS-GC日志详解"><span class="nav-number">1.0.4.</span> <span class="nav-text">PS GC日志详解</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调优前的基础概念："><span class="nav-number">1.0.5.</span> <span class="nav-text">调优前的基础概念：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#什么是调优？"><span class="nav-number">1.0.6.</span> <span class="nav-text">什么是调优？</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#调优，从规划开始"><span class="nav-number">1.0.7.</span> <span class="nav-text">调优，从规划开始</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#优化环境"><span class="nav-number">1.0.8.</span> <span class="nav-text">优化环境</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#解决JVM运行中的问题"><span class="nav-number">1.0.9.</span> <span class="nav-text">解决JVM运行中的问题</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#一个案例理解常用工具"><span class="nav-number">1.0.9.1.</span> <span class="nav-text">一个案例理解常用工具</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jconsole远程连接"><span class="nav-number">1.0.9.2.</span> <span class="nav-text">jconsole远程连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jvisualvm远程连接"><span class="nav-number">1.0.9.3.</span> <span class="nav-text">jvisualvm远程连接</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#jprofiler-收费"><span class="nav-number">1.0.9.4.</span> <span class="nav-text">jprofiler (收费)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#arthas在线排查工具"><span class="nav-number">1.0.9.5.</span> <span class="nav-text">arthas在线排查工具</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC算法的基础概念"><span class="nav-number">1.0.10.</span> <span class="nav-text">GC算法的基础概念</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#G1-垃圾优先-停200ms内-逻辑分代-分而治之的思想"><span class="nav-number">1.0.10.1.</span> <span class="nav-text">G1: 垃圾优先 (停200ms内, 逻辑分代, 分而治之的思想)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMS-JDK8是Parallel-JDK9是G1-但是CMS开创了并发回收的先河"><span class="nav-number">1.0.10.2.</span> <span class="nav-text">CMS  (JDK8是Parallel, JDK9是G1, 但是CMS开创了并发回收的先河)</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMS的问题"><span class="nav-number">1.0.10.3.</span> <span class="nav-text">CMS的问题</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#CMS日志分析"><span class="nav-number">1.0.10.4.</span> <span class="nav-text">CMS日志分析</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#G1"><span class="nav-number">1.0.11.</span> <span class="nav-text">G1</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#G1日志详解"><span class="nav-number">1.0.11.1.</span> <span class="nav-text">G1日志详解</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#案例汇总"><span class="nav-number">1.0.12.</span> <span class="nav-text">案例汇总</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#GC常用参数"><span class="nav-number">1.0.13.</span> <span class="nav-text">GC常用参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Parallel常用参数"><span class="nav-number">1.0.14.</span> <span class="nav-text">Parallel常用参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#CMS常用参数"><span class="nav-number">1.0.15.</span> <span class="nav-text">CMS常用参数</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#G1常用参数"><span class="nav-number">1.0.16.</span> <span class="nav-text">G1常用参数</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#作业"><span class="nav-number">1.0.16.1.</span> <span class="nav-text">作业</span></a></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#参考资料"><span class="nav-number">1.0.17.</span> <span class="nav-text">参考资料</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">OiPunk</span>

  
</div>









        
<div class="busuanzi-count">
  <script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

  
    <span class="site-uv">
      <i class="fa fa-user"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_uv"></span>
      
    </span>
  

  
    <span class="site-pv">
      <i class="fa fa-eye"></i>
      <span class="busuanzi-value" id="busuanzi_value_site_pv"></span>
      
    </span>
  
</div>








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  












  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>
  

  
  
    <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.4"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.4"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.4"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.4"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.4"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.4"></script>



  


  




	





  





  












  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "./public/search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  
  

  

  

  

</body>
</html>
